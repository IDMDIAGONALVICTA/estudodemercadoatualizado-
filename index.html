<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Estudo Mercadol√≥gico + Perfil de Cliente (Aba Isolada)</title>
<style>
#iMapa{display:none;}

  html, body {"margin":0; padding:0; height:100%;}
  .topbar {"display:flex; gap:8px; padding:10px; border-bottom:1px solid #eaeaea; position:sticky; top:0; background:#fff; z-index:9999;"}
  .btn {"border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;"}
  .btn-estudo {"background:#e9f6ef; color:#0b5e3a;"}
  .btn-perfil {"background:#eef2ff; color:#3442c0;"}
  .btn:hover {"filter:brightness(0.98);"}
  .view { height: calc(100vh - 0px); width: 100%; border:0; display:block; }
  #iPerfil { display:none; }
#iPotencial { display:none; }
#iPerfilCompra { display:none; }
</style>
<script>
  function switchToEstudo() {
    document.getElementById('iPerfil').style.display = 'none';
    document.getElementById('iEstudo').style.display = 'block';
    window.scrollTo({top:0, behavior:'smooth'});
  }
  function switchToPerfil() {
    document.getElementById('iEstudo').style.display = 'none';
    document.getElementById('iPerfil').style.display = 'block';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // Injeta barra de abas DENTRO do iframe do Estudo, logo acima do texto alvo
  function injectTabInsideEstudo() {
    try {
      var ifr = document.getElementById('iEstudo');
      var doc = ifr.contentDocument || ifr.contentWindow.document;
      if (!doc) return;
      var targetText = "Endere√ßo Principal para An√°lise (Busca Avan√ßada)";
      var targetEl = null;
      // Procura um elemento cujo textContent contenha o alvo
      var all = doc.querySelectorAll('body *');
      for (var i=0;i<all.length;i++) {
        var el = all[i];
        if (el && el.textContent && el.textContent.indexOf(targetText) !== -1) {
          targetEl = el;
          break;
        }
      }
      // Se achar, injeta a barra imediatamente antes
      if (targetEl) {
        var bar = doc.createElement('div');
        bar.setAttribute('style', 'margin:8px 0 14px 0; display:flex; gap:8px; flex-wrap:wrap;');
        var b2 = doc.createElement('button');
        b2.className = 'btn btn-perfil';
        b2.textContent = 'Perfil de Cliente';
        b2.setAttribute('style','color:#fff !important;');
        b2.onclick = function() { parent.switchToPerfil(); }; // chama o pai
        bar.appendChild(b2);
        targetEl.parentNode.insertBefore(bar, targetEl);
      }
    } catch(e) { console.warn('Falha ao injetar barra no estudo:', e); }
  }

  window.addEventListener('DOMContentLoaded', function(){
    // Injeta quando o iframe terminar de carregar
    var ifr = document.getElementById('iEstudo');
    ifr.addEventListener('load', function(){ setTimeout(injectTabInsideEstudo, 50); setTimeout(injectPOIUploadInsideEstudo, 200); });
  });

  // --- INJE√á√ÉO DO UPLOAD DE PLANILHA PARA "üìç Adicionar Pontos de Interesse" ---
  function injectPOIUploadInsideEstudo() {
    try {
      var ifr = document.getElementById('iEstudo');
      var doc = ifr.contentDocument || ifr.contentWindow.document;
      if (!doc) return;

      // 1) Garante que a biblioteca XLSX (SheetJS) esteja carregada dentro do iframe
      function ensureXLSX(cb) {
        if (doc.defaultView && doc.defaultView.XLSX) { cb(); return; }
        var s = doc.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload = cb;
        doc.head.appendChild(s);
      }

      ensureXLSX(function() {
        // 2) Localiza a se√ß√£o "üìç Adicionar Pontos de Interesse (Busca Avan√ßada)"
        var headers = Array.from(doc.querySelectorAll('h5'));
        var poiHeader = headers.find(h => h.textContent.trim().indexOf('Adicionar Pontos de Interesse') !== -1);
        if (!poiHeader) return;

        // 3) Evita duplica√ß√£o
        if (doc.getElementById('poi-upload-container')) return;

        // 4) Cria bloco de upload usando o mesmo estilo do sistema (com toque laranja do POI)
        var upload = doc.createElement('div');
        upload.id = 'poi-upload-container';
        upload.className = 'upload-area';
        upload.setAttribute('style',
          'border-color: var(--orange-color); background: linear-gradient(135deg, rgba(255, 107, 53, 0.08) 0%, rgba(255, 140, 105, 0.12) 100%); margin-top: 10px;'
        );

        upload.innerHTML = [
          '<div class=\"upload-icon\">üì§</div>',
          '<h6 style=\"color:#FF6B35; font-weight:700; margin-bottom:6px;\">Importar pontos via Planilha (Excel/CSV)</h6>',
          '<p class=\"text-muted\" style=\"margin:0 0 8px 0; font-size:0.85rem;\">',
            'Cabe√ßalhos aceitos: <strong>Latitude</strong>, <strong>Longitude</strong>, <strong>Subt√≠tulo</strong> (ou varia√ß√µes: lat, lng/long, subtitulo).',
          '</p>',
          '<div class=\"d-flex justify-content-center gap-2\" style=\"margin-bottom:8px;\">',
            '<button id=\"poi-upload-btn\" class=\"btn btn-success btn-sm\">Selecionar arquivo</button>',
            '<button id=\"poi-download-model\" class=\"btn btn-warning btn-sm\" title=\"Baixar modelo CSV\">Baixar modelo (.csv)</button>',
          '</div>',
          '<input id=\"poi-excel-file\" type=\"file\" accept=\".xlsx,.xls,.csv\" style=\"display:none\" />',
          '<div id=\"poi-upload-status\" class=\"upload-status-info\" style=\"display:none\"></div>'
        ].join('');

        // 5) Insere o upload LOGO AP√ìS o bloco de bot√µes do POI (mesma se√ß√£o)
        var poiCard = poiHeader.closest('.modern-card') || poiHeader.parentElement;
        var buttonRow = poiCard.querySelector('.text-center');
        if (buttonRow && buttonRow.nextSibling) {
          poiCard.insertBefore(upload, buttonRow.nextSibling);
        } else {
          poiCard.appendChild(upload);
        }

        // 6) Intera√ß√µes / eventos
        var fileInput = doc.getElementById('poi-excel-file');
        var btnSelect = doc.getElementById('poi-upload-btn');
        var btnModel  = doc.getElementById('poi-download-model');
        var statusBox = doc.getElementById('poi-upload-status');

        function setStatus(type, msg) {
          statusBox.className = type === 'error' ? 'upload-status-error' :
                                type === 'success' ? 'upload-status-success' :
                                'upload-status-info';
          statusBox.style.display = 'block';
          statusBox.textContent = msg;
        }

        btnSelect.addEventListener('click', function(){ fileInput.click(); });

        btnModel.addEventListener('click', function(){
          var csv = 'Latitude,Longitude,Subtitulo\\n-3.7319,-38.5267,Ponto exemplo A\\n-3.7350,-38.5200,Ponto exemplo B\\n';
          var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
          var url = (URL || webkitURL).createObjectURL(blob);
          var a = doc.createElement('a');
          a.href = url;
          a.download = 'modelo_pontos.csv';
          doc.body.appendChild(a);
          a.click();
          setTimeout(function(){ (URL || webkitURL).revokeObjectURL(url); a.remove(); }, 100);
        });

        function normalizeKey(k) {
          return (k || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
        }

        function parseRows(rows) {
          var ok = 0, fail = 0;
          rows.forEach(function(r, idx){
            var obj = {};
            Object.keys(r).forEach(function(key){
              obj[normalizeKey(key)] = r[key];
            });

            var lat = r['Latitude'] ?? obj['latitude'] ?? obj['lat'];
            var lng = r['Longitude'] ?? obj['longitude'] ?? obj['long'] ?? obj['lng'] ?? obj['lon'];
            var subt = r['Subtitulo'] ?? obj['subtitulo'] ?? obj['subtitulo*'] ?? obj['subtitulo (opcional)'];
            // Tamb√©m aceita 'subt√≠tulo' com acento
            if (!subt && ('subt√≠tulo' in r)) subt = r['subt√≠tulo'];

            lat = (typeof lat === 'string') ? lat.replace(',', '.') : lat;
            lng = (typeof lng === 'string') ? lng.replace(',', '.') : lng;
            lat = parseFloat(lat); lng = parseFloat(lng);

            if (Number.isFinite(lat) && Number.isFinite(lng)) {
              // Usa a fun√ß√£o existente dentro do iframe para criar o ponto (cor laranja e faixa laranja)
              try {
                if (typeof doc.defaultView.criarPontoInteresse === 'function') {
                  doc.defaultView.criarPontoInteresse(lat, lng, '', (subt || 'Ponto importado'));
                  ok++;
                } else {
                  fail++;
                }
              } catch(e) {
                console.warn('Falha ao criar ponto (linha '+(idx+2)+'):', e);
                fail++;
              }
            } else {
              fail++;
            }
          });

          if (ok > 0 && fail === 0) {
            setStatus('success', '‚úÖ '+ok+' ponto(s) importado(s) com sucesso.');
          } else if (ok > 0) {
            setStatus('info', '‚ö†Ô∏è '+ok+' importado(s), '+fail+' registro(s) ignorado(s) (verifique colunas Latitude/Longitude/Subt√≠tulo).');
          } else {
            setStatus('error', '‚ùå N√£o foi poss√≠vel importar. Confira os cabe√ßalhos e os valores de Latitude/Longitude.');
          }
        }

        function handleFile(file) {
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function(e){
            try {
              var data = e.target.result;
              var wb = null;
              if (file.name.toLowerCase().endsWith('.csv')) {
                // XLSX tamb√©m l√™ CSV diretamente
                wb = doc.defaultView.XLSX.read(data, {type:'array'});
              } else {
                wb = doc.defaultView.XLSX.read(data, {type:'array'});
              }
              var sheet = wb.Sheets[wb.SheetNames[0]];
              
              // L√™ como matriz para identificar corretamente a linha de cabe√ßalhos (mesmo com c√©lulas mescladas/sem nome)
              var matrix = doc.defaultView.XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});
              if (!matrix || !matrix.length) {
                setStatus('error', '‚ùå Planilha vazia.');
                return;
              }
              // Encontra a primeira linha que parece conter cabe√ßalhos (>=2 c√©lulas n√£o vazias)
              var headerRowIndex = matrix.findIndex(r => Array.isArray(r) && r.filter(x => (x||'').toString().trim() !== '').length >= 2);
              if (headerRowIndex === -1) {
                setStatus('error', '‚ùå N√£o encontrei cabe√ßalhos. Use colunas Latitude, Longitude e Subt√≠tulo.');
                return;
              }
              var header = matrix[headerRowIndex].map(h => (h||'').toString());
              function n(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }
              // Mapeia √≠ndices
              var idxLat = header.findIndex(h => ['latitude','lat'].includes(n(h)));
              var idxLng = header.findIndex(h => ['longitude','lng','long','lon'].includes(n(h)));
              var idxSub = header.findIndex(h => ['subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo','subtitulo'].includes(n(h)) || n(h) === 'subtitulo');
              if (idxLat === -1 || idxLng === -1) {
                setStatus('error', '‚ùå Cabe√ßalhos n√£o encontrados. Use colunas Latitude e Longitude (ou lat / lng).');
                return;
              }
              var dataRows = matrix.slice(headerRowIndex+1);
              var rows = dataRows.map(r => {
                var obj = {};
                if (Array.isArray(r)) {
                  obj['Latitude'] = r[idxLat];
                  obj['Longitude'] = r[idxLng];
                  obj['Subtitulo'] = (idxSub >= 0 ? r[idxSub] : '');
                }
                return obj;
              }).filter(o => Object.keys(o).length > 0);
              if (!rows.length) {
                setStatus('error', '‚ùå N√£o h√° dados ap√≥s os cabe√ßalhos.');
                return;
              }
              parseRows(rows);

            } catch(err) {
              console.error('Erro lendo planilha:', err);
              setStatus('error', '‚ùå Erro ao ler o arquivo. Use .xlsx, .xls ou .csv.');
            }
          };
          reader.onerror = function(){ setStatus('error', '‚ùå Falha ao ler o arquivo.'); };
          reader.readAsArrayBuffer(file);
        }

        fileInput.addEventListener('change', function(ev){
          setStatus('info', '‚è≥ Lendo arquivo...');
          handleFile(ev.target.files[0]);
          // reseta para permitir re-selecionar o mesmo arquivo
          ev.target.value = '';
        });

        // Suporte arrastar/soltar dentro do bloco
        upload.addEventListener('dragover', function(ev){ ev.preventDefault(); upload.classList.add('dragover'); });
        upload.addEventListener('dragleave', function(){ upload.classList.remove('dragover'); });
        upload.addEventListener('drop', function(ev){
          ev.preventDefault();
          upload.classList.remove('dragover');
          var file = ev.dataTransfer.files && ev.dataTransfer.files[0];
          if (file) {
            setStatus('info', '‚è≥ Lendo arquivo...');
            handleFile(file);
          }
        });
      });
    } catch(e) { console.warn('Falha ao injetar upload de POI:', e); }
  }

    function switchToMapa(){
        var e = document.getElementById('iEstudo');
        var p = document.getElementById('iPerfil');
        var m = document.getElementById();
        if(e) e.style.display='none';
        if(p) p.style.display='none';
        if(m) m.style.display='block';
        try{ window.scrollTo({top:0, behavior:'smooth'});}catch(_){}
    }
    </script>
<style>/* mapa-calor-btn */
.tab-button[onclick*="switchToMapa"]{visibility:visible;opacity:1;}
</style>
<style id="brand-colors-override">
  :root {
    --brand-1: #00512A;
    --brand-2: #007C27;
    --brand-3: #F0F5CD;
  }

  /* ===== Cores de marca aplicadas ===== */
  /* Abas ativas e bot√µes principais (gradiente verde institucional) */
  .tab-button.active,
  .tab-button[aria-selected="true"],
  .tab-button.active-tab,
  .tab-button.is-active,
  .btn-primary,
  .btn.btn-warning,
  .btn.btn-success,
  .btn.btn-perfil.active,
  #btn-potencial-top,
  #btn-mapa-top {
    background: linear-gradient(90deg, var(--brand-1), var(--brand-2)) !important;
    color: #fff !important;
    border: 0 !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 4px 12px rgba(0,124,39,0.24) !important;
  }

  /* Estado hover/foco das abas/bot√µes */
  .tab-button:hover, .btn:hover, .tab-button:focus, .btn:focus {
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(0,124,39,0.25) !important;
    border-color: var(--brand-2) !important;
  }

  /* Aba padr√£o (n√£o ativa) */
  .tab-button {
    border: 1px solid rgba(0,0,0,0.1);
  }

  /* P√≠lulas, badges e destaques em tom claro */
  .badge, .pill, .kpi-pill, .highlight, .tag, .label-soft {
    background: var(--brand-3) !important;
    color: var(--brand-1) !important;
  }

  /* Barras de progresso e elementos de preenchimento */
  .progress .fill, .progress-bar .fill, .meter > span {
    background: var(--brand-2) !important;
  }

  /* Checkboxes/toggles */
  input[type="checkbox"]:checked,
  input[type="radio"]:checked {
    accent-color: var(--brand-2);
  }
  .switch input:checked + .slider {
    background: var(--brand-2) !important;
  }

  /* Links */
  a, a:visited { color: var(--brand-1); }
  a:hover { color: var(--brand-2); }

  /* Cabe√ßalhos de cards (se existirem) */
  .card .card-header, .card-header {
    border-bottom: 2px solid var(--brand-2) !important;
  }
</style>
<style id="brand-tabs-override">
  /* ===== Paleta de Marca ===== */
  :root {
    --brand-1: #00512A;
    --brand-2: #007C27;
    --brand-3: #F0F5CD;
  }

  /* Abas principais */
  .tab-button {
    border-radius: 8px !important;
    padding: 10px 16px !important;
    border: 1px solid var(--brand-1) !important;
    background: #fff !important;
    color: var(--brand-1) !important;
    font-weight: 600;
    transition: all 0.2s ease-in-out;
  }
  .tab-button:hover {
    background: var(--brand-3) !important;
    color: var(--brand-2) !important;
  }
  .tab-button.active,
  .tab-button[aria-selected="true"],
  .tab-button.is-active {
    background: linear-gradient(90deg, var(--brand-1), var(--brand-2)) !important;
    color: #fff !important;
    border: none !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  /* Bot√µes internos (voltar, etc.) */
  #backPotencialBar .tab-button,
  #mapaCalorTabContent .tab-button {
    background: linear-gradient(90deg, var(--brand-1), var(--brand-2)) !important;
    color: #fff !important;
    border: none !important;
    border-radius: 6px !important;
    padding: 8px 14px !important;
  }

  /* Badges, destaques */
  .badge, .pill, .highlight {
    background: var(--brand-3) !important;
    color: var(--brand-1) !important;
  }
</style>
<style>
  #main-tabbar {
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    padding:12px 16px; position:sticky; top:0; background:#fff; z-index:9999;
    border-bottom:1px solid #eaeaea;
  }
  #main-tabbar .main-tab {
    background:#007C27; color:#FFFFFF; border:0; padding:10px 14px;
    border-radius:10px; font-weight:600; cursor:pointer;
  }
  #main-tabbar .main-tab:hover { filter:brightness(0.98); }
</style>
<style>
/* Oculta quaisquer barras antigas no documento principal */
#aba-interna-concorrentes, #aba-interna-perfil-compra,
#btn-concorrentes-top, #btn-perfil-compra-top,
button#tab-potencial, button#tab-concorrentes,
button.btn-estudo, button.btn-perfil, button.btn-concorrentes, button
</style>
</head>
<body>

<script>
(function(){
  function show(id){
    var ids = ['iEstudo'];
    for (var i=0;i<ids.length;i++){
      var el = document.getElementById(ids[i]);
      if (!el) continue;
      el.style.display = (ids[i] === id) ? 'block' : 'none';
    }
    try { window.scrollTo({top:0, behavior:'smooth'}); } catch(_){}
  }
  var bar = document.getElementById('main-tabbar');
  if (bar){
    var btns = bar.querySelectorAll('button[data-target]');
    for (var i=0;i<btns.length;i++){
      (function(b){ b.onclick=function(){ show(b.getAttribute('data-target')); }; })(btns[i]);
    }
  }
})();
</script>
<!-- Iframe do Estudo (sem alterar o arquivo original) -->
<iframe class="view" id="iEstudo" srcdoc="&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;pt-BR&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;/&gt;
&lt;meta content=&quot;width=device-width, initial-scale=1&quot; name=&quot;viewport&quot;/&gt;
&lt;title&gt;Dashboard An√°lise Mercadol√≥gica - Vers√£o Melhorada&lt;/title&gt;
&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;/&gt;
&lt;link href=&quot;https://unpkg.com/leaflet/dist/leaflet.css&quot; rel=&quot;stylesheet&quot;/&gt;
&lt;style&gt;
  :root {
    --primary-color: #00512A;
    --primary-light: #007C27;
    --primary-dark: #003D20;
    --secondary-color: #2ECC71;
    --accent-color: #F39C12;
    --orange-color: #FF6B35;
    --orange-light: #FF8C69;
    --danger-color: #E74C3C;
    --warning-color: #F1C40F;
    --info-color: #3498DB;
    --purple-color: #8E44AD;
    --purple-light: #A569BD;
    --purple-dark: #6C3483;
    --light-bg: #F0F5CD;
    --white: #FFFFFF;
    --text-dark: #2C3E50;
    --border-color: #E8F5E8;
    --light-green-subtitle: #90EE90;
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.18);
    --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    --shadow-hover: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  }

/*
üõ†Ô∏è SISTEMA DE C√çRCULOS APRIMORADO:
=====================================

‚úÖ PROBLEMAS RESOLVIDOS:
‚Ä¢ C√≠rculos n√£o sumem mais ao trocar para sat√©lite
‚Ä¢ Sistema autom√°tico de detec√ß√£o e recria√ß√£o
‚Ä¢ Prote√ß√£o contra remo√ß√£o acidental dos c√≠rculos
‚Ä¢ C√≠rculos ficam sempre vis√≠veis sobre qualquer camada

üîß CONTROLES DISPON√çVEIS:
‚Ä¢ &quot;üëÅÔ∏è Mostrar/Ocultar Raios&quot; - Alterna visibilidade
‚Ä¢ &quot;üîÑ Restaurar Raios&quot; - For√ßa recria√ß√£o se sumiram
‚Ä¢ &quot;üõ∞Ô∏è Sat√©lite&quot; - Troca para sat√©lite preservando c√≠rculos
‚Ä¢ &quot;üîß Diagn√≥stico&quot; - Verifica status completo do sistema

üöÄ COMO FUNCIONA:
1. C√≠rculos s√£o criados com z-index alto
2. Sistema monitora mudan√ßas de camada
3. Recria automaticamente se detectar remo√ß√£o
4. Protege contra interfer√™ncia de camadas base

EM CASO DE PROBLEMAS:
1. Use o bot√£o &quot;üîÑ Restaurar Raios&quot;
2. Execute o &quot;üîß Diagn√≥stico&quot; para an√°lise
3. Recarregue a p√°gina se necess√°rio (F5)

MELHORIAS T√âCNICAS:
‚Ä¢ C√≠rculos usam 'overlayPane' para ficar sobre camadas base
‚Ä¢ Labels usam 'markerPane' para m√°xima visibilidade  
‚Ä¢ Sistema de detec√ß√£o autom√°tica de problemas
‚Ä¢ Recria√ß√£o inteligente apenas quando necess√°rio
*/

  body {
    background-color: #FFFFFF;
    min-height: 100vh;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-dark);
    overflow-x: hidden;
  }

  .container {
    max-width: 1400px;
  }

  /* Header principal */
  .main-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 25px rgba(0, 81, 42, 0.2);
    text-align: center;
  }

  .main-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }

  .main-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
  }

  /* Cards modernos com glassmorphism */
  .modern-card {
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--glass-border);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }

  .modern-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }

  .modern-card:hover::before {
    left: 100%;
  }

  .modern-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-hover);
    border-color: rgba(255, 255, 255, 0.3);
  }

  /* Bot√µes modernos com gradientes e anima√ß√µes */
  .btn-primary {
    background: var(--gradient-primary);
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }

  .btn-primary:hover::before {
    left: 100%;
  }

  .btn-primary:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
  }

  .btn-success {
    background: var(--gradient-success);
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn-success:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(79, 172, 254, 0.4);
  }

  .btn-warning {
    background: var(--gradient-warning);
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 8px 25px rgba(67, 233, 123, 0.3);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dark);
  }

  .btn-warning:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(67, 233, 123, 0.4);
  }

  .btn-danger {
    background: var(--gradient-secondary);
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn-danger:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(240, 147, 251, 0.4);
  }

  .btn-info {
    background: linear-gradient(135deg, var(--info-color) 0%, #2980B9 100%);
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn-info:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(52, 152, 219, 0.4);
  }

  /* Indicadores do header */
  .status-indicators {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(0, 81, 42, 0.1);
    border: 1px solid var(--border-color);
  }

  .status-item {
    text-align: center;
    padding: 0.5rem;
  }

  .status-item h6 {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
  }

  .status-item p {
    margin: 0;
    font-weight: 500;
    color: var(--text-dark);
    font-size: 0.85rem;
  }

  /* Abas de busca */
  .search-tabs {
    display: flex;
    background: var(--light-bg);
    border-radius: 10px;
    padding: 0.25rem;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
  }

  .search-tab {
    flex: 1;
    background: transparent;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    color: var(--text-dark);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .search-tab.active {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 2px 8px rgba(0, 81, 42, 0.2);
  }

  .search-tab:hover:not(.active) {
    background: rgba(0, 81, 42, 0.1);
  }

  /* Campos de entrada */
  .form-control {
    border-radius: 10px;
    border: 2px solid var(--border-color);
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 81, 42, 0.1);
  }

  .subtitle-input-main {
    background: linear-gradient(135deg, #90EE90 0%, #7ED321 100%) !important;
    border: 2px solid #7ED321 !important;
    color: var(--primary-color) !important;
    font-size: 0.85rem !important;
    font-weight: 600 !important;
    border-radius: 12px !important;
    padding: 0.75rem 1rem !important;
    box-shadow: 0 4px 15px rgba(126, 211, 33, 0.2) !important;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  }

  .subtitle-input-main:focus {
    background: linear-gradient(135deg, #90EE90 0%, #7ED321 100%) !important;
    border-color: #7ED321 !important;
    box-shadow: 0 0 0 0.3rem rgba(126, 211, 33, 0.3) !important;
    transform: scale(1.02) !important;
  }

  .subtitle-input-poi {
    background: linear-gradient(135deg, var(--orange-color) 0%, var(--orange-light) 100%) !important;
    border: 2px solid var(--orange-color) !important;
    color: white !important;
    font-size: 0.85rem !important;
    font-weight: 600 !important;
    border-radius: 12px !important;
    padding: 0.75rem 1rem !important;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2) !important;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  }

  .subtitle-input-poi:focus {
    background: linear-gradient(135deg, var(--orange-color) 0%, var(--orange-light) 100%) !important;
    border-color: var(--orange-color) !important;
    box-shadow: 0 0 0 0.3rem rgba(255, 107, 53, 0.3) !important;
    transform: scale(1.02) !important;
  }

  .subtitle-input-poi::placeholder {
    color: rgba(255, 255, 255, 0.8) !important;
  }

  /* Mapa moderno */
  #map, #demographic-map {
    height: 600px;
    border-radius: 25px;
    box-shadow: var(--shadow-light);
    border: 2px solid var(--glass-border);
    margin-bottom: 1.5rem;
    overflow: hidden;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }

  #map:hover, #demographic-map:hover {
    box-shadow: var(--shadow-hover);
    transform: scale(1.01);
  }

  /* Controles de camadas de mapa modernos */
  .map-layer-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1rem;
    box-shadow: var(--shadow-light);
  }

  .layer-control-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .layer-control-item:hover {
    transform: translateX(5px);
  }

  .layer-control-item input[type=&quot;radio&quot;] {
    margin-right: 0.5rem;
    transform: scale(1.2);
  }

  .layer-control-item label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-dark);
    margin: 0;
    cursor: pointer;
  }

  /* Controles do mapa */
  .map-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .map-controls .btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
  }

  /* Seletores de raio */
  .radius-selector {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .radius-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .radius-btn.active {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  /* Pontos de conveni√™ncia coloridos */
  .convenience-point {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .convenience-point:hover {
    transform: scale(1.5);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
  }

  .convenience-point.hospital { background-color: #E74C3C; }
  .convenience-point.school { background-color: #3498DB; }
  .convenience-point.supermarket { background-color: #2ECC71; }
  .convenience-point.pharmacy { background-color: #9B59B6; }
  .convenience-point.bank { background-color: #F39C12; }
  .convenience-point.restaurant { background-color: #E67E22; }
  .convenience-point.gas-station { background-color: #1ABC9C; }
  .convenience-point.shopping { background-color: #E91E63; }
  .convenience-point.transport { background-color: #607D8B; }
  .convenience-point.park { background-color: #4CAF50; }

  /* Tooltip para pontos de conveni√™ncia */
  .convenience-tooltip {
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-dark);
    box-shadow: var(--shadow-light);
    max-width: 200px;
  }

  .convenience-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .convenience-item {
    display: flex;
    align-items: center;
    background: white;
    padding: 0.75rem;
    border-radius: 10px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .convenience-item:hover {
    border-color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0, 81, 42, 0.1);
  }

  .convenience-item input[type=&quot;checkbox&quot;] {
    margin-right: 0.75rem;
    transform: scale(1.2);
  }

  .convenience-item label {
    margin: 0;
    font-weight: 500;
    cursor: pointer;
    flex: 1;
  }

  /* Tabela de resumo */
  .summary-table {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0, 81, 42, 0.08);
    border: 1px solid var(--border-color);
  }

  .summary-table table {
    margin: 0;
  }

  .summary-table th {
    background: var(--primary-color);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 1rem;
    border: none;
  }

  .summary-table td {
    text-align: center;
    padding: 0.75rem;
    border-color: var(--border-color);
  }

  .summary-table .category-cell {
    text-align: left;
    font-weight: 500;
  }

  /* Badges de quantidade */
  .quantity-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    color: white;
    font-weight: 600;
    font-size: 0.85rem;
    min-width: 35px;
    text-align: center;
    transition: all 0.3s ease;
  }

  .quantity-badge.clickable {
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .quantity-badge.clickable:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }

  .quantity-badge.clickable::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  .quantity-badge.clickable:hover::before {
    left: 100%;
  }

  /* Linhas interativas da tabela */
  .interactive-row {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }

  .interactive-row:hover {
    background-color: rgba(0, 81, 42, 0.05) !important;
    transform: translateX(5px);
  }

  .interactive-row:hover .category-cell {
    font-weight: 600;
    color: var(--primary-color);
  }

  .linha-destacada {
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.2) 0%, rgba(0, 81, 42, 0.1) 100%) !important;
    border-left: 4px solid var(--secondary-color) !important;
    animation: destacarLinha 0.5s ease-out;
  }

  @keyframes destacarLinha {
    0% {
      transform: translateX(-10px);
      opacity: 0.7;
    }
    100% {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Anima√ß√£o de pulso para pontos destacados */
  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.2);
      opacity: 0.7;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .destaque-ponto {
    animation: pulse 1.5s infinite;
  }

  /* Tooltip para tabela interativa */
  .interactive-row::after {
    content: 'üëÜ Clique para destacar no mapa';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    white-space: nowrap;
  }

  .interactive-row:hover::after {
    opacity: 1;
  }

  /* Dados demogr√°ficos */
  .demographic-data {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 5px 20px rgba(0, 81, 42, 0.08);
    border: 1px solid var(--border-color);
  }

  .indicator-card {
    background: var(--light-bg);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  .indicator-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 81, 42, 0.1);
  }

  .indicator-card h6 {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .indicator-card .card-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
  }

  .indicator-card small {
    color: #666;
    font-size: 0.8rem;
  }

  /* An√°lise qualitativa din√¢mica */
  .qualitative-analysis {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 5px 20px rgba(0, 81, 42, 0.08);
    border: 1px solid var(--border-color);
  }

  .qualitative-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: white;
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .qualitative-header h4 {
    margin: 0;
    font-weight: 700;
  }

  .radius-selector-qualitative {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .radius-btn-qualitative {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .radius-btn-qualitative.active {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  /* Cards das cidades com cabe√ß√°rio verde moderno */
  .city-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0, 81, 42, 0.08);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
  }

  .city-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 81, 42, 0.15);
  }

  .city-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: white;
    padding: 1rem;
    text-align: center;
  }

  .city-header h5 {
    margin: 0;
    font-weight: 700;
    font-size: 1.2rem;
  }

  .city-content {
    padding: 1.5rem;
  }

  .city-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-item {
    text-align: center;
    padding: 0.75rem;
    background: var(--light-bg);
    border-radius: 10px;
    border: 1px solid var(--border-color);
  }

  .stat-item h6 {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }

  .stat-item .value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-dark);
  }

  .points-section {
    margin-top: 1rem;
  }

  .points-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .points-card {
    padding: 1rem;
    border-radius: 10px;
    border: 1px solid var(--border-color);
  }

  .points-card.strengths {
    background: #d4edda;
    border-color: #c3e6cb;
  }

  .points-card.concerns {
    background: #f8d7da;
    border-color: #f5c6cb;
  }

  .points-card h6 {
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .points-card.strengths h6 {
    color: #155724;
  }

  .points-card.concerns h6 {
    color: #721c24;
  }

  .points-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .points-list li {
    padding: 0.25rem 0;
    font-size: 0.9rem;
  }

  .points-list li::before {
    margin-right: 0.5rem;
  }

  .points-card.strengths .points-list li::before {
    content: &quot;‚úÖ&quot;;
  }

  .points-card.concerns .points-list li::before {
    content: &quot;‚ö†Ô∏è&quot;;
  }

  /* Se√ß√£o de concentra√ß√£o populacional */
  .population-concentration-section {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 5px 20px rgba(0, 81, 42, 0.08);
    border: 1px solid var(--border-color);
  }

  .population-concentration-header {
    background: linear-gradient(135deg, var(--purple-color) 0%, var(--purple-light) 100%);
    color: white;
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .population-concentration-header h4 {
    margin: 0;
    font-weight: 700;
  }

  .concentration-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .concentration-card {
    background: var(--light-bg);
    border-radius: 10px;
    padding: 1rem;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  .concentration-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(142, 68, 173, 0.1);
  }

  .concentration-card h6 {
    color: var(--purple-color);
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  /* Chart container */
  .chart-container {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    box-shadow: 0 5px 20px rgba(0, 81, 42, 0.08);
    border: 1px solid var(--border-color);
  }

  .chart-container canvas {
    max-height: 400px;
  }

  /* Upload de arquivos */
  .upload-area {
    border: 2px dashed var(--primary-color);
    border-radius: 20px;
    padding: 1.5rem;
    text-align: center;
    background: linear-gradient(135deg, rgba(0, 81, 42, 0.03) 0%, rgba(46, 204, 113, 0.05) 100%);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    max-width: 500px;
    margin: 0 auto 1rem auto;
  }

  .upload-area::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 81, 42, 0.1), transparent);
    transition: left 0.5s;
  }

  .upload-area:hover::before {
    left: 100%;
  }

  .upload-area:hover {
    border-color: var(--secondary-color);
    background: linear-gradient(135deg, rgba(0, 81, 42, 0.08) 0%, rgba(46, 204, 113, 0.12) 100%);
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 25px rgba(0, 81, 42, 0.15);
  }

  .upload-area.dragover {
    border-color: var(--secondary-color);
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.15) 0%, rgba(0, 81, 42, 0.1) 100%);
    transform: scale(1.05);
    box-shadow: 0 12px 30px rgba(46, 204, 113, 0.2);
  }

  .upload-icon {
    font-size: 2.5rem;
    color: var(--primary-color);
    margin-bottom: 0.75rem;
    filter: drop-shadow(0 2px 4px rgba(0, 81, 42, 0.2));
  }

  .upload-area h6 {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .upload-area .text-muted {
    font-size: 0.85rem;
    color: #666 !important;
  }

  #excel-file {
    display: none;
  }

  /* Status de upload */
  .upload-status-success {
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(39, 174, 96, 0.05) 100%);
    border: 1px solid rgba(46, 204, 113, 0.3);
    border-radius: 10px;
    padding: 0.75rem;
    color: #27AE60;
    font-weight: 500;
    animation: slideInUp 0.3s ease-out;
  }

  .upload-status-error {
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.05) 100%);
    border: 1px solid rgba(231, 76, 60, 0.3);
    border-radius: 10px;
    padding: 0.75rem;
    color: #E74C3C;
    font-weight: 500;
    animation: slideInUp 0.3s ease-out;
  }

  .upload-status-info {
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.05) 100%);
    border: 1px solid rgba(52, 152, 219, 0.3);
    border-radius: 10px;
    padding: 0.75rem;
    color: #3498DB;
    font-weight: 500;
    animation: slideInUp 0.3s ease-out;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Estilos para faixas de subt√≠tulo */
  .subtitle-banner {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 5px 12px;
    font-weight: 600;
    font-size: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    border: 2px solid transparent;
    text-align: center;
    min-width: 80px;
    max-width: 200px;
    word-wrap: break-word;
    z-index: 1000;
  }

  .subtitle-banner.main-subtitle {
    background: linear-gradient(135deg, #90EE90 0%, #7ED321 100%);
    border-color: #7ED321;
    color: #003D20;
  }

  .subtitle-banner.poi-subtitle {
    background: linear-gradient(135deg, #FF6B35 0%, #FF8C69 100%);
    border-color: #FF6B35;
    color: white;
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .main-header h1 {
      font-size: 2rem;
    }

    .main-header p {
      font-size: 1rem;
    }

    .modern-card {
      padding: 1rem;
    }

    .convenience-grid {
      grid-template-columns: 1fr;
    }

    .map-controls {
      justify-content: center;
    }

    .map-controls .btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
    }

    .radius-selector {
      flex-direction: column;
      align-items: center;
    }

    .radius-btn {
      width: 100%;
      max-width: 200px;
    }

    .concentration-grid {
      grid-template-columns: 1fr;
    }

    .points-grid {
      grid-template-columns: 1fr;
    }

    .subtitle-banner {
      font-size: 10px;
      padding: 3px 8px;
      max-width: 150px;
    }

    /* Responsividade para tabela interativa */
    .interactive-row::after {
      content: 'üëÜ Toque';
      font-size: 0.6rem;
      right: 5px;
    }

    .quantity-badge {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      min-width: 30px;
    }

    .summary-table {
      font-size: 0.85rem;
    }

    .summary-table th,
    .summary-table td {
      padding: 0.5rem 0.25rem;
    }
  }

  /* Anima√ß√µes */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .modern-card {
    animation: fadeIn 0.6s ease-out;
  }

  /* Tooltips personalizados */
  .custom-tooltip {
    background: var(--primary-color);
    color: white;
    border-radius: 8px;
    padding: 0.5rem;
    font-size: 0.85rem;
    box-shadow: 0 4px 15px rgba(0, 81, 42, 0.2);
  }

  /* Marcadores personalizados */
  .category-marker {
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .main-marker {
    background: var(--primary-color);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 4px 15px rgba(0, 81, 42, 0.4);
  }

  .point-marker {
    background: var(--purple-color);
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(142, 68, 173, 0.4);
  }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;container mt-4&quot;&gt;
&lt;!-- Indicador de status de carregamento --&gt;
&lt;div id=&quot;loading-indicator&quot; style=&quot;position: fixed; top: 20px; right: 20px; z-index: 9999; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 25px; font-weight: 600; font-size: 14px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); display: none;&quot;&gt;
  &lt;span id=&quot;loading-text&quot;&gt;‚è≥ Carregando mapa...&lt;/span&gt;
&lt;/div&gt;

&lt;!-- Header principal --&gt;
&lt;div class=&quot;main-header&quot;&gt;
&lt;h1&gt;üè¢ Dashboard An√°lise Mercadol√≥gica&lt;/h1&gt;
&lt;p&gt;An√°lise interativa completa com dados demogr√°ficos e pontos de conveni√™ncia&lt;/p&gt;
&lt;/div&gt;

&lt;!-- Indicadores de Status --&gt;
&lt;div class=&quot;status-indicators&quot;&gt;
&lt;div class=&quot;row&quot;&gt;
&lt;div class=&quot;col-md-3 status-item&quot;&gt;
&lt;h6&gt;üîç Analisando:&lt;/h6&gt;
&lt;p id=&quot;endereco-atual&quot;&gt;Nenhum local selecionado&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;col-md-3 status-item&quot;&gt;
&lt;h6&gt;üó∫Ô∏è Visualiza√ß√£o:&lt;/h6&gt;
&lt;p id=&quot;mapa-atual&quot;&gt;Mapa Normal&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;col-md-3 status-item&quot;&gt;
&lt;h6&gt;üìå Pontos:&lt;/h6&gt;
&lt;p id=&quot;contador-pontos&quot;&gt;0&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;col-md-3 status-item&quot;&gt;
&lt;h6&gt;üìä Raio Ativo:&lt;/h6&gt;
&lt;p id=&quot;raio-ativo-display&quot;&gt;2km&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Endere√ßo Principal --&gt;
&lt;div class=&quot;modern-card&quot;&gt;
&lt;h5 style=&quot;color: var(--primary-color); font-weight: 700; margin-bottom: 1rem;&quot;&gt;üîç Endere√ßo Principal para An√°lise (Busca Avan√ßada)&lt;/h5&gt;
&lt;div class=&quot;search-tabs&quot;&gt;
&lt;button class=&quot;search-tab active&quot; onclick=&quot;setSearchTab('endereco')&quot;&gt;üîç Endere√ßo&lt;/button&gt;
&lt;button class=&quot;search-tab&quot; onclick=&quot;setSearchTab('cep')&quot;&gt;üìÆ CEP&lt;/button&gt;
&lt;button class=&quot;search-tab&quot; onclick=&quot;setSearchTab('coordenadas')&quot;&gt;üåê Lat/Lng&lt;/button&gt;
&lt;/div&gt;
&lt;div class=&quot;row&quot;&gt;
&lt;div class=&quot;col-md-6 mb-3&quot;&gt;
&lt;input class=&quot;form-control&quot; id=&quot;endereco-principal&quot; placeholder=&quot;Ex: Rua Jos√© Andr√©, 493, Fortaleza, CE&quot; type=&quot;text&quot;/&gt;
&lt;small class=&quot;text-muted&quot;&gt;üí° Digite o endere√ßo completo com cidade e estado&lt;/small&gt;
&lt;/div&gt;
&lt;div class=&quot;col-md-6 mb-3&quot;&gt;
&lt;input class=&quot;form-control subtitle-input-main&quot; id=&quot;subtitulo-principal&quot; placeholder=&quot;Subt√≠tulo (opcional)&quot; type=&quot;text&quot;/&gt;
&lt;small class=&quot;text-muted&quot;&gt;üè∑Ô∏è Aparece no mapa em verde claro&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;text-center&quot;&gt;
&lt;button class=&quot;btn btn-primary me-2&quot; onclick=&quot;buscarEnderecoPrincipal()&quot;&gt;üîç Buscar Endere√ßo&lt;/button&gt;
&lt;button class=&quot;btn btn-info me-2&quot; onclick=&quot;obterLocalizacao()&quot;&gt;üìç Minha Localiza√ß√£o&lt;/button&gt;
&lt;button class=&quot;btn btn-warning me-2&quot; onclick=&quot;limparEnderecoPrincipal()&quot;&gt;üóëÔ∏è Limpar&lt;/button&gt;
&lt;button class=&quot;btn btn-success&quot; onclick=&quot;salvarAnalise()&quot;&gt;üíæ Salvar An√°lise&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Adicionar Pontos de Interesse --&gt;
&lt;div class=&quot;modern-card&quot;&gt;
&lt;h5 style=&quot;color: var(--primary-color); font-weight: 700; margin-bottom: 1rem;&quot;&gt;üìç Adicionar Pontos de Interesse (Busca Avan√ßada)&lt;/h5&gt;
&lt;div class=&quot;search-tabs&quot;&gt;
&lt;button class=&quot;search-tab active&quot; onclick=&quot;setPointSearchTab('endereco')&quot;&gt;üîç Endere√ßo&lt;/button&gt;
&lt;button class=&quot;search-tab&quot; onclick=&quot;setPointSearchTab('cep')&quot;&gt;üìÆ CEP&lt;/button&gt;
&lt;button class=&quot;search-tab&quot; onclick=&quot;setPointSearchTab('coordenadas')&quot;&gt;üåê Lat/Lng&lt;/button&gt;
&lt;/div&gt;
&lt;div class=&quot;row&quot;&gt;
&lt;div class=&quot;col-md-6 mb-3&quot;&gt;
&lt;input class=&quot;form-control&quot; id=&quot;ponto-interesse&quot; placeholder=&quot;Ex: Shopping Iguatemi Fortaleza&quot; type=&quot;text&quot;/&gt;
&lt;small class=&quot;text-muted&quot;&gt;üí° Digite endere√ßo, estabelecimento ou ponto de interesse&lt;/small&gt;
&lt;/div&gt;
&lt;div class=&quot;col-md-6 mb-3&quot;&gt;
&lt;input class=&quot;form-control subtitle-input-poi&quot; id=&quot;subtitulo-ponto&quot; placeholder=&quot;Ex: Shopping principal&quot; type=&quot;text&quot;/&gt;
&lt;small class=&quot;text-muted&quot;&gt;üè∑Ô∏è Aparece diretamente no mapa&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;text-center&quot;&gt;
&lt;button class=&quot;btn btn-success me-2&quot; onclick=&quot;adicionarPonto()&quot;&gt;‚ûï Adicionar&lt;/button&gt;
&lt;button class=&quot;btn btn-danger me-2&quot; onclick=&quot;limparPontos()&quot;&gt;üóëÔ∏è Limpar Pontos&lt;/button&gt;
&lt;button class=&quot;btn btn-info&quot; onclick=&quot;toggleListaPontos()&quot;&gt;üëÅÔ∏è Ver Lista&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Sele√ß√£o de Conveni√™ncias --&gt;
&lt;div class=&quot;modern-card&quot;&gt;
&lt;h5 style=&quot;color: var(--primary-color); font-weight: 700; margin-bottom: 1rem;&quot;&gt;ü™ô Selecione os pontos de conveni√™ncia (limitados a 8km de raio):&lt;/h5&gt;
&lt;p class=&quot;text-muted mb-3&quot; style=&quot;font-size: 0.9rem;&quot;&gt;
  ‚ÑπÔ∏è &lt;strong&gt;Importante:&lt;/strong&gt; Todos os pontos de conveni√™ncia ser√£o gerados dentro de um raio m√°ximo de &lt;strong&gt;8km&lt;/strong&gt; do endere√ßo principal, independente do raio ativo selecionado.
&lt;/p&gt;
&lt;div class=&quot;convenience-grid&quot;&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;escolaIdiomas&quot; onchange=&quot;toggleConveniencia('escolaIdiomas')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;escolaIdiomas&quot;&gt;üåç Escola de Idiomas &lt;span style=&quot;color: #00512A;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;escolaPublica&quot; onchange=&quot;toggleConveniencia('escolaPublica')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;escolaPublica&quot;&gt;üè´ Escola P√∫blica &lt;span style=&quot;color: #2ECC71;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;escolaPrivada&quot; onchange=&quot;toggleConveniencia('escolaPrivada')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;escolaPrivada&quot;&gt;üéì Escola Privada &lt;span style=&quot;color: #3498DB;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;hospitais&quot; onchange=&quot;toggleConveniencia('hospitais')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;hospitais&quot;&gt;üè• Hospitais &lt;span style=&quot;color: #E74C3C;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;farmacias&quot; onchange=&quot;toggleConveniencia('farmacias')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;farmacias&quot;&gt;üíä Farm√°cias &lt;span style=&quot;color: #F39C12;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;clinicas&quot; onchange=&quot;toggleConveniencia('clinicas')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;clinicas&quot;&gt;ü¶∑ Cl√≠nicas Odontol√≥gicas &lt;span style=&quot;color: #9B59B6;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;bares&quot; onchange=&quot;toggleConveniencia('bares')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;bares&quot;&gt;üç∫ Bares &lt;span style=&quot;color: #E67E22;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;restaurantes&quot; onchange=&quot;toggleConveniencia('restaurantes')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;restaurantes&quot;&gt;üçΩÔ∏è Restaurantes &lt;span style=&quot;color: #F1C40F;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;hipermercados&quot; onchange=&quot;toggleConveniencia('hipermercados')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;hipermercados&quot;&gt;üè¨ Hipermercados &lt;span style=&quot;color: #8E44AD;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;supermercados&quot; onchange=&quot;toggleConveniencia('supermercados')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;supermercados&quot;&gt;üõí Supermercados &lt;span style=&quot;color: #27AE60;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;bancos&quot; onchange=&quot;toggleConveniencia('bancos')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;bancos&quot;&gt;üè¶ Ag√™ncias Banc√°rias &lt;span style=&quot;color: #34495E;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;lotericas&quot; onchange=&quot;toggleConveniencia('lotericas')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;lotericas&quot;&gt;üé∞ Lot√©ricas &lt;span style=&quot;color: #16A085;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;postoSaude&quot; onchange=&quot;toggleConveniencia('postoSaude')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;postoSaude&quot;&gt;üè• Posto de Sa√∫de &lt;span style=&quot;color: #E91E63;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;postoCombustivel&quot; onchange=&quot;toggleConveniencia('postoCombustivel')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;postoCombustivel&quot;&gt;‚õΩ Posto de Combust√≠vel &lt;span style=&quot;color: #FF5722;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;convenience-item&quot;&gt;
&lt;input id=&quot;pracasPublicas&quot; onchange=&quot;toggleConveniencia('pracasPublicas')&quot; type=&quot;checkbox&quot;/&gt;
&lt;label for=&quot;pracasPublicas&quot;&gt;üå≥ Pra√ßas P√∫blicas &lt;span style=&quot;color: #4CAF50;&quot;&gt;‚óè&lt;/span&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Mapa Principal --&gt;
&lt;div class=&quot;modern-card&quot;&gt;
&lt;h5 style=&quot;color: var(--primary-color); font-weight: 700; margin-bottom: 1rem;&quot;&gt;üó∫Ô∏è Mapa Principal Interativo&lt;/h5&gt;
&lt;div style=&quot;position: relative;&quot;&gt;
&lt;div id=&quot;map&quot;&gt;&lt;/div&gt;
&lt;!-- Controles de Camadas de Mapa --&gt;
&lt;div class=&quot;map-layer-controls&quot;&gt;
&lt;h6 style=&quot;margin: 0 0 0.5rem 0; font-size: 0.8rem; color: var(--text-dark);&quot;&gt;üó∫Ô∏è Camadas&lt;/h6&gt;
&lt;div class=&quot;layer-control-item&quot;&gt;
&lt;input type=&quot;radio&quot; name=&quot;mapLayer&quot; id=&quot;layer-normal&quot; value=&quot;normal&quot; checked&gt;
&lt;label for=&quot;layer-normal&quot;&gt;Normal&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;layer-control-item&quot;&gt;
&lt;input type=&quot;radio&quot; name=&quot;mapLayer&quot; id=&quot;layer-satellite&quot; value=&quot;satellite&quot;&gt;
&lt;label for=&quot;layer-satellite&quot;&gt;Sat√©lite&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;layer-control-item&quot;&gt;
&lt;input type=&quot;radio&quot; name=&quot;mapLayer&quot; id=&quot;layer-hybrid&quot; value=&quot;hybrid&quot;&gt;
&lt;label for=&quot;layer-hybrid&quot;&gt;H√≠brido&lt;/label&gt;
&lt;/div&gt;
&lt;div class=&quot;layer-control-item&quot;&gt;
&lt;input type=&quot;radio&quot; name=&quot;mapLayer&quot; id=&quot;layer-terrain&quot; value=&quot;terrain&quot;&gt;
&lt;label for=&quot;layer-terrain&quot;&gt;Terreno&lt;/label&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;!-- Controles do Mapa --&gt;
&lt;div class=&quot;map-controls&quot;&gt;
&lt;button class=&quot;btn btn-outline-primary&quot; onclick=&quot;toggleCirculos()&quot;&gt;üëÅÔ∏è Mostrar/Ocultar Raios&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-success&quot; onclick=&quot;forcarExibicaoCirculos()&quot; title=&quot;For√ßa a exibi√ß√£o dos c√≠rculos se sumiram&quot;&gt;üîÑ Restaurar Raios&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-warning&quot; onclick=&quot;centralizarMarcador()&quot;&gt;üéØ Centralizar Marcador&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-info&quot; id=&quot;btn-satelite&quot; onclick=&quot;toggleSatelite()&quot;&gt;üõ∞Ô∏è Sat√©lite&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-secondary&quot; onclick=&quot;resetZoom()&quot;&gt;üîç Reset Zoom&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-danger&quot; onclick=&quot;toggleFullscreen()&quot;&gt;‚ÜîÔ∏è Tela Cheia&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-dark&quot; onclick=&quot;takeScreenshot()&quot;&gt;üì∏ Tirar Print&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-dark&quot; onclick=&quot;diagnosticoSistema()&quot; title=&quot;Verificar status do sistema&quot;&gt;üîß Diagn√≥stico&lt;/button&gt;
&lt;/div&gt;
&lt;!-- Seletor de Raio --&gt;
&lt;div class=&quot;radius-selector&quot;&gt;
&lt;button class=&quot;radius-btn btn-danger active&quot; data-radius=&quot;2&quot; onclick=&quot;setRadius(2)&quot;&gt;üî¥ Raio 2km&lt;/button&gt;
&lt;button class=&quot;radius-btn btn-warning&quot; data-radius=&quot;5&quot; onclick=&quot;setRadius(5)&quot;&gt;üü° Raio 5km&lt;/button&gt;
&lt;button class=&quot;radius-btn btn-info&quot; data-radius=&quot;8&quot; onclick=&quot;setRadius(8)&quot;&gt;üîµ Raio 8km&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;

    
&lt;!-- Resumo de Conveni√™ncias por Raio (Interativo) --&gt;
&lt;div class=&quot;modern-card&quot;&gt;
&lt;h5 style=&quot;color: var(--primary-color); font-weight: 700; margin-bottom: 1rem;&quot;&gt;üìä Resumo de Conveni√™ncias por Raio (Interativo)&lt;/h5&gt;
&lt;p class=&quot;text-muted mb-3&quot;&gt;
  &lt;strong&gt;üìç An√°lise Inteligente:&lt;/strong&gt; Quantidades calculadas automaticamente baseadas no endere√ßo principal selecionado&lt;br&gt;
  &lt;small style=&quot;color: #2ECC71; font-weight: 600;&quot;&gt;
    ‚ú® &lt;strong&gt;INTERATIVO:&lt;/strong&gt; Clique em qualquer linha da tabela para destacar os pontos correspondentes no mapa!
  &lt;/small&gt;&lt;br&gt;
  &lt;small style=&quot;color: #FF6B35; font-weight: 600;&quot;&gt;
    üìç Nota: Os pontos no mapa s√£o sempre limitados a 8km, mas as estat√≠sticas abaixo mostram dados para cada raio espec√≠fico.
  &lt;/small&gt;
&lt;/p&gt;

&lt;!-- Seletor de Raio para Resumo --&gt;
&lt;div class=&quot;radius-selector&quot;&gt;
&lt;button class=&quot;radius-btn btn-danger active&quot; data-radius=&quot;2&quot; onclick=&quot;setSummaryRadius(2)&quot;&gt;üî¥ 2km&lt;/button&gt;
&lt;button class=&quot;radius-btn btn-warning&quot; data-radius=&quot;5&quot; onclick=&quot;setSummaryRadius(5)&quot;&gt;üü° 5km&lt;/button&gt;
&lt;button class=&quot;radius-btn btn-info&quot; data-radius=&quot;8&quot; onclick=&quot;setSummaryRadius(8)&quot;&gt;üîµ 8km&lt;/button&gt;
&lt;/div&gt;

&lt;!-- Controles Interativos --&gt;
&lt;div class=&quot;text-center mb-3&quot;&gt;
&lt;button class=&quot;btn btn-outline-success btn-sm me-2&quot; onclick=&quot;mostrarDicasInteratividade()&quot; title=&quot;Como usar a tabela interativa&quot;&gt;
  üí° Como Usar
&lt;/button&gt;
&lt;button class=&quot;btn btn-outline-warning btn-sm&quot; onclick=&quot;limparDestaques()&quot; title=&quot;Remove todos os destaques do mapa&quot;&gt;
  üßπ Limpar Destaques
&lt;/button&gt;
&lt;/div&gt;

&lt;div class=&quot;summary-table&quot; id=&quot;summary-table&quot;&gt;
&lt;table class=&quot;table table-striped&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Categoria&lt;/th&gt;
&lt;th&gt;2km&lt;/th&gt;
&lt;th&gt;5km&lt;/th&gt;
&lt;th&gt;8km&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;category-cell&quot;&gt;Selecione um endere√ßo principal para ver os dados&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Principais Munic√≠pios da Regi√£o Metropolitana --&gt;
&lt;div class=&quot;modern-card&quot;&gt;
&lt;h5 style=&quot;color: var(--primary-color); font-weight: 700; margin-bottom: 1rem;&quot;&gt;üèôÔ∏è Principais Munic√≠pios da Regi√£o Metropolitana&lt;/h5&gt;

&lt;!-- Fortaleza --&gt;
&lt;div class=&quot;city-card&quot;&gt;
&lt;div class=&quot;city-header&quot;&gt;
&lt;h5&gt;üèõÔ∏è Fortaleza&lt;/h5&gt;
&lt;/div&gt;
&lt;div class=&quot;city-content&quot;&gt;
&lt;div class=&quot;city-stats&quot;&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üë• Popula√ß√£o&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;2.703.391&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üìä Densidade&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;8.618 hab/km¬≤&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üéØ Pop. 25-49 anos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;891.120&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè† Dom. Alugados&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;285.420&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè° Dom. Cedidos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;89.650&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üí∞ Renda M√©dia&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;R$ 3.850&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üíµ Renda Total&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;R$ 10.4 bi&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;points-section&quot;&gt;
&lt;div class=&quot;points-grid&quot;&gt;
&lt;div class=&quot;points-card strengths&quot;&gt;
&lt;h6&gt;‚úÖ Pontos Fortes&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Centro econ√¥mico da regi√£o&lt;/li&gt;
&lt;li&gt;Maior concentra√ß√£o de servi√ßos&lt;/li&gt;
&lt;li&gt;Infraestrutura consolidada&lt;/li&gt;
&lt;li&gt;Mercado consumidor diversificado&lt;/li&gt;
&lt;li&gt;Hub de transporte e log√≠stica&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;points-card concerns&quot;&gt;
&lt;h6&gt;‚ö†Ô∏è Pontos de Aten√ß√£o&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Alta competi√ß√£o comercial&lt;/li&gt;
&lt;li&gt;Custo operacional elevado&lt;/li&gt;
&lt;li&gt;Tr√¢nsito intenso&lt;/li&gt;
&lt;li&gt;Desigualdade de renda&lt;/li&gt;
&lt;li&gt;Satura√ß√£o em alguns segmentos&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Caucaia --&gt;
&lt;div class=&quot;city-card&quot;&gt;
&lt;div class=&quot;city-header&quot;&gt;
&lt;h5&gt;üåä Caucaia&lt;/h5&gt;
&lt;/div&gt;
&lt;div class=&quot;city-content&quot;&gt;
&lt;div class=&quot;city-stats&quot;&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üë• Popula√ß√£o&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;368.954&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üìä Densidade&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;312 hab/km¬≤&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üéØ Pop. 25-49 anos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;121.595&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè† Dom. Alugados&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;45.280&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè° Dom. Cedidos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;18.450&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üí∞ Renda M√©dia&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;R$ 2.650&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üíµ Renda Total&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;R$ 978 mi&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;points-section&quot;&gt;
&lt;div class=&quot;points-grid&quot;&gt;
&lt;div class=&quot;points-card strengths&quot;&gt;
&lt;h6&gt;‚úÖ Pontos Fortes&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Crescimento populacional acelerado&lt;/li&gt;
&lt;li&gt;Proximidade com Fortaleza&lt;/li&gt;
&lt;li&gt;Potencial tur√≠stico (praias)&lt;/li&gt;
&lt;li&gt;Mercado em expans√£o&lt;/li&gt;
&lt;li&gt;Menor satura√ß√£o comercial&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;points-card concerns&quot;&gt;
&lt;h6&gt;‚ö†Ô∏è Pontos de Aten√ß√£o&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Infraestrutura em desenvolvimento&lt;/li&gt;
&lt;li&gt;Renda m√©dia mais baixa&lt;/li&gt;
&lt;li&gt;Depend√™ncia de Fortaleza&lt;/li&gt;
&lt;li&gt;Transporte p√∫blico limitado&lt;/li&gt;
&lt;li&gt;Servi√ßos b√°sicos em expans√£o&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Maracana√∫ --&gt;
&lt;div class=&quot;city-card&quot;&gt;
&lt;div class=&quot;city-header&quot;&gt;
&lt;h5&gt;üè≠ Maracana√∫&lt;/h5&gt;
&lt;/div&gt;
&lt;div class=&quot;city-content&quot;&gt;
&lt;div class=&quot;city-stats&quot;&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üë• Popula√ß√£o&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;227.886&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üìä Densidade&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;2.285 hab/km¬≤&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üéØ Pop. 25-49 anos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;75.202&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè† Dom. Alugados&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;28.950&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè° Dom. Cedidos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;11.395&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üí∞ Renda M√©dia&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;R$ 2.890&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üíµ Renda Total&lt;/div&gt;
&lt;div class=&quot;value&quot;&gt;R$ 658 mi&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;points-section&quot;&gt;
&lt;div class=&quot;points-grid&quot;&gt;
&lt;div class=&quot;points-card strengths&quot;&gt;
&lt;h6&gt;‚úÖ Pontos Fortes&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Polo industrial consolidado&lt;/li&gt;
&lt;li&gt;Boa conectividade com Fortaleza&lt;/li&gt;
&lt;li&gt;Mercado de classe trabalhadora&lt;/li&gt;
&lt;li&gt;Crescimento habitacional&lt;/li&gt;
&lt;li&gt;Potencial log√≠stico&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;points-card concerns&quot;&gt;
&lt;h6&gt;‚ö†Ô∏è Pontos de Aten√ß√£o&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Depend√™ncia do setor industrial&lt;/li&gt;
&lt;li&gt;Poder de compra limitado&lt;/li&gt;
&lt;li&gt;Competi√ß√£o com Fortaleza&lt;/li&gt;
&lt;li&gt;Polui√ß√£o industrial&lt;/li&gt;
&lt;li&gt;Infraestrutura sobrecarregada&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Eus√©bio --&gt;
&lt;div class=&quot;city-card&quot;&gt;
&lt;div class=&quot;city-header&quot;&gt;
&lt;h5&gt;üè° Eus√©bio&lt;/h5&gt;
&lt;/div&gt;
&lt;div class=&quot;city-content&quot;&gt;
&lt;div class=&quot;city-stats&quot;&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üë• Popula√ß√£o&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;52.894&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üìä Densidade&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;519 hab/km¬≤&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üéØ Pop. 25-49 anos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;17.455&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè† Dom. Alugados&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;6.850&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üè° Dom. Cedidos&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;2.645&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üí∞ Renda M√©dia&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;R$ 4.250&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;stat-item&quot;&gt;
&lt;h6&gt;üíµ Renda Total&lt;/h6&gt;
&lt;div class=&quot;value&quot;&gt;R$ 225 mi&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;points-section&quot;&gt;
&lt;div class=&quot;points-grid&quot;&gt;
&lt;div class=&quot;points-card strengths&quot;&gt;
&lt;h6&gt;‚úÖ Pontos Fortes&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Maior renda per capita da regi√£o&lt;/li&gt;
&lt;li&gt;Crescimento de classe alta&lt;/li&gt;
&lt;li&gt;Proximidade com Fortaleza&lt;/li&gt;
&lt;li&gt;Mercado premium em expans√£o&lt;/li&gt;
&lt;li&gt;Qualidade de vida elevada&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;points-card concerns&quot;&gt;
&lt;h6&gt;‚ö†Ô∏è Pontos de Aten√ß√£o&lt;/h6&gt;
&lt;ul class=&quot;points-list&quot;&gt;
&lt;li&gt;Popula√ß√£o menor&lt;/li&gt;
&lt;li&gt;Mercado mais segmentado&lt;/li&gt;
&lt;li&gt;Depend√™ncia de Fortaleza&lt;/li&gt;
&lt;li&gt;Custo de opera√ß√£o alto&lt;/li&gt;
&lt;li&gt;Competi√ß√£o por p√∫blico premium&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- √Åreas de Concentra√ß√£o Populacional --&gt;
&lt;div class=&quot;population-concentration-section&quot;&gt;
&lt;div class=&quot;population-concentration-header&quot;&gt;
&lt;h4&gt;üë• √Åreas de Concentra√ß√£o Populacional&lt;/h4&gt;
&lt;p style=&quot;margin: 0; font-size: 0.9rem; opacity: 0.9;&quot;&gt;An√°lise interativa das √°reas de maior concentra√ß√£o populacional por raio&lt;/p&gt;
&lt;/div&gt;
&lt;!-- Seletor de Raio para Concentra√ß√£o Populacional --&gt;
&lt;div class=&quot;radius-selector&quot;&gt;
&lt;button class=&quot;radius-btn btn-danger active&quot; data-radius=&quot;2&quot; onclick=&quot;setPopulationRadius(2)&quot;&gt;üî¥ 2km&lt;/button&gt;
&lt;button class=&quot;radius-btn btn-warning&quot; data-radius=&quot;5&quot; onclick=&quot;setPopulationRadius(5)&quot;&gt;üü° 5km&lt;/button&gt;
&lt;button class=&quot;radius-btn btn-info&quot; data-radius=&quot;8&quot; onclick=&quot;setPopulationRadius(8)&quot;&gt;üîµ 8km&lt;/button&gt;
&lt;/div&gt;
&lt;!-- Grid de Concentra√ß√£o Populacional --&gt;
&lt;div class=&quot;concentration-grid&quot;&gt;
&lt;div class=&quot;concentration-card&quot;&gt;
&lt;h6&gt;üèòÔ∏è √Årea Residencial Norte&lt;/h6&gt;
&lt;p&gt;&lt;strong&gt;Densidade:&lt;/strong&gt; &lt;span id=&quot;pop-north&quot;&gt;8.500 hab/km¬≤&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Perfil:&lt;/strong&gt; Fam√≠lias de classe m√©dia, predominantemente jovens adultos&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Potencial:&lt;/strong&gt; Alto para servi√ßos familiares e educa√ß√£o&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;concentration-card&quot;&gt;
&lt;h6&gt;üè¢ Centro Comercial&lt;/h6&gt;
&lt;p&gt;&lt;strong&gt;Densidade:&lt;/strong&gt; &lt;span id=&quot;pop-center&quot;&gt;12.800 hab/km¬≤&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Perfil:&lt;/strong&gt; Trabalhadores, estudantes e consumidores em tr√¢nsito&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Potencial:&lt;/strong&gt; Excelente para com√©rcio e servi√ßos r√°pidos&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;concentration-card&quot;&gt;
&lt;h6&gt;üåÜ √Årea Residencial Sul&lt;/h6&gt;
&lt;p&gt;&lt;strong&gt;Densidade:&lt;/strong&gt; &lt;span id=&quot;pop-south&quot;&gt;6.200 hab/km¬≤&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Perfil:&lt;/strong&gt; Fam√≠lias consolidadas, faixa et√°ria mais madura&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Potencial:&lt;/strong&gt; Bom para servi√ßos especializados e lazer&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;concentration-card&quot;&gt;
&lt;h6&gt;üèòÔ∏è √Årea Residencial Oeste&lt;/h6&gt;
&lt;p&gt;&lt;strong&gt;Densidade:&lt;/strong&gt; &lt;span id=&quot;pop-west&quot;&gt;7.100 hab/km¬≤&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Perfil:&lt;/strong&gt; Crescimento habitacional, fam√≠lias jovens&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Potencial:&lt;/strong&gt; Emergente para novos neg√≥cios&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Gr√°fico de Concentra√ß√£o Populacional --&gt;
&lt;div class=&quot;chart-container&quot;&gt;
&lt;h6 style=&quot;color: var(--purple-color); font-weight: 600; margin-bottom: 1rem; text-align: center;&quot;&gt;üìä Gr√°fico de Concentra√ß√£o Populacional por Raios&lt;/h6&gt;
&lt;canvas id=&quot;populationChart&quot;&gt;&lt;/canvas&gt;
&lt;/div&gt;
&lt;/div&gt;

    &lt;/div&gt;

   
    &lt;!-- Scripts --&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://unpkg.com/leaflet/dist/leaflet.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/npm/chart.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js&quot;&gt;&lt;/script&gt;

&lt;script&gt;
// Fun√ß√£o para mostrar indicador de carregamento
function showLoadingIndicator(text = '‚è≥ Carregando...') {
  const indicator = document.getElementById('loading-indicator');
  const textElement = document.getElementById('loading-text');
  if (indicator &amp;&amp; textElement) {
    textElement.textContent = text;
    indicator.style.display = 'block';
  }
}

// Fun√ß√£o para esconder indicador de carregamento
function hideLoadingIndicator() {
  const indicator = document.getElementById('loading-indicator');
  if (indicator) {
    indicator.style.display = 'none';
  }
}

// Fun√ß√£o para aguardar o carregamento do Leaflet
function waitForLeaflet(callback, maxAttempts = 50) {
  let attempts = 0;
  
  showLoadingIndicator('‚è≥ Carregando biblioteca de mapas...');
  
  function checkLeaflet() {
    attempts++;
    
    if (typeof L !== 'undefined') {
      console.log('‚úÖ Leaflet carregado com sucesso!');
      showLoadingIndicator('üó∫Ô∏è Inicializando mapa...');
      setTimeout(() =&gt; {
        hideLoadingIndicator();
        callback();
      }, 500);
    } else if (attempts &lt; maxAttempts) {
      console.log(`‚è≥ Aguardando Leaflet... Tentativa ${attempts}/${maxAttempts}`);
      showLoadingIndicator(`‚è≥ Carregando mapas... (${attempts}/${maxAttempts})`);
      setTimeout(checkLeaflet, 100); // Tenta novamente em 100ms
    } else {
      console.error('‚ùå Erro: Leaflet n√£o p√¥de ser carregado ap√≥s', maxAttempts, 'tentativas');
      hideLoadingIndicator();
      showLeafletError();
    }
  }
  
  checkLeaflet();
}

// Fun√ß√£o para mostrar erro de carregamento do Leaflet
function showLeafletError() {
  const mapElement = document.getElementById('map');
  if (mapElement) {
    mapElement.innerHTML = `
      &lt;div style=&quot;display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 15px; text-align: center; padding: 2rem;&quot;&gt;
        &lt;div style=&quot;font-size: 3rem; margin-bottom: 1rem;&quot;&gt;üó∫Ô∏è&lt;/div&gt;
        &lt;h5 style=&quot;color: #6c757d; margin-bottom: 1rem;&quot;&gt;Erro ao Carregar Mapa&lt;/h5&gt;
        &lt;p style=&quot;color: #6c757d; margin-bottom: 1rem;&quot;&gt;A biblioteca de mapas n√£o p√¥de ser carregada.&lt;/p&gt;
        &lt;div style=&quot;margin-bottom: 1rem;&quot;&gt;
          &lt;p style=&quot;font-size: 0.9rem; color: #868e96;&quot;&gt;Poss√≠veis solu√ß√µes:&lt;/p&gt;
          &lt;ul style=&quot;font-size: 0.8rem; color: #868e96; text-align: left; max-width: 300px;&quot;&gt;
            &lt;li&gt;Verifique sua conex√£o com a internet&lt;/li&gt;
            &lt;li&gt;Recarregue a p√°gina (F5)&lt;/li&gt;
            &lt;li&gt;Desative bloqueadores de an√∫ncios temporariamente&lt;/li&gt;
            &lt;li&gt;Tente novamente em alguns minutos&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;
        &lt;button class=&quot;btn btn-primary btn-sm&quot; onclick=&quot;location.reload()&quot;&gt;üîÑ Recarregar P√°gina&lt;/button&gt;
      &lt;/div&gt;
    `;
  }
}

// Inicializa√ß√£o segura quando a p√°gina e Leaflet estiverem prontos
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìÑ DOM carregado, verificando Leaflet...');
  
  waitForLeaflet(function() {
    // S√≥ executa quando Leaflet estiver 100% carregado
    try {
      console.log('üöÄ Inicializando aplica√ß√£o...');
      const mapInitialized = initMap();
      
      if (mapInitialized) {
        initPopulationChart();
        loadConcurrentesData();
        setupDragAndDrop();
        
        // Mostra mensagem de sucesso
        setTimeout(() =&gt; {
          showTemporaryMessage('‚úÖ Dashboard carregado com sucesso!', 'success');
        }, 1000);
        
        console.log('‚úÖ Dashboard inicializado com sucesso!');
      }
    } catch (error) {
      console.error('‚ùå Erro ao inicializar dashboard:', error);
      showTemporaryMessage('‚ùå Erro ao carregar dashboard', 'error');
      showLeafletError();
    }
  });
});

// Fun√ß√£o para mostrar mensagem tempor√°ria
function showTemporaryMessage(message, type = 'success', duration = 3000) {
  const indicator = document.getElementById('loading-indicator');
  const textElement = document.getElementById('loading-text');
  
  if (indicator &amp;&amp; textElement) {
    textElement.textContent = message;
    
    // Muda cor baseado no tipo
    if (type === 'success') {
      indicator.style.background = 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)';
    } else if (type === 'error') {
      indicator.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
    }
    
    indicator.style.display = 'block';
    
    setTimeout(() =&gt; {
      indicator.style.display = 'none';
      // Restaura cor original
      indicator.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }, duration);
  }
}

// Fun√ß√£o para verificar se todas as depend√™ncias est√£o carregadas
function checkDependencies() {
  const deps = {
    'Leaflet': typeof L !== 'undefined',
    'Chart.js': typeof Chart !== 'undefined', 
    'XLSX': typeof XLSX !== 'undefined'
  };
  
  console.log('üìã Status das depend√™ncias:', deps);
  return deps;
}

// Fun√ß√£o para diagn√≥stico do sistema
function diagnosticoSistema() {
  const deps = checkDependencies();
  
  let status = 'üîß DIAGN√ìSTICO DO SISTEMA\n\n';
  
  // Verifica depend√™ncias
  status += 'üìö BIBLIOTECAS:\n';
  status += `‚Ä¢ Leaflet (Mapas): ${deps.Leaflet ? '‚úÖ OK' : '‚ùå ERRO'}\n`;
  status += `‚Ä¢ Chart.js (Gr√°ficos): ${deps['Chart.js'] ? '‚úÖ OK' : '‚ùå ERRO'}\n`;
  status += `‚Ä¢ XLSX (Excel): ${deps.XLSX ? '‚úÖ OK' : '‚ùå ERRO'}\n\n`;
  
  // Verifica estado do mapa
  status += 'üó∫Ô∏è MAPA:\n';
  status += `‚Ä¢ Mapa inicializado: ${map ? '‚úÖ OK' : '‚ùå ERRO'}\n`;
  status += `‚Ä¢ Marcador principal: ${marcadorPrincipal ? '‚úÖ Ativo' : '‚ö™ Nenhum'}\n`;
  status += `‚Ä¢ Pontos de interesse: ${pontosInteresse.length} adicionados\n`;
  status += `‚Ä¢ C√≠rculos dispon√≠veis: ${circulos.length} elementos\n`;
  status += `‚Ä¢ C√≠rculos vis√≠veis: ${circulosVisiveis ? '‚úÖ Sim' : '‚ö™ N√£o'}\n\n`;
  
  // Verifica c√≠rculos no mapa
  let circulosNoMapa = 0;
  if (circulos.length &gt; 0) {
    circulos.forEach(circulo =&gt; {
      if (map &amp;&amp; map.hasLayer(circulo)) {
        circulosNoMapa++;
      }
    });
    status += `‚Ä¢ C√≠rculos realmente no mapa: ${circulosNoMapa}/${circulos.length}\n\n`;
  }
  
  // Verifica dados
  status += 'üìä DADOS:\n';
  status += `‚Ä¢ Dados de concorrentes: ${concurrentesData ? '‚úÖ Carregados' : '‚ö™ Padr√£o'}\n`;
  status += `‚Ä¢ Endere√ßo atual: ${enderecoAtual ? '‚úÖ Definido' : '‚ö™ Nenhum'}\n\n`;
  
  // Verifica conex√£o
  status += 'üåê CONEX√ÉO:\n';
  status += `‚Ä¢ Status: ${navigator.onLine ? '‚úÖ Online' : '‚ùå Offline'}\n\n`;
  
  // Solu√ß√µes sugeridas
  if (!deps.Leaflet || !map) {
    status += 'üõ†Ô∏è SOLU√á√ïES SUGERIDAS:\n';
    status += '1. Recarregue a p√°gina (F5)\n';
    status += '2. Verifique sua conex√£o\n';
    status += '3. Desative bloqueadores temporariamente\n';
    status += '4. Aguarde alguns segundos e tente novamente\n';
  } else if (circulos.length &gt; 0 &amp;&amp; circulosVisiveis &amp;&amp; circulosNoMapa &lt; circulos.length) {
    status += 'üõ†Ô∏è PROBLEMA COM C√çRCULOS DETECTADO:\n';
    status += '1. Use o bot√£o &quot;üîÑ Restaurar Raios&quot;\n';
    status += '2. Ou clique em &quot;üëÅÔ∏è Mostrar/Ocultar Raios&quot; duas vezes\n';
    status += '3. Os c√≠rculos devem reaparecer automaticamente\n';
  } else {
    status += '‚úÖ SISTEMA FUNCIONANDO NORMALMENTE!';
  }
  
  alert(status);
  console.log('üîß Diagn√≥stico executado:', deps);
}
// Vari√°veis globais
let map;
let marcadorPrincipal = null;
let labelPrincipal = null; // Nova vari√°vel para label do marcador principal
let pontosInteresse = [];
let circulos = [];
let circulosVisiveis = true;
let raioAtivo = 2;
let currentSummaryRadius = 2;
let currentPopulationRadius = 2;
let enderecoAtual = null;
let currentSearchTab = 'endereco';
let currentPointSearchTab = 'endereco';
let convenienciasSelecionadas = {};
let pontosConveniencia = [];
let populationChart = null;

// Dados de concentra√ß√£o populacional por raio
const populationData = {
  2: { north: 8500, center: 12800, south: 6200, west: 7100 },
  5: { north: 7200, center: 10500, south: 5800, west: 6400 },
  8: { north: 6100, center: 8900, south: 5200, west: 5700 }
};

// Cores para diferentes tipos de conveni√™ncia
const convenienceColors = {
  escolaIdiomas: '#00512A',
  escolaPublica: '#2ECC71',
  escolaPrivada: '#3498DB',
  hospitais: '#E74C3C',
  farmacias: '#F39C12',
  clinicas: '#9B59B6',
  bares: '#E67E22',
  restaurantes: '#F1C40F',
  hipermercados: '#8E44AD',
  supermercados: '#27AE60',
  bancos: '#34495E',
  lotericas: '#16A085',
  postoSaude: '#E91E63',
  postoCombustivel: '#FF5722',
  pracasPublicas: '#4CAF50'
};

// Inicializa√ß√£o do mapa com tratamento de erro
function initMap() {
  // Verifica√ß√£o dupla se Leaflet est√° dispon√≠vel
  if (typeof L === 'undefined') {
    console.error('‚ùå Leaflet n√£o est√° dispon√≠vel');
    showLeafletError();
    return false;
  }

  try {
    console.log('üó∫Ô∏è Inicializando mapa...');
    
    map = L.map('map').setView([-3.7319, -38.5267], 11);
    
    // Camada base padr√£o
    const normalLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Outras camadas
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri'
    });

    const hybridLayer = L.layerGroup([
      satelliteLayer,
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
        attribution: '¬© Esri'
      })
    ]);

    const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenTopoMap contributors'
    });

    // Event listeners para controles de camada
    document.querySelectorAll('input[name=&quot;mapLayer&quot;]').forEach(radio =&gt; {
      radio.addEventListener('change', function() {
        if (!map) return; // Prote√ß√£o adicional
        
        // Remove apenas as camadas de base, preservando c√≠rculos e marcadores
        map.eachLayer(layer =&gt; {
          // Preserva marcadores, labels, c√≠rculos e pontos de conveni√™ncia
          const isMarker = layer === marcadorPrincipal || layer === labelPrincipal;
          const isPOI = pontosInteresse.some(p =&gt; p.marcador === layer || p.label === layer);
          const isCircle = circulos.includes(layer);
          const isConvenience = pontosConveniencia.includes(layer);
          
          // Remove apenas se n√£o for nenhum dos elementos preservados E for uma camada de tile
          if (!isMarker &amp;&amp; !isPOI &amp;&amp; !isCircle &amp;&amp; !isConvenience &amp;&amp; layer._url) {
            map.removeLayer(layer);
          }
        });

        // Adiciona a nova camada base
        switch(this.value) {
          case 'normal':
            normalLayer.addTo(map);
            document.getElementById('mapa-atual').textContent = 'Mapa Normal';
            break;
          case 'satellite':
            satelliteLayer.addTo(map);
            document.getElementById('mapa-atual').textContent = 'Sat√©lite';
            break;
          case 'hybrid':
            hybridLayer.addTo(map);
            document.getElementById('mapa-atual').textContent = 'H√≠brido';
            break;
          case 'terrain':
            terrainLayer.addTo(map);
            document.getElementById('mapa-atual').textContent = 'Terreno';
            break;
        }
        
        // Garante que os c√≠rculos permane√ßam vis√≠veis se estavam vis√≠veis antes
        if (circulosVisiveis &amp;&amp; circulos.length &gt; 0) {
          setTimeout(() =&gt; {
            recriarCirculosSeNecessario();
          }, 100);
        }
        
        // Adiciona event listener para detectar quando a camada base √© adicionada
        map.on('baselayerchange', function() {
          if (circulosVisiveis &amp;&amp; enderecoAtual) {
            setTimeout(() =&gt; {
              console.log('üîÑ Camada base mudou, verificando c√≠rculos...');
              recriarCirculosSeNecessario();
            }, 200);
          }
        });
      });
    });

    console.log('‚úÖ Mapa inicializado com sucesso');
    return true;
    
  } catch (error) {
    console.error('‚ùå Erro ao inicializar mapa:', error);
    showLeafletError();
    return false;
  }
}

// Fun√ß√£o para buscar endere√ßo via API Nominatim
async function buscarEndereco(query) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&amp;q=${encodeURIComponent(query)}&amp;limit=1`);
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Erro ao buscar endere√ßo:', error);
    return [];
  }
}

// Fun√ß√£o para definir aba de busca
function setSearchTab(tab) {
  currentSearchTab = tab;
  document.querySelectorAll('.search-tabs .search-tab').forEach(btn =&gt; btn.classList.remove('active'));
  event.target.classList.add('active');
  
  const input = document.getElementById('endereco-principal');
  switch(tab) {
    case 'endereco':
      input.placeholder = 'Ex: Rua Jos√© Andr√©, 493, Fortaleza, CE';
      break;
    case 'cep':
      input.placeholder = 'Ex: 60160-110';
      break;
    case 'coordenadas':
      input.placeholder = 'Ex: -3.7319, -38.5267';
      break;
  }
}

// Fun√ß√£o para definir aba de busca de pontos
function setPointSearchTab(tab) {
  currentPointSearchTab = tab;
  const tabs = event.target.parentElement.querySelectorAll('.search-tab');
  tabs.forEach(btn =&gt; btn.classList.remove('active'));
  event.target.classList.add('active');
  
  const input = document.getElementById('ponto-interesse');
  switch(tab) {
    case 'endereco':
      input.placeholder = 'Ex: Shopping Iguatemi Fortaleza';
      break;
    case 'cep':
      input.placeholder = 'Ex: 60160-110';
      break;
    case 'coordenadas':
      input.placeholder = 'Ex: -3.7319, -38.5267';
      break;
  }
}

// Fun√ß√£o para buscar endere√ßo principal
async function buscarEnderecoPrincipal() {
  const endereco = document.getElementById('endereco-principal').value.trim();
  const subtitulo = document.getElementById('subtitulo-principal').value.trim();
  
  if (!endereco) {
    alert('Por favor, digite um endere√ßo.');
    return;
  }

  try {
    let query = endereco;
    
    // Processa diferentes tipos de busca
    if (currentSearchTab === 'coordenadas') {
      const coords = endereco.split(',').map(c =&gt; c.trim());
      if (coords.length === 2) {
        const lat = parseFloat(coords[0]);
        const lng = parseFloat(coords[1]);
        if (!isNaN(lat) &amp;&amp; !isNaN(lng)) {
          criarMarcadorPrincipal(lat, lng, `Coordenadas: ${lat}, ${lng}`, subtitulo);
          return;
        }
      }
    }

    const resultados = await buscarEndereco(query);
    
    if (resultados.length === 0) {
      alert('Endere√ßo n√£o encontrado. Tente ser mais espec√≠fico.');
      return;
    }

    const resultado = resultados[0];
    const { lat, lon, display_name } = resultado;
    
    criarMarcadorPrincipal(parseFloat(lat), parseFloat(lon), display_name, subtitulo);
    
  } catch (error) {
    console.error('Erro ao buscar endere√ßo:', error);
    alert('Erro ao buscar endere√ßo. Tente novamente.');
  }
}

// Fun√ß√£o para criar marcador principal com faixa de subt√≠tulo
function criarMarcadorPrincipal(lat, lng, endereco, subtitulo) {
  // Verifica√ß√£o de seguran√ßa
  if (typeof L === 'undefined' || !map) {
    console.error('‚ùå Mapa n√£o est√° dispon√≠vel');
    alert('‚ö†Ô∏è Erro: Mapa n√£o carregado. Recarregue a p√°gina.');
    return;
  }

  try {
    // Remove marcador e label anteriores
    if (marcadorPrincipal) {
      map.removeLayer(marcadorPrincipal);
    }
    if (labelPrincipal) {
      map.removeLayer(labelPrincipal);
    }
    
    // Remove c√≠rculos anteriores
    circulos.forEach(circulo =&gt; map.removeLayer(circulo));
    circulos = [];

    // Cria novo marcador principal com √≠cone verde
    marcadorPrincipal = L.marker([lat, lng], {
      icon: L.divIcon({
        className: 'custom-div-icon',
        html: '&lt;div style=&quot;background-color: #2ECC71; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); font-size: 16px;&quot;&gt;üìç&lt;/div&gt;',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      })
    }).addTo(map);

    // Cria faixa de subt√≠tulo se houver subt√≠tulo
    if (subtitulo &amp;&amp; subtitulo.trim() !== '') {
      // Calcula posi√ß√£o da faixa (ligeiramente acima do marcador)
      const offsetLat = lat + 0.0005; // Pequeno offset para cima
      
      labelPrincipal = L.marker([offsetLat, lng], {
        icon: L.divIcon({
          className: 'subtitle-banner-marker',
          html: `&lt;div class=&quot;subtitle-banner main-subtitle&quot;&gt;${subtitulo}&lt;/div&gt;`,
          iconSize: [200, 30],
          iconAnchor: [100, 35] // Centraliza horizontalmente e posiciona abaixo
        })
      }).addTo(map);
    }

    // Popup com subt√≠tulo verde
    const popupText = subtitulo ? 
      `&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;color: #2ECC71; font-size: 16px;&quot;&gt;${subtitulo}&lt;/b&gt;&lt;br&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;${endereco}&lt;/span&gt;&lt;/div&gt;` : 
      `&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;color: #2ECC71; font-size: 16px;&quot;&gt;Endere√ßo Principal&lt;/b&gt;&lt;br&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;${endereco}&lt;/span&gt;&lt;/div&gt;`;
    
    marcadorPrincipal.bindPopup(popupText);

    // Cria c√≠rculos de raio (sempre vis√≠veis)
    criarCirculos(lat, lng);

    // Centraliza mapa
    map.setView([lat, lng], 14);

    // Atualiza informa√ß√µes
    enderecoAtual = { lat, lng, endereco, subtitulo };
    document.getElementById('endereco-atual').textContent = subtitulo || endereco.substring(0, 30) + '...';
    
    // Atualiza resumo baseado no novo endere√ßo
    updateSummaryData();
    
    // Gera pontos de conveni√™ncia se houver sele√ß√µes
    gerarPontosConveniencia();

    console.log('‚úÖ Marcador principal criado:', { lat, lng, endereco, subtitulo });
    
  } catch (error) {
    console.error('‚ùå Erro ao criar marcador principal:', error);
    alert('‚ö†Ô∏è Erro ao criar marcador. Tente recarregar a p√°gina.');
  }
}

// Fun√ß√£o para obter localiza√ß√£o atual
function obterLocalizacao() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        criarMarcadorPrincipal(lat, lng, 'Minha Localiza√ß√£o', 'Localiza√ß√£o Atual');
      },
      function(error) {
        alert('Erro ao obter localiza√ß√£o: ' + error.message);
      }
    );
  } else {
    alert('Geolocaliza√ß√£o n√£o √© suportada neste navegador.');
  }
}

// Fun√ß√£o para limpar endere√ßo principal
function limparEnderecoPrincipal() {
  // Verifica√ß√£o de seguran√ßa
  if (typeof L === 'undefined' || !map) {
    console.warn('‚ö†Ô∏è Mapa n√£o dispon√≠vel para limpeza');
    // Mesmo assim, limpa os dados locais
  } else {
    try {
      if (marcadorPrincipal) {
        map.removeLayer(marcadorPrincipal);
        marcadorPrincipal = null;
      }
      
      if (labelPrincipal) {
        map.removeLayer(labelPrincipal);
        labelPrincipal = null;
      }
      
      circulos.forEach(circulo =&gt; map.removeLayer(circulo));
      circulos = [];
      circulosVisiveis = false;
      
      // Limpa pontos de conveni√™ncia
      pontosConveniencia.forEach(ponto =&gt; map.removeLayer(ponto));
      pontosConveniencia = [];
      
      // Remove destaques
      removerDestaquePontos();
    } catch (error) {
      console.error('‚ùå Erro ao limpar elementos do mapa:', error);
    }
  }
  
  // Limpa interface e dados
  document.getElementById('endereco-principal').value = '';
  document.getElementById('subtitulo-principal').value = '';
  document.getElementById('endereco-atual').textContent = 'Nenhum local selecionado';
  
  enderecoAtual = null;
  
  // Limpa tabela de resumo
  const tableBody = document.querySelector('#summary-table tbody');
  if (tableBody) {
    tableBody.innerHTML = `
      &lt;tr&gt;
        &lt;td class=&quot;category-cell&quot;&gt;Selecione um endere√ßo principal para ver os dados&lt;/td&gt;
        &lt;td&gt;-&lt;/td&gt;
        &lt;td&gt;-&lt;/td&gt;
        &lt;td&gt;-&lt;/td&gt;
      &lt;/tr&gt;
    `;
  }
  
  console.log('‚úÖ Endere√ßo principal limpo');
}

// Fun√ß√£o para mostrar dicas de uso da funcionalidade interativa
function mostrarDicasInteratividade() {
  const dicas = `
üéØ COMO USAR O RESUMO INTERATIVO:

1. üìç Primeiro, selecione um ENDERE√áO PRINCIPAL
2. ‚úÖ Marque os tipos de conveni√™ncia desejados
3. üëÜ CLIQUE em qualquer linha da tabela
4. ‚ú® Veja os pontos DESTACADOS no mapa!

üîç FUNCIONALIDADES:
‚Ä¢ An√°lise autom√°tica baseada no endere√ßo
‚Ä¢ Destaque visual dos pontos no mapa
‚Ä¢ Anima√ß√µes de pulso nos pontos destacados
‚Ä¢ Quantidades ajustadas por regi√£o

üó∫Ô∏è TIPOS DE REGI√ÉO DETECTADOS:
‚Ä¢ Centro/Comercial = Mais servi√ßos
‚Ä¢ Residencial Premium = Boa infraestrutura  
‚Ä¢ Em Desenvolvimento = Densidade m√©dia
‚Ä¢ Perif√©rica = Menor concentra√ß√£o

üí° DICA: Teste diferentes endere√ßos para ver
como as quantidades mudam automaticamente!
  `;
  
  alert(dicas);
}

// Fun√ß√£o para limpar todos os destaques
function limparDestaques() {
  removerDestaquePontos();
  document.querySelectorAll('.interactive-row').forEach(row =&gt; {
    row.classList.remove('linha-destacada');
  });
  showTemporaryMessage('üßπ Destaques removidos', 'success', 1500);
}

// Fun√ß√£o para adicionar ponto de interesse
async function adicionarPonto() {
  const endereco = document.getElementById('ponto-interesse').value.trim();
  const subtitulo = document.getElementById('subtitulo-ponto').value.trim();
  
  if (!endereco) {
    alert('Por favor, digite um endere√ßo para o ponto de interesse.');
    return;
  }

  try {
    let query = endereco;
    
    // Processa diferentes tipos de busca
    if (currentPointSearchTab === 'coordenadas') {
      const coords = endereco.split(',').map(c =&gt; c.trim());
      if (coords.length === 2) {
        const lat = parseFloat(coords[0]);
        const lng = parseFloat(coords[1]);
        if (!isNaN(lat) &amp;&amp; !isNaN(lng)) {
          criarPontoInteresse(lat, lng, `Coordenadas: ${lat}, ${lng}`, subtitulo);
          return;
        }
      }
    }

    const resultados = await buscarEndereco(query);
    
    if (resultados.length === 0) {
      alert('Local n√£o encontrado. Tente ser mais espec√≠fico.');
      return;
    }

    const resultado = resultados[0];
    const { lat, lon, display_name } = resultado;
    
    criarPontoInteresse(parseFloat(lat), parseFloat(lon), display_name, subtitulo);
    
  } catch (error) {
    console.error('Erro ao adicionar ponto:', error);
    alert('Erro ao adicionar ponto. Tente novamente.');
  }
}

// Fun√ß√£o para criar ponto de interesse com faixa de subt√≠tulo
function criarPontoInteresse(lat, lng, endereco, subtitulo) {
  // Verifica√ß√£o de seguran√ßa
  if (typeof L === 'undefined' || !map) {
    console.error('‚ùå Mapa n√£o est√° dispon√≠vel');
    alert('‚ö†Ô∏è Erro: Mapa n√£o carregado. Recarregue a p√°gina.');
    return;
  }

  try {
    // Cria marcador personalizado para ponto de interesse com cor laranja
    const pontoMarcador = L.marker([lat, lng], {
      icon: L.divIcon({
        className: 'custom-div-icon',
        html: '&lt;div style=&quot;background-color: #FF6B35; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);&quot;&gt;üìç&lt;/div&gt;',
        iconSize: [25, 25],
        iconAnchor: [12, 12]
      })
    }).addTo(map);

    // Cria faixa de subt√≠tulo se houver subt√≠tulo
    let labelMarcador = null;
    if (subtitulo &amp;&amp; subtitulo.trim() !== '') {
      // Calcula posi√ß√£o da faixa (ligeiramente acima do marcador)
      const offsetLat = lat + 0.0005; // Pequeno offset para cima
      
      labelMarcador = L.marker([offsetLat, lng], {
        icon: L.divIcon({
          className: 'subtitle-banner-marker',
          html: `&lt;div class=&quot;subtitle-banner poi-subtitle&quot;&gt;${subtitulo}&lt;/div&gt;`,
          iconSize: [200, 30],
          iconAnchor: [100, 35] // Centraliza horizontalmente e posiciona abaixo
        })
      }).addTo(map);
    }

    // Popup com subt√≠tulo laranja
    const popupText = subtitulo ? 
      `&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;color: #FF6B35; font-size: 14px;&quot;&gt;${subtitulo}&lt;/b&gt;&lt;br&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;${endereco}&lt;/span&gt;&lt;/div&gt;` : 
      `&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;color: #FF6B35; font-size: 14px;&quot;&gt;Ponto de Interesse&lt;/b&gt;&lt;br&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;${endereco}&lt;/span&gt;&lt;/div&gt;`;
    
    pontoMarcador.bindPopup(popupText);

    // Adiciona √† lista de pontos
    pontosInteresse.push({
      marcador: pontoMarcador,
      label: labelMarcador,
      endereco: endereco,
      subtitulo: subtitulo || 'Ponto de Interesse',
      lat: lat,
      lng: lng
    });

    // Atualiza contador de pontos
    document.getElementById('contador-pontos').textContent = pontosInteresse.length;

    // Limpa campos
    document.getElementById('ponto-interesse').value = '';
    document.getElementById('subtitulo-ponto').value = '';

    console.log('‚úÖ Ponto de interesse adicionado:', { lat, lng, endereco, subtitulo });
    
  } catch (error) {
    console.error('‚ùå Erro ao criar ponto de interesse:', error);
    alert('‚ö†Ô∏è Erro ao criar ponto de interesse. Tente recarregar a p√°gina.');
  }
}

// Fun√ß√£o para limpar pontos de interesse
function limparPontos() {
  try {
    pontosInteresse.forEach(ponto =&gt; {
      if (map &amp;&amp; ponto.marcador) {
        map.removeLayer(ponto.marcador);
      }
      if (map &amp;&amp; ponto.label) {
        map.removeLayer(ponto.label);
      }
    });
    pontosInteresse = [];
    document.getElementById('contador-pontos').textContent = '0';
    console.log('‚úÖ Pontos de interesse limpos');
  } catch (error) {
    console.error('‚ùå Erro ao limpar pontos:', error);
    // Mesmo com erro, limpa a lista
    pontosInteresse = [];
    document.getElementById('contador-pontos').textContent = '0';
  }
}

// Fun√ß√£o para alternar lista de pontos
function toggleListaPontos() {
  // Esta fun√ß√£o pode ser implementada para mostrar/ocultar uma lista de pontos
  console.log('Lista de pontos:', pontosInteresse);
  alert(`Pontos adicionados: ${pontosInteresse.length}\n${pontosInteresse.map(p =&gt; p.subtitulo).join('\n')}`);
}

// Fun√ß√£o para recriar c√≠rculos se necess√°rio
function recriarCirculosSeNecessario() {
  if (!enderecoAtual || !map) return;
  
  try {
    // Verifica se os c√≠rculos ainda est√£o no mapa
    let circulosNoMapa = 0;
    circulos.forEach(circulo =&gt; {
      if (map.hasLayer(circulo)) {
        circulosNoMapa++;
      }
    });
    
    // Se alguns c√≠rculos sumiram, recria todos
    if (circulosNoMapa &lt; circulos.length &amp;&amp; circulosVisiveis) {
      console.log('üîÑ Recriando c√≠rculos que sumiram...');
      
      // Remove c√≠rculos existentes
      circulos.forEach(circulo =&gt; {
        if (map.hasLayer(circulo)) {
          map.removeLayer(circulo);
        }
      });
      circulos = [];
      
      // Recria os c√≠rculos
      criarCirculos(enderecoAtual.lat, enderecoAtual.lng);
      console.log('‚úÖ C√≠rculos recriados com sucesso');
    }
  } catch (error) {
    console.error('‚ùå Erro ao recriar c√≠rculos:', error);
  }
}

// Fun√ß√£o para for√ßar exibi√ß√£o dos c√≠rculos
function forcarExibicaoCirculos() {
  if (!enderecoAtual || !map) {
    alert('‚ö†Ô∏è Primeiro selecione um endere√ßo principal.');
    return;
  }
  
  try {
    // Remove todos os c√≠rculos existentes
    circulos.forEach(circulo =&gt; {
      if (map.hasLayer(circulo)) {
        map.removeLayer(circulo);
      }
    });
    circulos = [];
    
    // Recria os c√≠rculos
    criarCirculos(enderecoAtual.lat, enderecoAtual.lng);
    circulosVisiveis = true;
    
    console.log('üîÑ C√≠rculos for√ßados a reaparecer');
    showTemporaryMessage('‚úÖ C√≠rculos restaurados!', 'success', 2000);
    
  } catch (error) {
    console.error('‚ùå Erro ao for√ßar c√≠rculos:', error);
    showTemporaryMessage('‚ùå Erro ao restaurar c√≠rculos', 'error', 2000);
  }
}
function criarCirculos(lat, lng) {
  // Verifica√ß√£o de seguran√ßa
  if (typeof L === 'undefined' || !map) {
    console.warn('‚ö†Ô∏è Mapa n√£o dispon√≠vel para criar c√≠rculos');
    return;
  }

  try {
    const cores = ['#E74C3C', '#F39C12', '#3498DB'];
    const raios = [2000, 5000, 8000]; // metros
    const labels = ['2km', '5km', '8km'];
    
    raios.forEach((raio, index) =&gt; {
      const circulo = L.circle([lat, lng], {
        color: cores[index],
        fillColor: cores[index],
        fillOpacity: 0.1,
        radius: raio,
        weight: 3
      }).addTo(map);
      
      // Adiciona label do raio
      const labelMarker = L.marker([lat + (raio * 0.00001), lng], {
        icon: L.divIcon({
          className: 'radius-label',
          html: `&lt;div style=&quot;background-color: ${cores[index]}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);&quot;&gt;${labels[index]}&lt;/div&gt;`,
          iconSize: [40, 20],
          iconAnchor: [20, 10]
        })
      }).addTo(map);
      
      circulos.push(circulo);
      circulos.push(labelMarker);
    });
    
    circulosVisiveis = true;
    console.log('‚úÖ C√≠rculos criados com sucesso');
    
  } catch (error) {
    console.error('‚ùå Erro ao criar c√≠rculos:', error);
  }
}

// Fun√ß√£o para verificar se o mapa est√° dispon√≠vel
function isMapReady() {
  if (typeof L === 'undefined' || !map) {
    alert('‚ö†Ô∏è Mapa ainda n√£o foi carregado. Aguarde alguns segundos e tente novamente.');
    return false;
  }
  return true;
}

// Fun√ß√£o para alternar visibilidade dos c√≠rculos
function toggleCirculos() {
  if (!isMapReady()) return;
  
  if (circulos.length === 0 &amp;&amp; !enderecoAtual) {
    alert('Primeiro selecione um endere√ßo principal.');
    return;
  }
  
  try {
    if (circulos.length === 0 &amp;&amp; enderecoAtual) {
      // Se n√£o h√° c√≠rculos mas h√° endere√ßo, cria os c√≠rculos
      criarCirculos(enderecoAtual.lat, enderecoAtual.lng);
      circulosVisiveis = true;
      showTemporaryMessage('‚úÖ C√≠rculos exibidos', 'success', 1500);
    } else if (circulosVisiveis) {
      // Oculta os c√≠rculos
      circulos.forEach(circulo =&gt; {
        if (map.hasLayer(circulo)) {
          map.removeLayer(circulo);
        }
      });
      circulosVisiveis = false;
      showTemporaryMessage('üëÅÔ∏è C√≠rculos ocultos', 'success', 1500);
    } else {
      // Mostra os c√≠rculos
      let circulosAdicionados = 0;
      circulos.forEach(circulo =&gt; {
        if (!map.hasLayer(circulo)) {
          circulo.addTo(map);
          circulosAdicionados++;
        }
      });
      
      // Se nenhum c√≠rculo foi adicionado (possivelmente foram removidos), recria
      if (circulosAdicionados === 0 &amp;&amp; enderecoAtual) {
        criarCirculos(enderecoAtual.lat, enderecoAtual.lng);
      }
      
      circulosVisiveis = true;
      showTemporaryMessage('‚úÖ C√≠rculos exibidos', 'success', 1500);
    }
  } catch (error) {
    console.error('‚ùå Erro ao alternar c√≠rculos:', error);
    // Tenta for√ßar a recria√ß√£o em caso de erro
    if (enderecoAtual) {
      forcarExibicaoCirculos();
    }
  }
}

// Fun√ß√£o para centralizar no marcador principal
function centralizarMarcador() {
  if (!isMapReady()) return;
  
  if (marcadorPrincipal &amp;&amp; enderecoAtual) {
    try {
      map.setView([enderecoAtual.lat, enderecoAtual.lng], 14);
    } catch (error) {
      console.error('‚ùå Erro ao centralizar marcador:', error);
    }
  } else {
    alert('Nenhum endere√ßo principal selecionado.');
  }
}

// Fun√ß√£o para alternar sat√©lite
function toggleSatelite() {
  if (!isMapReady()) return;
  
  try {
    const wasVisible = circulosVisiveis;
    document.getElementById('layer-satellite').checked = true;
    document.getElementById('layer-satellite').dispatchEvent(new Event('change'));
    
    // Garante que os c√≠rculos permane√ßam se estavam vis√≠veis
    if (wasVisible &amp;&amp; enderecoAtual) {
      setTimeout(() =&gt; {
        if (!circulosVisiveis || circulos.length === 0) {
          console.log('üîÑ Restaurando c√≠rculos ap√≥s mudan√ßa para sat√©lite...');
          forcarExibicaoCirculos();
        }
      }, 300);
    }
  } catch (error) {
    console.error('‚ùå Erro ao alternar sat√©lite:', error);
  }
}

// Fun√ß√£o para resetar zoom
function resetZoom() {
  if (!isMapReady()) return;
  
  try {
    if (enderecoAtual) {
      map.setView([enderecoAtual.lat, enderecoAtual.lng], 14);
    } else {
      map.setView([-3.7319, -38.5267], 11);
    }
  } catch (error) {
    console.error('‚ùå Erro ao resetar zoom:', error);
  }
}

// Fun√ß√£o para tela cheia
function toggleFullscreen() {
  if (!isMapReady()) return;
  
  try {
    const mapElement = document.getElementById('map');
    if (!document.fullscreenElement) {
      mapElement.requestFullscreen().then(() =&gt; {
        setTimeout(() =&gt; map.invalidateSize(), 100);
      });
    } else {
      document.exitFullscreen().then(() =&gt; {
        setTimeout(() =&gt; map.invalidateSize(), 100);
      });
    }
  } catch (error) {
    console.error('‚ùå Erro ao alternar tela cheia:', error);
  }
}

// Fun√ß√£o para tirar screenshot
function takeScreenshot() {
  alert('Funcionalidade de screenshot ser√° implementada em vers√£o futura.');
}

// Fun√ß√£o para definir raio ativo
function setRadius(raio) {
  raioAtivo = raio;
  
  // Atualiza bot√µes
  document.querySelectorAll('.radius-btn').forEach(btn =&gt; btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Atualiza indicador
  document.getElementById('raio-ativo-display').textContent = `${raio}km`;
}

// Fun√ß√£o para definir raio do resumo
function setSummaryRadius(radius) {
  currentSummaryRadius = radius;
  
  // Atualiza bot√µes
  const buttons = event.target.parentElement.querySelectorAll('.radius-btn');
  buttons.forEach(btn =&gt; btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Atualiza dados do resumo baseado no endere√ßo principal
  updateSummaryData();
}

// Fun√ß√£o para definir raio de concentra√ß√£o populacional
function setPopulationRadius(radius) {
  currentPopulationRadius = radius;
  
  // Atualiza bot√µes
  const buttons = event.target.parentElement.querySelectorAll('.radius-btn');
  buttons.forEach(btn =&gt; btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Atualiza dados
  updatePopulationData();
  updatePopulationChart();
}

// Fun√ß√£o para atualizar dados do resumo baseado no endere√ßo principal e raios
function updateSummaryData() {
  if (!enderecoAtual) {
    console.log('Nenhum endere√ßo principal definido para atualizar resumo');
    return;
  }

  // Analisa dados baseados no endere√ßo principal real
  const enderecoPrincipal = enderecoAtual.endereco.toLowerCase();
  const subtitulo = enderecoAtual.subtitulo?.toLowerCase() || '';
  
  // Sistema de an√°lise inteligente baseado no endere√ßo
  const summaryDataByRadius = analisarConvenienciasPorEndereco(enderecoPrincipal, subtitulo);

  const data2km = summaryDataByRadius[2];
  const data5km = summaryDataByRadius[5];
  const data8km = summaryDataByRadius[8];
  
  // Atualiza a tabela de resumo com interatividade
  const tableBody = document.querySelector('#summary-table tbody');
  if (tableBody) {
    tableBody.innerHTML = `
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;escolaIdiomas&quot; onclick=&quot;destacarPontosNoMapa('escolaIdiomas')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üåç Escola de Idiomas&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #00512A;&quot;&gt;${data2km.escolaIdiomas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #2ECC71;&quot;&gt;${data5km.escolaIdiomas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #3498DB;&quot;&gt;${data8km.escolaIdiomas}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;escolaPublica&quot; onclick=&quot;destacarPontosNoMapa('escolaPublica')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üè´ Escola P√∫blica&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #E74C3C;&quot;&gt;${data2km.escolaPublica}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #27AE60;&quot;&gt;${data5km.escolaPublica}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #2980B9;&quot;&gt;${data8km.escolaPublica}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;escolaPrivada&quot; onclick=&quot;destacarPontosNoMapa('escolaPrivada')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üéì Escola Privada&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #3498DB;&quot;&gt;${data2km.escolaPrivada}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #16A085;&quot;&gt;${data5km.escolaPrivada}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #2980B9;&quot;&gt;${data8km.escolaPrivada}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;hospitais&quot; onclick=&quot;destacarPontosNoMapa('hospitais')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üè• Hospitais&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #E74C3C;&quot;&gt;${data2km.hospitais}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #C0392B;&quot;&gt;${data5km.hospitais}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #A93226;&quot;&gt;${data8km.hospitais}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;farmacias&quot; onclick=&quot;destacarPontosNoMapa('farmacias')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üíä Farm√°cias&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #F39C12;&quot;&gt;${data2km.farmacias}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #E67E22;&quot;&gt;${data5km.farmacias}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #D35400;&quot;&gt;${data8km.farmacias}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;clinicas&quot; onclick=&quot;destacarPontosNoMapa('clinicas')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;ü¶∑ Cl√≠nicas Odontol√≥gicas&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #9B59B6;&quot;&gt;${data2km.clinicas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #8E44AD;&quot;&gt;${data5km.clinicas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #7D3C98;&quot;&gt;${data8km.clinicas}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;bares&quot; onclick=&quot;destacarPontosNoMapa('bares')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üç∫ Bares&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #E67E22;&quot;&gt;${data2km.bares}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #D35400;&quot;&gt;${data5km.bares}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #BA4A00;&quot;&gt;${data8km.bares}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;restaurantes&quot; onclick=&quot;destacarPontosNoMapa('restaurantes')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üçΩÔ∏è Restaurantes&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #F1C40F;&quot;&gt;${data2km.restaurantes}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #F39C12;&quot;&gt;${data5km.restaurantes}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #E67E22;&quot;&gt;${data8km.restaurantes}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;hipermercados&quot; onclick=&quot;destacarPontosNoMapa('hipermercados')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üè¨ Hipermercados&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #8E44AD;&quot;&gt;${data2km.hipermercados}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #7D3C98;&quot;&gt;${data5km.hipermercados}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #6C3483;&quot;&gt;${data8km.hipermercados}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;supermercados&quot; onclick=&quot;destacarPontosNoMapa('supermercados')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üõí Supermercados&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #27AE60;&quot;&gt;${data2km.supermercados}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #229954;&quot;&gt;${data5km.supermercados}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #1E8449;&quot;&gt;${data8km.supermercados}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;bancos&quot; onclick=&quot;destacarPontosNoMapa('bancos')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üè¶ Ag√™ncias Banc√°rias&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #34495E;&quot;&gt;${data2km.bancos}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #2C3E50;&quot;&gt;${data5km.bancos}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #1B2631;&quot;&gt;${data8km.bancos}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;lotericas&quot; onclick=&quot;destacarPontosNoMapa('lotericas')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üé∞ Lot√©ricas&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #16A085;&quot;&gt;${data2km.lotericas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #138D75;&quot;&gt;${data5km.lotericas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #117A65;&quot;&gt;${data8km.lotericas}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;postoSaude&quot; onclick=&quot;destacarPontosNoMapa('postoSaude')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üè• Posto de Sa√∫de&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #E91E63;&quot;&gt;${data2km.postoSaude}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #C2185B;&quot;&gt;${data5km.postoSaude}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #AD1457;&quot;&gt;${data8km.postoSaude}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;postoCombustivel&quot; onclick=&quot;destacarPontosNoMapa('postoCombustivel')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;‚õΩ Posto de Combust√≠vel&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #FF5722;&quot;&gt;${data2km.postoCombustivel}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #E64A19;&quot;&gt;${data5km.postoCombustivel}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #D84315;&quot;&gt;${data8km.postoCombustivel}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr class=&quot;interactive-row&quot; data-tipo=&quot;pracasPublicas&quot; onclick=&quot;destacarPontosNoMapa('pracasPublicas')&quot;&gt;
        &lt;td class=&quot;category-cell&quot;&gt;üå≥ Pra√ßas P√∫blicas&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #4CAF50;&quot;&gt;${data2km.pracasPublicas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #43A047;&quot;&gt;${data5km.pracasPublicas}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;quantity-badge clickable&quot; style=&quot;background-color: #388E3C;&quot;&gt;${data8km.pracasPublicas}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
    `;
  }
  
  console.log(`Resumo atualizado para raio ${currentSummaryRadius}km baseado no endere√ßo principal: ${enderecoAtual.endereco}`);
}

// Fun√ß√£o para atualizar dados de concentra√ß√£o populacional
function updatePopulationData() {
  const data = populationData[currentPopulationRadius];
  
  if (data) {
    document.getElementById('pop-north').textContent = data.north + ' hab/km¬≤';
    document.getElementById('pop-center').textContent = data.center + ' hab/km¬≤';
    document.getElementById('pop-south').textContent = data.south + ' hab/km¬≤';
    document.getElementById('pop-west').textContent = data.west + ' hab/km¬≤';
  }
}

// Fun√ß√£o para alternar conveni√™ncia
function toggleConveniencia(tipo) {
  const checkbox = document.getElementById(tipo);
  convenienciasSelecionadas[tipo] = checkbox.checked;
  
  if (checkbox.checked) {
    // Verifica se √© a primeira vez que seleciona uma conveni√™ncia
    const totalSelecionadas = Object.values(convenienciasSelecionadas).filter(Boolean).length;
    
    if (totalSelecionadas === 1 &amp;&amp; enderecoAtual) {
      showTemporaryMessage('üìç Pontos limitados a 8km de raio do endere√ßo principal', 'success', 3000);
    }
    
    gerarPontosConveniencia();
  } else {
    removerPontosConveniencia(tipo);
  }
}

// Fun√ß√£o para gerar pontos de conveni√™ncia
function gerarPontosConveniencia() {
  if (!enderecoAtual) return;
  
  // Verifica√ß√£o de seguran√ßa
  if (typeof L === 'undefined' || !map) {
    console.warn('‚ö†Ô∏è Mapa n√£o dispon√≠vel para gerar pontos de conveni√™ncia');
    return;
  }
  
  try {
    // Remove pontos anteriores
    pontosConveniencia.forEach(ponto =&gt; map.removeLayer(ponto));
    pontosConveniencia = [];
    
    const { lat, lng } = enderecoAtual;
    
    // LIMITE M√ÅXIMO DE 8KM para todos os pontos de conveni√™ncia
    const RAIO_MAXIMO_CONVENIENCIA = 8000; // 8km em metros
    
    // Para cada tipo de conveni√™ncia selecionada
    Object.keys(convenienciasSelecionadas).forEach(tipo =&gt; {
      if (convenienciasSelecionadas[tipo]) {
        const cor = convenienceColors[tipo];
        const quantidade = getQuantidadePorTipo(tipo, raioAtivo);
        
        // Gera pontos aleat√≥rios dentro do raio M√ÅXIMO de 8km
        for (let i = 0; i &lt; quantidade; i++) {
          const angulo = Math.random() * 2 * Math.PI;
          const distancia = Math.random() * RAIO_MAXIMO_CONVENIENCIA; // Sempre limitado a 8km
          
          // Converte para coordenadas
          const deltaLat = (distancia * Math.cos(angulo)) / 111320;
          const deltaLng = (distancia * Math.sin(angulo)) / (111320 * Math.cos(lat * Math.PI / 180));
          
          const pontoLat = lat + deltaLat;
          const pontoLng = lng + deltaLng;
          
          // Cria marcador
          const marcador = L.circleMarker([pontoLat, pontoLng], {
            color: 'white',
            fillColor: cor,
            fillOpacity: 0.8,
            radius: 6,
            weight: 2
          }).addTo(map);
          
          // Calcula dist√¢ncia real para exibir no popup
          const distanciaReal = Math.round(distancia / 1000 * 100) / 100; // Em km com 2 casas decimais
          
          marcador.bindPopup(`
            &lt;div style=&quot;text-align: center;&quot;&gt;
              &lt;b&gt;${getNomeConveniencia(tipo)}&lt;/b&gt;&lt;br&gt;
              &lt;small style=&quot;color: #666;&quot;&gt;Ponto ${i + 1}&lt;/small&gt;&lt;br&gt;
              &lt;small style=&quot;color: #2ECC71; font-weight: 600;&quot;&gt;${distanciaReal}km de dist√¢ncia&lt;/small&gt;
            &lt;/div&gt;
          `);
          pontosConveniencia.push(marcador);
        }
      }
    });
    
    console.log(`‚úÖ ${pontosConveniencia.length} pontos de conveni√™ncia gerados (limitados a 8km)`);
    
  } catch (error) {
    console.error('‚ùå Erro ao gerar pontos de conveni√™ncia:', error);
  }
}

// Fun√ß√£o para remover pontos de conveni√™ncia de um tipo espec√≠fico
function removerPontosConveniencia(tipo) {
  // Esta fun√ß√£o pode ser melhorada para remover apenas pontos de um tipo espec√≠fico
  // Por simplicidade, regenera todos os pontos
  gerarPontosConveniencia();
}

// Fun√ß√£o para analisar conveni√™ncias baseada no endere√ßo principal
function analisarConvenienciasPorEndereco(endereco, subtitulo) {
  // Sistema de an√°lise inteligente baseado no endere√ßo
  let multiplicadorBase = 1;
  let bonusUrbano = 0;
  let bonusComercial = 0;
  
  // An√°lise da regi√£o baseada no endere√ßo
  const enderecoAnalise = endereco + ' ' + subtitulo;
  
  // Verifica se √© √°rea central/comercial
  if (enderecoAnalise.includes('centro') || enderecoAnalise.includes('comercial') || 
      enderecoAnalise.includes('aldeota') || enderecoAnalise.includes('meireles') ||
      enderecoAnalise.includes('coc√≥') || enderecoAnalise.includes('centro de fortaleza')) {
    multiplicadorBase = 1.8;
    bonusComercial = 0.5;
    console.log('üìç √Årea central/comercial detectada - maior concentra√ß√£o de servi√ßos');
  }
  
  // Verifica se √© √°rea residencial premium
  else if (enderecoAnalise.includes('aldeota') || enderecoAnalise.includes('meireles') ||
           enderecoAnalise.includes('coc√≥') || enderecoAnalise.includes('papicu') ||
           enderecoAnalise.includes('praia') || enderecoAnalise.includes('beira mar')) {
    multiplicadorBase = 1.4;
    bonusUrbano = 0.3;
    console.log('üè† √Årea residencial premium detectada - boa infraestrutura');
  }
  
  // Verifica se √© √°rea em desenvolvimento
  else if (enderecoAnalise.includes('maracana√∫') || enderecoAnalise.includes('caucaia') ||
           enderecoAnalise.includes('messejana') || enderecoAnalise.includes('conjunto')) {
    multiplicadorBase = 0.8;
    console.log('üèóÔ∏è √Årea em desenvolvimento detectada - menor densidade de servi√ßos');
  }
  
  // Verifica se √© √°rea perif√©rica
  else if (enderecoAnalise.includes('periferia') || enderecoAnalise.includes('s√≠tio') ||
           enderecoAnalise.includes('vila') || enderecoAnalise.includes('conjunto cear√°')) {
    multiplicadorBase = 0.6;
    console.log('üåÜ √Årea perif√©rica detectada - menor concentra√ß√£o de servi√ßos');
  }
  
  // Dados base que ser√£o modificados pelo multiplicador
  const dadosBase = {
    2: {
      escolaIdiomas: 2, escolaPublica: 4, escolaPrivada: 1, hospitais: 1, farmacias: 6,
      clinicas: 3, bares: 8, restaurantes: 12, hipermercados: 1, supermercados: 4,
      bancos: 3, lotericas: 2, postoSaude: 1, postoCombustivel: 2, pracasPublicas: 3
    },
    5: {
      escolaIdiomas: 6, escolaPublica: 10, escolaPrivada: 5, hospitais: 2, farmacias: 15,
      clinicas: 8, bares: 22, restaurantes: 28, hipermercados: 2, supermercados: 11,
      bancos: 7, lotericas: 5, postoSaude: 3, postoCombustivel: 6, pracasPublicas: 9
    },
    8: {
      escolaIdiomas: 12, escolaPublica: 20, escolaPrivada: 14, hospitais: 6, farmacias: 28,
      clinicas: 18, bares: 45, restaurantes: 55, hipermercados: 4, supermercados: 22,
      bancos: 13, lotericas: 12, postoSaude: 8, postoCombustivel: 12, pracasPublicas: 18
    }
  };
  
  // Aplica multiplicadores espec√≠ficos por tipo de servi√ßo
  const resultado = {};
  
  [2, 5, 8].forEach(raio =&gt; {
    resultado[raio] = {};
    
    Object.keys(dadosBase[raio]).forEach(tipo =&gt; {
      let valor = dadosBase[raio][tipo] * multiplicadorBase;
      
      // B√¥nus espec√≠ficos por tipo
      if (['restaurantes', 'bares', 'bancos', 'farmacias'].includes(tipo)) {
        valor += bonusComercial * dadosBase[raio][tipo];
      }
      
      if (['escolaPrivada', 'clinicas', 'hipermercados'].includes(tipo)) {
        valor += bonusUrbano * dadosBase[raio][tipo];
      }
      
      // Garante valores m√≠nimos realistas
      resultado[raio][tipo] = Math.max(1, Math.round(valor));
    });
  });
  
  console.log(`üîç An√°lise conclu√≠da para: ${endereco} (multiplicador: ${multiplicadorBase})`);
  return resultado;
}

// Fun√ß√£o para destacar pontos no mapa baseado no tipo
function destacarPontosNoMapa(tipo) {
  if (!map || !enderecoAtual) {
    showTemporaryMessage('‚ö†Ô∏è Primeiro selecione um endere√ßo principal', 'error', 2000);
    return;
  }
  
  // Verifica se o tipo est√° selecionado
  if (!convenienciasSelecionadas[tipo]) {
    showTemporaryMessage(`üìå Primeiro marque &quot;${getNomeConveniencia(tipo)}&quot; na lista de conveni√™ncias`, 'error', 3000);
    return;
  }
  
  // Remove destaque anterior
  removerDestaquePontos();
  
  // Encontra e destaca pontos do tipo espec√≠fico
  const cor = convenienceColors[tipo];
  let pontosEncontrados = 0;
  
  pontosConveniencia.forEach((ponto, index) =&gt; {
    if (ponto.options &amp;&amp; ponto.options.fillColor === cor) {
      // Destaca o ponto
      ponto.setStyle({
        radius: 10,
        weight: 4,
        color: '#FFD700', // Borda dourada
        fillOpacity: 1,
        className: 'destaque-ponto'
      });
      
      // Adiciona anima√ß√£o pulsante
      setTimeout(() =&gt; {
        if (ponto._path) {
          ponto._path.style.animation = 'pulse 1.5s infinite';
        }
      }, 100);
      
      pontosEncontrados++;
    }
  });
  
  if (pontosEncontrados &gt; 0) {
    showTemporaryMessage(`üéØ ${pontosEncontrados} pontos de &quot;${getNomeConveniencia(tipo)}&quot; destacados no mapa`, 'success', 3000);
    
    // Remove destaque ap√≥s 5 segundos
    setTimeout(() =&gt; {
      removerDestaquePontos();
    }, 5000);
  } else {
    showTemporaryMessage(`üìç Nenhum ponto de &quot;${getNomeConveniencia(tipo)}&quot; encontrado no mapa`, 'error', 2000);
  }
  
  // Destaca a linha na tabela
  destacarLinhaTabela(tipo);
}

// Fun√ß√£o para remover destaque dos pontos
function removerDestaquePontos() {
  pontosConveniencia.forEach(ponto =&gt; {
    if (ponto.options) {
      ponto.setStyle({
        radius: 6,
        weight: 2,
        color: 'white',
        fillOpacity: 0.8
      });
      
      // Remove anima√ß√£o
      if (ponto._path) {
        ponto._path.style.animation = '';
      }
    }
  });
}

// Fun√ß√£o para destacar linha na tabela
function destacarLinhaTabela(tipo) {
  // Remove destaque anterior
  document.querySelectorAll('.interactive-row').forEach(row =&gt; {
    row.classList.remove('linha-destacada');
  });
  
  // Adiciona destaque √† linha atual
  const linha = document.querySelector(`[data-tipo=&quot;${tipo}&quot;]`);
  if (linha) {
    linha.classList.add('linha-destacada');
    
    // Remove destaque ap√≥s 3 segundos
    setTimeout(() =&gt; {
      linha.classList.remove('linha-destacada');
    }, 3000);
  }
}

// Fun√ß√£o para obter quantidade por tipo e raio (atualizada para usar an√°lise din√¢mica)
function getQuantidadePorTipo(tipo, raio) {
  if (!enderecoAtual) return 0;
  
  const enderecoPrincipal = enderecoAtual.endereco.toLowerCase();
  const subtitulo = enderecoAtual.subtitulo?.toLowerCase() || '';
  const analise = analisarConvenienciasPorEndereco(enderecoPrincipal, subtitulo);
  
  return analise[raio]?.[tipo] || 0;
}

// Fun√ß√£o para obter nome da conveni√™ncia
function getNomeConveniencia(tipo) {
  const nomes = {
    escolaIdiomas: 'Escola de Idiomas',
    escolaPublica: 'Escola P√∫blica',
    escolaPrivada: 'Escola Privada',
    hospitais: 'Hospital',
    farmacias: 'Farm√°cia',
    clinicas: 'Cl√≠nica Odontol√≥gica',
    bares: 'Bar',
    restaurantes: 'Restaurante',
    hipermercados: 'Hipermercado',
    supermercados: 'Supermercado',
    bancos: 'Ag√™ncia Banc√°ria',
    lotericas: 'Lot√©rica',
    postoSaude: 'Posto de Sa√∫de',
    postoCombustivel: 'Posto de Combust√≠vel',
    pracasPublicas: 'Pra√ßa P√∫blica'
  };
  
  return nomes[tipo] || tipo;
}

// Fun√ß√£o para salvar an√°lise
function salvarAnalise() {
  if (!enderecoAtual) {
    alert('Primeiro selecione um endere√ßo principal.');
    return;
  }
  
  const analise = {
    enderecoPrincipal: enderecoAtual,
    pontosInteresse: pontosInteresse,
    convenienciasSelecionadas: convenienciasSelecionadas,
    raioAtivo: raioAtivo,
    timestamp: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(analise, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `analise-mercadologica-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  URL.revokeObjectURL(url);
  
  alert('An√°lise salva com sucesso!');
}

// Fun√ß√£o para inicializar o gr√°fico de concentra√ß√£o populacional
function initPopulationChart() {
  const ctx = document.getElementById('populationChart').getContext('2d');
  
  populationChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['√Årea Norte', 'Centro Comercial', '√Årea Sul', '√Årea Oeste'],
      datasets: [{
        label: 'Densidade Populacional (hab/km¬≤)',
        data: [8500, 12800, 6200, 7100],
        backgroundColor: [
          'rgba(142, 68, 173, 0.8)',
          'rgba(52, 152, 219, 0.8)',
          'rgba(46, 204, 113, 0.8)',
          'rgba(241, 196, 15, 0.8)'
        ],
        borderColor: [
          'rgba(142, 68, 173, 1)',
          'rgba(52, 152, 219, 1)',
          'rgba(46, 204, 113, 1)',
          'rgba(241, 196, 15, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Concentra√ß√£o Populacional por √Årea - Raio 2km',
          font: {
            size: 16,
            weight: 'bold'
          },
          color: '#8E44AD'
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Densidade (hab/km¬≤)',
            font: {
              weight: 'bold'
            }
          }
        },
        x: {
          title: {
            display: true,
            text: '√Åreas de Concentra√ß√£o',
            font: {
              weight: 'bold'
            }
          }
        }
      }
    }
  });
}

// Fun√ß√£o para atualizar o gr√°fico de concentra√ß√£o populacional
function updatePopulationChart() {
  if (!populationChart) return;
  
  const data = populationData[currentPopulationRadius];
  if (data) {
    populationChart.data.datasets[0].data = [data.north, data.center, data.south, data.west];
    populationChart.options.plugins.title.text = `Concentra√ß√£o Populacional por √Årea - Raio ${currentPopulationRadius}km`;
    populationChart.update();
  }
}

// Dados dos concorrentes (carregados do JSON ou Excel)
let concurrentesData = null;

// Fun√ß√£o para processar arquivo Excel
async function processExcelFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const statusDiv = document.getElementById('upload-status');
  statusDiv.innerHTML = '&lt;div class=&quot;upload-status-info&quot;&gt;üì§ Processando arquivo...&lt;/div&gt;';

  try {
    const arrayBuffer = await file.arrayBuffer();
    
    // Configura√ß√£o espec√≠fica para manter dados como texto
    const workbook = XLSX.read(arrayBuffer, { 
      type: 'array',
      cellDates: false,     // NUNCA converte para objeto Date
      cellNF: false,        // N√£o aplica formata√ß√£o num√©rica
      cellText: true,       // For√ßa convers√£o para texto
      raw: true,            // L√™ valores brutos das c√©lulas
      dateNF: false         // N√£o formata datas
    });
    
    // Pega a primeira planilha
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];
    
    // Convers√£o manual c√©lula por c√©lula para manter formato original
    const range = XLSX.utils.decode_range(worksheet['!ref']);
    const headers = [];
    
    // L√™ cabe√ßalhos (primeira linha)
    for (let C = range.s.c; C &lt;= range.e.c; ++C) {
      const cellAddress = XLSX.utils.encode_cell({ c: C, r: range.s.r });
      const cell = worksheet[cellAddress];
      headers.push(cell ? String(cell.v) : '');
    }
    
    console.log('üìã Cabe√ßalhos encontrados:', headers);
    
    const jsonData = [];
    
    // L√™ cada linha mantendo formato original
    for (let R = range.s.r + 1; R &lt;= range.e.r; ++R) {
      const row = {};
      for (let C = range.s.c; C &lt;= range.e.c; ++C) {
        const cellAddress = XLSX.utils.encode_cell({ c: C, r: R });
        const cell = worksheet[cellAddress];
        const header = headers[C - range.s.c];
        
        if (cell &amp;&amp; cell.v !== undefined) {
          // For√ßa convers√£o para string para manter formato original
          row[header] = String(cell.v);
        } else {
          row[header] = '';
        }
      }
      
      // S√≥ adiciona linhas que n√£o est√£o completamente vazias
      if (Object.values(row).some(val =&gt; val !== '')) {
        jsonData.push(row);
      }
    }
    
    if (jsonData.length === 0) {
      throw new Error('Planilha vazia ou sem dados v√°lidos');
    }

    console.log('üìã Primeiros dados lidos (raw):', jsonData.slice(0, 2));

    // Mostra progresso durante processamento
    statusDiv.innerHTML = `&lt;div class=&quot;upload-status-info&quot;&gt;‚öôÔ∏è Processando ${jsonData.length} empreendimentos...&lt;/div&gt;`;
    
    // Processa os dados e calcula estat√≠sticas - TODAS as linhas
    const processedData = processCompetitorData(jsonData);
    concurrentesData = processedData;

    // Atualiza dashboard com todos os dados
    updateGeneralStats();
    loadConcurrentesTable();
    
    // Reinicializa gr√°ficos para suportar qualquer quantidade de dados
    destroyExistingCharts();
    initCurvaVendasChart();
    initAreasLazerChart();
    initVendaMensalChart();

    statusDiv.innerHTML = `&lt;div class=&quot;upload-status-success&quot;&gt;‚úÖ ${jsonData.length} empreendimentos carregados com sucesso!&lt;/div&gt;`;
    setTimeout(() =&gt; {
      statusDiv.innerHTML = '';
    }, 4000);

  } catch (error) {
    console.error('Erro ao processar Excel:', error);
    statusDiv.innerHTML = '&lt;div class=&quot;upload-status-error&quot;&gt;‚ùå Erro ao processar arquivo. Verifique o formato dos dados.&lt;/div&gt;';
    setTimeout(() =&gt; {
      statusDiv.innerHTML = '';
    }, 5000);
  }
}

// Fun√ß√£o para destruir gr√°ficos existentes antes de recriar
function destroyExistingCharts() {
  // Destroi gr√°ficos existentes para evitar conflitos
  Chart.getChart('curvaVendasChart')?.destroy();
  Chart.getChart('areasLazerChart')?.destroy();
  Chart.getChart('vendaMensalChart')?.destroy();
}

// Fun√ß√£o para processar dados dos concorrentes
function processCompetitorData(rawData) {
  console.log(`Processando ${rawData.length} empreendimentos...`);
  
  const empreendimentos = rawData.map((item, index) =&gt; {
    // Log de progresso para muitos dados
    if (index % 20 === 0 &amp;&amp; rawData.length &gt; 50) {
      console.log(`Processando linha ${index + 1} de ${rawData.length}`);
    }
    
    // Calcula percentual de vendas automaticamente
    const qtdUnidades = parseInt(item.QTD_UNIDADES || item.Unidades || item['Qtd Unidades'] || 0);
    const unidadesVendidas = parseInt(item.UNIDADES_VENDIDAS || item.Vendidas || item['Unidades Vendidas'] || 0);
    const percentualVendas = qtdUnidades &gt; 0 ? 
      ((unidadesVendidas) / qtdUnidades * 100) : 0;

    // Obt√©m pre√ßo de venda sem convers√£o desnecess√°ria - m√∫ltiplas varia√ß√µes de nomes
    const precoVenda = parseFloat(
      item.PRECO_VENDA || 
      item['PRE√áO_VENDA'] ||
      item['PRECO_VENDA'] ||
      item.Pre√ßo || 
      item.Preco || 
      item['Pre√ßo Venda'] || 
      item['Preco Venda'] ||
      item.preco || 
      item['Pre√ßo de Venda'] ||
      item['Preco de Venda'] ||
      item['PRE√áO DE VENDA'] ||
      item['Valor'] ||
      item['VALOR'] ||
      item['Pre√ßo Unit√°rio'] ||
      item['Pre√ßo por Unidade'] ||
      0
    );

    // Mant√©m datas EXATAMENTE como est√£o na planilha - m√∫ltiplas varia√ß√µes de nomes
    const dataLancamento = String(item.DATA_LANCAMENTO || 
                          item['DATA_LANCAMENTO'] ||
                          item['Data Lan√ßamento'] || 
                          item['Data de Lan√ßamento'] ||
                          item['DATA DE LANCAMENTO'] ||
                          item['Lan√ßamento'] ||
                          item['LANCAMENTO'] ||
                          item['Data Inicio'] ||
                          'N√£o informado');
                          
    const dataEntrega = String(item.DATA_ENTREGA || 
                       item['DATA_ENTREGA'] ||
                       item['Data Entrega'] || 
                       item['Data de Entrega'] ||
                       item['DATA DE ENTREGA'] ||
                       item['Entrega'] ||
                       item['ENTREGA'] ||
                       item['Data Fim'] ||
                       'N√£o informado');
    
    // Log espec√≠fico das datas para debug (apenas primeiros 3)
    if (index &lt; 3) {
      console.log(`üìÖ Empreendimento ${index + 1} - Lan√ßamento: &quot;${dataLancamento}&quot;, Entrega: &quot;${dataEntrega}&quot;`);
    }
    
    // Calcula vendas m√©dia mensal apenas se data de lan√ßamento for v√°lida
    let vendasMediaMensal = 0;
    try {
      if (dataLancamento !== 'N√£o informado' &amp;&amp; dataLancamento.length &gt; 0) {
        // Tenta converter diferentes formatos de data para c√°lculo
        let dataConvertida;
        if (dataLancamento.includes('/')) {
          // Formato JAN/2024, DEZ/2023, etc.
          const [mes, ano] = dataLancamento.split('/');
          const meses = { 'JAN': 0, 'FEV': 1, 'MAR': 2, 'ABR': 3, 'MAI': 4, 'JUN': 5,
                          'JUL': 6, 'AGO': 7, 'SET': 8, 'OUT': 9, 'NOV': 10, 'DEZ': 11 };
          if (meses[mes] !== undefined &amp;&amp; ano) {
            dataConvertida = new Date(parseInt(ano), meses[mes], 1);
          }
        } else {
          // Outros formatos
          dataConvertida = new Date(dataLancamento);
        }
        
        if (dataConvertida &amp;&amp; !isNaN(dataConvertida.getTime())) {
          const agora = new Date();
          const mesesDecorridos = Math.max(1, (agora - dataConvertida) / (1000 * 60 * 60 * 24 * 30));
          vendasMediaMensal = unidadesVendidas / mesesDecorridos;
        }
      }
    } catch (error) {
      console.log(`Erro ao calcular vendas mensais para ${item.EMPREENDIMENTO}: ${error.message}`);
    }

    // Suporte para diferentes nomes de colunas
    return {
      EMPREENDIMENTO: String(item.EMPREENDIMENTO || item.Nome || item.Empreendimento || item.nome || `Empreendimento ${index + 1}`),
      CONSTRUTORA: String(item.CONSTRUTORA || item.Construtora || item.construtora || 'N√£o informado'),
      DATA_LANCAMENTO: dataLancamento, // Mant√©m EXATAMENTE como string
      DATA_ENTREGA: dataEntrega, // Mant√©m EXATAMENTE como string
      QTD_UNIDADES: qtdUnidades,
      UNIDADES_VENDIDAS: unidadesVendidas,
      PERCENTUAL_VENDAS: parseFloat(percentualVendas.toFixed(2)),
      PRECO_VENDA: precoVenda, // Mant√©m valor original
      TOTAL_AREAS_LAZER: parseInt(item.TOTAL_AREAS_LAZER || item['√Åreas Lazer'] || item['Areas Lazer'] || item.areas_lazer || 0),
      VENDAS_MEDIA_MENSAL: parseFloat(vendasMediaMensal.toFixed(2))
    };
  });

  console.log(`‚úÖ ${empreendimentos.length} empreendimentos processados com sucesso`);

  // Calcula estat√≠sticas gerais de TODOS os empreendimentos
  const totalEmpreendimentos = empreendimentos.length;
  const totalUnidades = empreendimentos.reduce((sum, emp) =&gt; sum + emp.QTD_UNIDADES, 0);
  const totalVendas = empreendimentos.reduce((sum, emp) =&gt; sum + emp.UNIDADES_VENDIDAS, 0);
  const percentualVendasGeral = totalUnidades &gt; 0 ? (totalVendas / totalUnidades * 100) : 0;
  
  // Calcula pre√ßo m√©dio considerando apenas empreendimentos com pre√ßo &gt; 0
  const empreendimentosComPreco = empreendimentos.filter(emp =&gt; emp.PRECO_VENDA &gt; 0);
  const precoMedioMercado = empreendimentosComPreco.length &gt; 0 ? 
    empreendimentosComPreco.reduce((sum, emp) =&gt; sum + emp.PRECO_VENDA, 0) / empreendimentosComPreco.length : 0;

  // Calcula TAM, SAM, SOM
  const tam = totalUnidades * precoMedioMercado;
  const sam = tam * 0.7; // 70% do TAM
  const som = sam * 0.15; // 15% do SAM

  console.log(`üí∞ Pre√ßo m√©dio calculado: R$ ${precoMedioMercado.toLocaleString('pt-BR')}`);

  return {
    resumo_mercado: {
      total_empreendimentos: totalEmpreendimentos,
      total_unidades: totalUnidades,
      total_vendas: totalVendas,
      percentual_vendas_geral: parseFloat(percentualVendasGeral.toFixed(2)),
      preco_medio_mercado: precoMedioMercado,
      tam: tam,
      sam: sam,
      som: som
    },
    empreendimentos: empreendimentos
  };
}

// Fun√ß√£o para formatar data
function formatDate(dateValue) {
  if (!dateValue) return 'N√£o informado';
  
  try {
    const date = new Date(dateValue);
    if (isNaN(date.getTime())) return 'Data inv√°lida';
    
    const months = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN',
                   'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
    
    return `${months[date.getMonth()]}/${date.getFullYear()}`;
  } catch (error) {
    return 'Data inv√°lida';
  }
}

// Fun√ß√£o para carregar dados dos concorrentes (dados padr√£o)
async function loadConcurrentesData() {
  try {
    // Dados padr√£o quando n√£o h√° upload de Excel
    concurrentesData = {
      &quot;resumo_mercado&quot;: {
        &quot;total_empreendimentos&quot;: 9,
        &quot;total_unidades&quot;: 3477,
        &quot;total_vendas&quot;: 1961,
        &quot;percentual_vendas_geral&quot;: 56.41,
        &quot;preco_medio_mercado&quot;: 220000,
        &quot;tam&quot;: 764940000,
        &quot;sam&quot;: 431420000,
        &quot;som&quot;: 243364022,
      },
      &quot;empreendimentos&quot;: [
        {
          &quot;EMPREENDIMENTO&quot;: &quot;VIT√ìRIA AC√ÅCIA&quot;,
          &quot;CONSTRUTORA&quot;: &quot;VICTA&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;DEZ/2024&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;JUN/2027&quot;,
          &quot;QTD_UNIDADES&quot;: 280,
          &quot;UNIDADES_VENDIDAS&quot;: 249,
          &quot;PERCENTUAL_VENDAS&quot;: 88.93,
          &quot;PRECO_VENDA&quot;: 216882,
          &quot;TOTAL_AREAS_LAZER&quot;: 14,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 31.12
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;VIT√ìRIA EUS√âBIO&quot;,
          &quot;CONSTRUTORA&quot;: &quot;VICTA&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;JUN/2025&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;JUN/2028&quot;,
          &quot;QTD_UNIDADES&quot;: 592,
          &quot;UNIDADES_VENDIDAS&quot;: 86,
          &quot;PERCENTUAL_VENDAS&quot;: 14.53,
          &quot;PRECO_VENDA&quot;: 206050,
          &quot;TOTAL_AREAS_LAZER&quot;: 12,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 43.00
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;GRAN VILLAGE EUS√âBIO&quot;,
          &quot;CONSTRUTORA&quot;: &quot;CANOPUS&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;DEZ/2022&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;NOV/2026&quot;,
          &quot;QTD_UNIDADES&quot;: 920,
          &quot;UNIDADES_VENDIDAS&quot;: 776,
          &quot;PERCENTUAL_VENDAS&quot;: 84.35,
          &quot;PRECO_VENDA&quot;: 240600,
          &quot;TOTAL_AREAS_LAZER&quot;: 9,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 13.28
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;RESERVA DAS GAR√áAS&quot;,
          &quot;CONSTRUTORA&quot;: &quot;TENDA&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;JAN/2025&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;FEV/2027&quot;,
          &quot;QTD_UNIDADES&quot;: 345,
          &quot;UNIDADES_VENDIDAS&quot;: 227,
          &quot;PERCENTUAL_VENDAS&quot;: 65.80,
          &quot;PRECO_VENDA&quot;: 201052,
          &quot;TOTAL_AREAS_LAZER&quot;: 10,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 56.75
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;GRAN VILLAGE MARACANA√ö&quot;,
          &quot;CONSTRUTORA&quot;: &quot;CANOPUS&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;NOV/2023&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;DEZ/2026&quot;,
          &quot;QTD_UNIDADES&quot;: 1000,
          &quot;UNIDADES_VENDIDAS&quot;: 690,
          &quot;PERCENTUAL_VENDAS&quot;: 69.00,
          &quot;PRECO_VENDA&quot;: 214960,
          &quot;TOTAL_AREAS_LAZER&quot;: 8,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 46.00
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;VIVA VIDA SIQUEIRA&quot;,
          &quot;CONSTRUTORA&quot;: &quot;DIRECIONAL&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;JUL/2024&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;SET/2026&quot;,
          &quot;QTD_UNIDADES&quot;: 340,
          &quot;UNIDADES_VENDIDAS&quot;: 204,
          &quot;PERCENTUAL_VENDAS&quot;: 60.00,
          &quot;PRECO_VENDA&quot;: 215261,
          &quot;TOTAL_AREAS_LAZER&quot;: 9,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 40.80
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;LA SERENA&quot;,
          &quot;CONSTRUTORA&quot;: &quot;MRV&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;MAI/2025&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;ABR/2028&quot;,
          &quot;QTD_UNIDADES&quot;: 240,
          &quot;UNIDADES_VENDIDAS&quot;: 54,
          &quot;PERCENTUAL_VENDAS&quot;: 22.50,
          &quot;PRECO_VENDA&quot;: 229527,
          &quot;TOTAL_AREAS_LAZER&quot;: 7,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 18.00
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;VIVA VIDA COQUEIROS&quot;,
          &quot;CONSTRUTORA&quot;: &quot;DIRECIONAL&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;JUL/2025&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;JUN/2028&quot;,
          &quot;QTD_UNIDADES&quot;: 260,
          &quot;UNIDADES_VENDIDAS&quot;: 10,
          &quot;PERCENTUAL_VENDAS&quot;: 3.80,
          &quot;PRECO_VENDA&quot;: 212657,
          &quot;TOTAL_AREAS_LAZER&quot;: 10,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 10.00
        },
        {
          &quot;EMPREENDIMENTO&quot;: &quot;VILLE DE PORTO&quot;,
          &quot;CONSTRUTORA&quot;: &quot;MRV&quot;,
          &quot;DATA_LANCAMENTO&quot;: &quot;ABR/2025&quot;,
          &quot;DATA_ENTREGA&quot;: &quot;MAR/2028&quot;,
          &quot;QTD_UNIDADES&quot;: 320,
          &quot;UNIDADES_VENDIDAS&quot;: 153,
          &quot;PERCENTUAL_VENDAS&quot;: 48.00,
          &quot;PRECO_VENDA&quot;: 242846,
          &quot;TOTAL_AREAS_LAZER&quot;: 9,
          &quot;VENDAS_MEDIA_MENSAL&quot;: 38.00
        }
      ]
    };
    
    // Atualizar estat√≠sticas gerais
    updateGeneralStats();
    
    // Carregar tabela de concorrentes
    loadConcurrentesTable();
    
    // Inicializar gr√°ficos
    initCurvaVendasChart();
    initAreasLazerChart();
    initVendaMensalChart();
    
  } catch (error) {
    console.error('Erro ao carregar dados dos concorrentes:', error);
  }
}

// Fun√ß√£o para baixar planilha padr√£o
function downloadTemplate() {
  // Dados de exemplo para a planilha padr√£o com mais varia√ß√µes
  const templateData = [
    {
      'EMPREENDIMENTO': 'Residencial Exemplo Alpha',
      'CONSTRUTORA': 'Construtora ABC Ltda',
      'DATA_LANCAMENTO': 'JAN/2024',
      'DATA_ENTREGA': 'DEZ/2026',
      'QTD_UNIDADES': 300,
      'UNIDADES_VENDIDAS': 180,
      'PRECO_VENDA': 220000,
      'TOTAL_AREAS_LAZER': 12
    },
    {
      'EMPREENDIMENTO': 'Condom√≠nio Exemplo Beta',
      'CONSTRUTORA': 'Construtora XYZ S.A.',
      'DATA_LANCAMENTO': 'MAR/2024',
      'DATA_ENTREGA': 'JAN/2027',
      'QTD_UNIDADES': 450,
      'UNIDADES_VENDIDAS': 200,
      'PRECO_VENDA': 195000,
      'TOTAL_AREAS_LAZER': 8
    },
    {
      'EMPREENDIMENTO': 'Villa Exemplo Gamma',
      'CONSTRUTORA': 'Construtora DEF Incorpora√ß√µes',
      'DATA_LANCAMENTO': 'NOV/2023',
      'DATA_ENTREGA': 'AGO/2026',
      'QTD_UNIDADES': 280,
      'UNIDADES_VENDIDAS': 250,
      'PRECO_VENDA': 240000,
      'TOTAL_AREAS_LAZER': 15
    },
    {
      'EMPREENDIMENTO': 'Residencial Exemplo Delta',
      'CONSTRUTORA': 'Construtora GHI Ltda',
      'DATA_LANCAMENTO': 'FEV/2024',
      'DATA_ENTREGA': 'SET/2026',
      'QTD_UNIDADES': 200,
      'UNIDADES_VENDIDAS': 120,
      'PRECO_VENDA': 180000,
      'TOTAL_AREAS_LAZER': 10
    },
    {
      'EMPREENDIMENTO': 'Condom√≠nio Exemplo Epsilon',
      'CONSTRUTORA': 'Construtora JKL S.A.',
      'DATA_LANCAMENTO': 'ABR/2024',
      'DATA_ENTREGA': 'MAR/2027',
      'QTD_UNIDADES': 350,
      'UNIDADES_VENDIDAS': 280,
      'PRECO_VENDA': 260000,
      'TOTAL_AREAS_LAZER': 18
    }
  ];

  // Cria workbook
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(templateData);
  
  // Define largura das colunas
  const colWidths = [
    {wch: 25}, // EMPREENDIMENTO
    {wch: 20}, // CONSTRUTORA
    {wch: 15}, // DATA_LANCAMENTO
    {wch: 15}, // DATA_ENTREGA
    {wch: 12}, // QTD_UNIDADES
    {wch: 15}, // UNIDADES_VENDIDAS
    {wch: 12}, // PRECO_VENDA
    {wch: 15}  // TOTAL_AREAS_LAZER
  ];
  ws['!cols'] = colWidths;

  // Adiciona a planilha ao workbook
  XLSX.utils.book_append_sheet(wb, ws, &quot;Dados_Concorrentes&quot;);

  // Baixa o arquivo
  XLSX.writeFile(wb, &quot;Planilha_Padrao_Concorrentes.xlsx&quot;);
  
  // Mostra mensagem de sucesso
  const statusDiv = document.getElementById('upload-status');
  statusDiv.innerHTML = '&lt;div class=&quot;upload-status-success&quot;&gt;üì• Planilha padr√£o com 5 exemplos baixada com sucesso!&lt;/div&gt;';
  setTimeout(() =&gt; {
    statusDiv.innerHTML = '';
  }, 3000);
}

// Fun√ß√£o para atualizar estat√≠sticas gerais
function updateGeneralStats() {
  if (!concurrentesData) return;
  
  const resumo = concurrentesData.resumo_mercado;
  
  document.getElementById('total-empreendimentos').textContent = resumo.total_empreendimentos;
  document.getElementById('total-unidades').textContent = resumo.total_unidades.toLocaleString('pt-BR');
  document.getElementById('total-vendas').textContent = resumo.total_vendas.toLocaleString('pt-BR');
  document.getElementById('percentual-vendas-geral').textContent = resumo.percentual_vendas_geral + '%';
  
  // Atualizar pre√ßo m√©dio do mercado - formata√ß√£o correta
  const precoMedioFormatado = resumo.preco_medio_mercado &gt; 0 ? 
    'R$ ' + Math.round(resumo.preco_medio_mercado).toLocaleString('pt-BR') : 
    'N√£o calculado';
  document.getElementById('preco-medio-mercado').textContent = precoMedioFormatado;
  
  // Atualizar valores TAM, SAM, SOM
  document.getElementById('tam-value').textContent = 'R$ ' + (resumo.tam / 1000000).toFixed(2) + 'M';
  document.getElementById('sam-value').textContent = 'R$ ' + (resumo.sam / 1000000).toFixed(2) + 'M';
  document.getElementById('som-value').textContent = 'R$ ' + (resumo.som / 1000000).toFixed(2) + 'M';
  
  // Atualizar pre√ßo recomendado baseado no pre√ßo m√©dio calculado
  const precoMedio = resumo.preco_medio_mercado;
  const precoMin = precoMedio * 0.95;
  const precoMax = precoMedio * 1.05;
  const precoRecomendadoFormatado = precoMedio &gt; 0 ? 
    `R$ ${Math.round(precoMin).toLocaleString('pt-BR')} - R$ ${Math.round(precoMax).toLocaleString('pt-BR')}` :
    'Carregue dados para calcular';
  document.getElementById('preco-recomendado').textContent = precoRecomendadoFormatado;

  // Atualizar pontos baseados nos dados
  updatePontosFortes();
  updatePontosAtencao();
  
  console.log(`üí∞ Pre√ßo m√©dio exibido: ${precoMedioFormatado}`);
}

// Fun√ß√£o para atualizar pontos fortes
function updatePontosFortes() {
  const resumo = concurrentesData.resumo_mercado;
  const pontosFortes = document.getElementById('pontos-fortes');
  
  let pontos = [
    `‚Ä¢ Mercado aquecido com ${resumo.percentual_vendas_geral}% de vendas`,
    `‚Ä¢ ${resumo.total_empreendimentos} empreendimentos ativos`,
    `‚Ä¢ Pre√ßo m√©dio: R$ ${Math.round(resumo.preco_medio_mercado).toLocaleString('pt-BR')}`,
    `‚Ä¢ ${resumo.total_unidades.toLocaleString('pt-BR')} unidades no mercado`
  ];
  
  pontosFortes.innerHTML = pontos.map(ponto =&gt; `&lt;li&gt;${ponto}&lt;/li&gt;`).join('');
}

// Fun√ß√£o para atualizar pontos de aten√ß√£o
function updatePontosAtencao() {
  const resumo = concurrentesData.resumo_mercado;
  const pontosAtencao = document.getElementById('pontos-atencao');
  
  let pontos = [
    `‚Ä¢ Concorr√™ncia de ${resumo.total_empreendimentos} empreendimentos`,
    '‚Ä¢ Necessidade de diferencia√ß√£o no mercado',
    '‚Ä¢ Press√£o por pre√ßos competitivos',
    '‚Ä¢ Import√¢ncia das √°reas de lazer'
  ];
  
  pontosAtencao.innerHTML = pontos.map(ponto =&gt; `&lt;li&gt;${ponto}&lt;/li&gt;`).join('');
}

// Fun√ß√£o para carregar tabela de concorrentes
function loadConcurrentesTable() {
  if (!concurrentesData) return;
  
  const tbody = document.getElementById('tabela-concorrentes');
  const tableInfo = document.getElementById('table-info');
  tbody.innerHTML = '';
  
  const empreendimentos = concurrentesData.empreendimentos;
  
  empreendimentos.forEach((emp, index) =&gt; {
    const statusClass = emp.PERCENTUAL_VENDAS &gt; 70 ? 'success' : emp.PERCENTUAL_VENDAS &gt; 50 ? 'warning' : 'danger';
    const statusText = emp.PERCENTUAL_VENDAS &gt; 70 ? 'Excelente' : emp.PERCENTUAL_VENDAS &gt; 50 ? 'Bom' : 'Baixo';
    
    // Formata pre√ßo apenas para exibi√ß√£o, mantendo valor original
    const precoFormatado = emp.PRECO_VENDA &gt; 0 ? 
      `R$ ${emp.PRECO_VENDA.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` : 
      'N√£o informado';
    
    const row = `
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;${emp.EMPREENDIMENTO}&lt;/strong&gt;&lt;/td&gt;
        &lt;td&gt;${emp.CONSTRUTORA}&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;badge bg-secondary&quot;&gt;${emp.DATA_LANCAMENTO}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;badge bg-primary&quot;&gt;${emp.DATA_ENTREGA}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;${emp.QTD_UNIDADES.toLocaleString('pt-BR')}&lt;/td&gt;
        &lt;td&gt;${emp.UNIDADES_VENDIDAS.toLocaleString('pt-BR')}&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;badge bg-${statusClass}&quot;&gt;${emp.PERCENTUAL_VENDAS}%&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;${precoFormatado}&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;badge bg-info&quot;&gt;${emp.TOTAL_AREAS_LAZER}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;badge bg-${statusClass}&quot;&gt;${statusText}&lt;/span&gt;&lt;/td&gt;
      &lt;/tr&gt;
    `;
    tbody.innerHTML += row;
  });
  
  // Atualiza informa√ß√µes da tabela
  tableInfo.textContent = `Exibindo ${empreendimentos.length} empreendimentos carregados`;
  
  console.log(`‚úÖ Tabela atualizada com ${empreendimentos.length} empreendimentos`);
  
  // Log de verifica√ß√£o de alguns pre√ßos para debug
  if (empreendimentos.length &gt; 0) {
    console.log('üîç Verifica√ß√£o de pre√ßos (primeiros 3 empreendimentos):');
    empreendimentos.slice(0, 3).forEach((emp, i) =&gt; {
      console.log(`${i+1}. ${emp.EMPREENDIMENTO}: R$ ${emp.PRECO_VENDA.toLocaleString('pt-BR')}`);
    });
  }
}

// Fun√ß√£o para inicializar gr√°fico de curva de vendas
function initCurvaVendasChart() {
  if (!concurrentesData) return;
  
  const ctx = document.getElementById('curvaVendasChart').getContext('2d');
  
  const empreendimentos = concurrentesData.empreendimentos;
  const labels = empreendimentos.map(emp =&gt; emp.EMPREENDIMENTO);
  const vendas = empreendimentos.map(emp =&gt; emp.PERCENTUAL_VENDAS);
  
  // Configura√ß√£o adaptativa para muitos dados
  const displayLabels = labels.length &gt; 15 ? false : true;
  const pointRadius = labels.length &gt; 50 ? 2 : 3;
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Percentual de Vendas (%)',
        data: vendas,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.4,
        fill: true,
        pointRadius: pointRadius,
        pointHoverRadius: pointRadius + 1,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: {
          top: 10,
          bottom: 10
        }
      },
      plugins: {
        title: {
          display: true,
          text: `Performance de Vendas - ${empreendimentos.length} Empreendimentos`,
          font: {
            size: 14,
            weight: 'bold'
          },
          padding: {
            bottom: 15
          }
        },
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            font: {
              size: 11
            },
            padding: 15
          }
        }
      },
      scales: {
        x: {
          display: displayLabels,
          title: {
            display: true,
            text: displayLabels ? 'Empreendimentos' : `${empreendimentos.length} Empreendimentos`,
            font: {
              size: 11,
              weight: 'bold'
            }
          },
          ticks: {
            display: displayLabels,
            maxRotation: labels.length &gt; 8 ? 45 : 0,
            font: {
              size: 10
            }
          },
          grid: {
            display: false
          }
        },
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Vendas (%)',
            font: {
              size: 11,
              weight: 'bold'
            }
          },
          ticks: {
            font: {
              size: 10
            }
          },
          grid: {
            color: 'rgba(0,0,0,0.1)'
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
  
  // Carregar top performers (m√°ximo 10 para n√£o sobrecarregar)
  loadTopPerformers();
}

// Fun√ß√£o para carregar top performers
function loadTopPerformers() {
  if (!concurrentesData) return;
  
  const topPerformers = concurrentesData.empreendimentos
    .sort((a, b) =&gt; b.PERCENTUAL_VENDAS - a.PERCENTUAL_VENDAS)
    .slice(0, 8); // Reduzido para 8 para melhor visualiza√ß√£o
  
  const container = document.getElementById('top-performers');
  container.innerHTML = '';
  
  topPerformers.forEach((emp, index) =&gt; {
    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
    const item = `
      &lt;div class=&quot;top-performer-item mb-2 p-2&quot; style=&quot;background: var(--light-bg); border-radius: 8px; font-size: 0.85rem; border-left: 3px solid var(--primary-color);&quot;&gt;
        &lt;div class=&quot;d-flex justify-content-between align-items-center&quot;&gt;
          &lt;div&gt;
            &lt;span style=&quot;font-weight: 600; color: var(--primary-color);&quot;&gt;${medal}&lt;/span&gt;
            &lt;span style=&quot;font-size: 0.8rem; margin-left: 5px;&quot;&gt;${emp.EMPREENDIMENTO.length &gt; 20 ? emp.EMPREENDIMENTO.substring(0, 20) + '...' : emp.EMPREENDIMENTO}&lt;/span&gt;
          &lt;/div&gt;
          &lt;span class=&quot;badge bg-success&quot; style=&quot;font-size: 0.75rem;&quot;&gt;${emp.PERCENTUAL_VENDAS}%&lt;/span&gt;
        &lt;/div&gt;
        &lt;small class=&quot;text-muted&quot; style=&quot;font-size: 0.7rem;&quot;&gt;${emp.CONSTRUTORA}&lt;/small&gt;
      &lt;/div&gt;
    `;
    container.innerHTML += item;
  });
  
  // Mostra quantidade total se houver mais que 8
  if (concurrentesData.empreendimentos.length &gt; 8) {
    container.innerHTML += `
      &lt;div class=&quot;text-center mt-2&quot;&gt;
        &lt;small class=&quot;text-muted&quot; style=&quot;font-size: 0.7rem;&quot;&gt;Top 8 de ${concurrentesData.empreendimentos.length} empreendimentos&lt;/small&gt;
      &lt;/div&gt;
    `;
  }
}

// Fun√ß√£o para inicializar gr√°fico de √°reas de lazer
function initAreasLazerChart() {
  if (!concurrentesData) return;
  
  const ctx = document.getElementById('areasLazerChart').getContext('2d');
  
  const empreendimentos = concurrentesData.empreendimentos;
  const labels = empreendimentos.map(emp =&gt; emp.EMPREENDIMENTO);
  const areasLazer = empreendimentos.map(emp =&gt; emp.TOTAL_AREAS_LAZER);
  
  // Configura√ß√£o adaptativa para muitos dados
  const displayLabels = labels.length &gt; 12 ? false : true;
  
  // Cores din√¢micas para muitos dados
  const colors = generateColors(labels.length);
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: '√Åreas de Lazer',
        data: areasLazer,
        backgroundColor: colors.background,
        borderColor: colors.border,
        borderWidth: 1.5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: {
          top: 10,
          bottom: 10
        }
      },
      plugins: {
        title: {
          display: true,
          text: `√Åreas de Lazer - ${empreendimentos.length} Empreendimentos`,
          font: {
            size: 14,
            weight: 'bold'
          },
          padding: {
            bottom: 15
          }
        },
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          display: displayLabels,
          title: {
            display: true,
            text: displayLabels ? 'Empreendimentos' : `${empreendimentos.length} Empreendimentos`,
            font: {
              size: 11,
              weight: 'bold'
            }
          },
          ticks: {
            display: displayLabels,
            maxRotation: labels.length &gt; 8 ? 45 : 0,
            font: {
              size: 10
            }
          },
          grid: {
            display: false
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Qtd √Åreas',
            font: {
              size: 11,
              weight: 'bold'
            }
          },
          ticks: {
            font: {
              size: 10
            },
            stepSize: 1
          },
          grid: {
            color: 'rgba(0,0,0,0.1)'
          }
        }
      }
    }
  });
  
  // Carregar ranking de √°reas de lazer
  loadAreasLazerRanking();
}

// Fun√ß√£o para gerar cores din√¢micas
function generateColors(count) {
  const baseColors = [
    'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 205, 86, 0.8)',
    'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
    'rgba(201, 203, 207, 0.8)', 'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)'
  ];
  
  const baseBorders = [
    'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 205, 86, 1)',
    'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
    'rgba(201, 203, 207, 1)', 'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)'
  ];
  
  const background = [];
  const border = [];
  
  for (let i = 0; i &lt; count; i++) {
    background.push(baseColors[i % baseColors.length]);
    border.push(baseBorders[i % baseBorders.length]);
  }
  
  return { background, border };
}

// Fun√ß√£o para carregar ranking de √°reas de lazer
function loadAreasLazerRanking() {
  if (!concurrentesData) return;
  
  const ranking = concurrentesData.empreendimentos
    .sort((a, b) =&gt; b.TOTAL_AREAS_LAZER - a.TOTAL_AREAS_LAZER)
    .slice(0, 10); // M√°ximo 10 para n√£o sobrecarregar
  
  const container = document.getElementById('ranking-areas-lazer');
  container.innerHTML = '';
  
  ranking.forEach((emp, index) =&gt; {
    const item = `
      &lt;div class=&quot;ranking-item mb-2 p-2&quot; style=&quot;background: var(--light-bg); border-radius: 8px;&quot;&gt;
        &lt;div class=&quot;d-flex justify-content-between align-items-center&quot;&gt;
          &lt;span style=&quot;font-size: 0.9rem;&quot;&gt;&lt;strong&gt;${index + 1}¬∫&lt;/strong&gt; ${emp.EMPREENDIMENTO}&lt;/span&gt;
          &lt;span class=&quot;badge bg-primary&quot;&gt;${emp.TOTAL_AREAS_LAZER}&lt;/span&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `;
    container.innerHTML += item;
  });
  
  // Mostra quantidade total se houver mais que 10
  if (concurrentesData.empreendimentos.length &gt; 10) {
    container.innerHTML += `
      &lt;div class=&quot;text-center mt-2&quot;&gt;
        &lt;small class=&quot;text-muted&quot;&gt;Top 10 de ${concurrentesData.empreendimentos.length} empreendimentos&lt;/small&gt;
      &lt;/div&gt;
    `;
  }
}

// Fun√ß√£o para inicializar gr√°fico de venda mensal
function initVendaMensalChart() {
  if (!concurrentesData) return;
  
  const ctx = document.getElementById('vendaMensalChart').getContext('2d');
  
  const empreendimentos = concurrentesData.empreendimentos;
  const labels = empreendimentos.map(emp =&gt; emp.EMPREENDIMENTO);
  const vendasMensais = empreendimentos.map(emp =&gt; emp.VENDAS_MEDIA_MENSAL);
  
  // Configura√ß√£o adaptativa para muitos dados
  const displayLabels = labels.length &gt; 12 ? false : true;
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Vendas Mensais',
        data: vendasMensais,
        backgroundColor: 'rgba(46, 204, 113, 0.8)',
        borderColor: 'rgba(46, 204, 113, 1)',
        borderWidth: 1.5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: {
          top: 10,
          bottom: 10
        }
      },
      plugins: {
        title: {
          display: true,
          text: `Vendas Mensais - ${empreendimentos.length} Empreendimentos`,
          font: {
            size: 14,
            weight: 'bold'
          },
          padding: {
            bottom: 15
          }
        },
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            font: {
              size: 11
            },
            padding: 15
          }
        }
      },
      scales: {
        x: {
          display: displayLabels,
          title: {
            display: true,
            text: displayLabels ? 'Empreendimentos' : `${empreendimentos.length} Empreendimentos`,
            font: {
              size: 11,
              weight: 'bold'
            }
          },
          ticks: {
            display: displayLabels,
            maxRotation: labels.length &gt; 8 ? 45 : 0,
            font: {
              size: 10
            }
          },
          grid: {
            display: false
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Unid/M√™s',
            font: {
              size: 11,
              weight: 'bold'
            }
          },
          ticks: {
            font: {
              size: 10
            }
          },
          grid: {
            color: 'rgba(0,0,0,0.1)'
          }
        }
      }
    }
  });
  
  // Carregar performance mensal
  loadPerformanceMensal();
}

// Fun√ß√£o para carregar performance mensal
function loadPerformanceMensal() {
  if (!concurrentesData) return;
  
  const mediaMercado = concurrentesData.empreendimentos.reduce((acc, emp) =&gt; 
    acc + emp.VENDAS_MEDIA_MENSAL, 0) / concurrentesData.empreendimentos.length;
  
  const melhorPerformance = Math.max(...concurrentesData.empreendimentos.map(emp =&gt; emp.VENDAS_MEDIA_MENSAL));
  const piorPerformance = Math.min(...concurrentesData.empreendimentos.map(emp =&gt; emp.VENDAS_MEDIA_MENSAL));
  
  const container = document.getElementById('performance-mensal');
  container.innerHTML = `
    &lt;div class=&quot;performance-item mb-3 p-3&quot; style=&quot;background: var(--light-bg); border-radius: 10px;&quot;&gt;
      &lt;h6&gt;üìä M√©dia do Mercado&lt;/h6&gt;
      &lt;h4&gt;${mediaMercado.toFixed(1)} unid/m√™s&lt;/h4&gt;
    &lt;/div&gt;
    &lt;div class=&quot;performance-item mb-3 p-3&quot; style=&quot;background: var(--secondary-color); color: white; border-radius: 10px;&quot;&gt;
      &lt;h6&gt;üöÄ Melhor Performance&lt;/h6&gt;
      &lt;h4&gt;${melhorPerformance.toFixed(1)} unid/m√™s&lt;/h4&gt;
    &lt;/div&gt;
    &lt;div class=&quot;performance-item mb-3 p-3&quot; style=&quot;background: var(--danger-color); color: white; border-radius: 10px;&quot;&gt;
      &lt;h6&gt;‚ö†Ô∏è Menor Performance&lt;/h6&gt;
      &lt;h4&gt;${piorPerformance.toFixed(1)} unid/m√™s&lt;/h4&gt;
    &lt;/div&gt;
  `;
}

// Fun√ß√£o para salvar an√°lise em HTML
function salvarHTML() {
  const htmlContent = document.documentElement.outerHTML;
  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'analise_mercadologica_' + new Date().toISOString().slice(0, 10) + '.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Mostrar mensagem de sucesso
  alert('‚úÖ An√°lise salva em HTML com sucesso!');
}

// Fun√ß√£o para salvar an√°lise em PDF
function salvarPDF() {
  // Criar uma nova janela para impress√£o
  const printWindow = window.open('', '_blank');
  const htmlContent = document.documentElement.outerHTML;
  
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  
  // Aguardar o carregamento e imprimir
  printWindow.onload = function() {
    printWindow.print();
    printWindow.close();
  };
  
  // Mostrar mensagem de instru√ß√£o
  alert('üìÑ Uma nova janela foi aberta para impress√£o. Use &quot;Salvar como PDF&quot; na op√ß√£o de impress√£o do navegador.');
}

// Fun√ß√£o para configurar drag and drop
function setupDragAndDrop() {
  const uploadArea = document.querySelector('.upload-area');
  
  if (!uploadArea) return;

  // Previne comportamento padr√£o
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName =&gt; {
    uploadArea.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
  });

  // Adiciona classe quando arquivo √© arrastado sobre a √°rea
  ['dragenter', 'dragover'].forEach(eventName =&gt; {
    uploadArea.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName =&gt; {
    uploadArea.addEventListener(eventName, unhighlight, false);
  });

  // Manipula o drop
  uploadArea.addEventListener('drop', handleDrop, false);

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  function highlight(e) {
    uploadArea.classList.add('dragover');
  }

  function unhighlight(e) {
    uploadArea.classList.remove('dragover');
  }

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files.length &gt; 0) {
      const file = files[0];
      
      // Verifica se √© um arquivo Excel
      if (file.name.match(/\.(xlsx|xls)$/i)) {
        // Simula o input file
        const input = document.getElementById('excel-file');
        const event = { target: { files: [file] } };
        processExcelFile(event);
      } else {
        const statusDiv = document.getElementById('upload-status');
        statusDiv.innerHTML = '&lt;div class=&quot;upload-status-error&quot;&gt;‚ö†Ô∏è Por favor, selecione um arquivo Excel (.xlsx ou .xls)&lt;/div&gt;';
        setTimeout(() =&gt; {
          statusDiv.innerHTML = '';
        }, 3000);
      }
    }
  }
}
&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;"></iframe>
<!-- Iframe do Perfil (somente o perfil) -->
<!-- Barra de navega√ß√£o dentro da aba Perfil -->
<div id="perfilNavBar" style="display:none; position:sticky; top:0; background:#fff; z-index:9999; border-bottom:1px solid #ddd; padding:10px;">
<button onclick="switchToEstudo()" style="background:#eef2ff; color:#3442c0; border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;">‚¨Ö Voltar para Estudo Mercadol√≥gico</button>
</div>
<div id="mapaCalorTabContent" style="display:none;margin:12px 0;">
<button class="tab-button" onclick="if(typeof switchToEstudo==='function'){switchToEstudo();} else { var e=document.getElementById('iEstudo'); var p=document.getElementById('iPerfil'); var m=document.getElementById(); if(e) e.style.display='block'; if(p) p.style.display='none'; if(m) m.style.display='none'; }">Voltar para Estudo Mercadol√≥gico</button>
</div>
<script>
    (function(){
        // Hook into switch functions to toggle the back bar
        var _oldMapa = window.switchToMapa;
        window.switchToMapa = function(){ try{_oldMapa();}catch(e){}; var el=document.getElementById('mapaCalorTabContent'); if(el) el.style.display='block'; };
        window.switchToEstudo = (function(oldFn){
            return function(){ try{ if(oldFn) oldFn(); }catch(e){}; var el=document.getElementById('mapaCalorTabContent'); if(el) el.style.display='none'; var m=document.getElementById(); if(m) m.style.display='none'; var e=document.getElementById('iEstudo'); if(e) e.style.display='block'; var p=document.getElementById('iPerfil'); if(p) p.style.display='none'; }
        })(window.switchToEstudo);
    })();
    </script>
<script>
  function togglePerfilNav(show){
    var bar = document.getElementById('perfilNavBar');
    if (!bar) return;
    bar.style.display = show ? 'block' : 'none';
  }
  // Ajustar fun√ß√µes de troca
  var oldSwitchToEstudo = window.switchToEstudo;
  var oldSwitchToPerfil = window.switchToPerfil;
  window.switchToEstudo = function(){
    if (oldSwitchToEstudo) oldSwitchToEstudo();
    togglePerfilNav(false);
  }
  window.switchToPerfil = function(){
    if (oldSwitchToPerfil) oldSwitchToPerfil();
    togglePerfilNav(true);
  }
</script>
<!-- ===== IN√çCIO BLOCO ADICIONADO: ABA "An√°lise Concorrentes" ===== -->
<style>
  .btn-concorrentes { background:#eef9ff; color:#0b5e3a; border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
  .btn-concorrentes:hover { filter: brightness(0.98); }
  .view { height: calc(100vh - 0px); width: 100%; border:0; display:block; }
  #iConcorrentes { display:none; }
</style>
<script>
  function switchToConcorrentes() {
    var est = document.getElementById('iEstudo');
    var per = document.getElementById('iPerfil');
    var con = document.getElementById('iConcorrentes');
    if (est) est.style.display = 'none';
    if (per) per.style.display = 'none';
    if (con) con.style.display = 'block';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // Garante bot√£o "An√°lise Concorrentes" no topo e dentro do Estudo
  (function() {
    function ensureInternalTab() {
      try {
        var ifr = document.getElementById('iEstudo');
        var doc = ifr && (ifr.contentDocument || ifr.contentWindow.document);
        if (!doc) return;
        if (doc.getElementById('tab-concorrentes')) return; // j√° existe

        var targetText = "Endere√ßo Principal para An√°lise (Busca Avan√ßada)";
        var all = doc.querySelectorAll('body *');
        var targetEl = null;
        for (var i=0;i<all.length;i++) {
          var el = all[i];
          if (el && el.textContent && el.textContent.indexOf(targetText) !== -1) { targetEl = el; break; }
        }
        if (!targetEl) return;

        var bar = doc.createElement('div');
        bar.id = 'aba-interna-concorrentes';
        bar.setAttribute('style', 'margin:8px 0 14px 0; display:flex; gap:8px; flex-wrap:wrap;');

        function mk(label, cls, onclick) {
          var b = doc.createElement('button');
          b.textContent = label;
          b.className = 'btn ' + cls;
          b.onclick = onclick;
          return b;
        }

        bar.appendChild(mk('Estudo Mercadol√≥gico', 'btn-estudo', function(){ /* aba atual */ }));
        bar.appendChild(mk('Perfil de Cliente', 'btn-perfil', function(){ parent.switchToPerfil && parent.switchToPerfil(); }));

        var b3 = mk('An√°lise Concorrentes', 'btn-concorrentes', function(){ parent.switchToConcorrentes && parent.switchToConcorrentes(); });
        b3.id = 'tab-concorrentes';
        bar.appendChild(b3);

        targetEl.parentNode.insertBefore(bar, targetEl);
      } catch(e) {}
    }

    window.addEventListener('DOMContentLoaded', function() {
      // Topbar: adiciona bot√£o se existir barra
      try {
        var tb = document.querySelector('.topbar');
        if (tb && !document.getElementById('btn-concorrentes-top')) {
          var btn = document.createElement('button');
          btn.id = 'btn-concorrentes-top';
          btn.className = 'btn btn-concorrentes';
          btn.textContent = 'An√°lise Concorrentes';
          btn.onclick = switchToConcorrentes;
          tb.appendChild(btn);
        }
      } catch(e) { }

      // Iframe interno: injeta bot√£o dentro do Estudo
      var ifr = document.getElementById('iEstudo');
      if (ifr) ifr.addEventListener('load', function() { setTimeout(ensureInternalTab, 120); });
    });
  })();
</script>
<script>
  function switchToPotencial() {
    var est = document.getElementById('iEstudo');
    var per = document.getElementById('iPerfil');
    var con = document.getElementById('iConcorrentes');
    var pot = document.getElementById('iPotencial');
    if (est) est.style.display = 'none';
    if (per) per.style.display = 'none';
    if (con) con.style.display = 'none';
    if (pot) pot.style.display = 'block';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // Garante bot√£o "Potencial de Consumo" no topo e dentro do Estudo
  (function() {
    function ensureInternalTab() {
      try {
        var ifr = document.getElementById('iEstudo');
        var doc = ifr && (ifr.contentDocument || ifr.contentWindow.document);
        if (!doc) return;
        if (doc.getElementById('tab-potencial')) return;

        var targetText = "Endere√ßo Principal para An√°lise (Busca Avan√ßada)";
        var all = doc.querySelectorAll('body *');
        var targetEl = null;
        for (var i=0;i<all.length;i++) {
          var el = all[i];
          if (el && el.textContent && el.textContent.indexOf(targetText) !== -1) { targetEl = el; break; }
        }
        if (!targetEl) return;

        var bar = doc.getElementById('aba-interna-concorrentes') || doc.createElement('div');
        if (!bar.id) {
          bar.id = 'aba-interna-concorrentes';
          bar.setAttribute('style', 'margin:8px 0 14px 0; display:flex; gap:8px; flex-wrap:wrap;');
          targetEl.parentNode.insertBefore(bar, targetEl);
          // Recria os bot√µes b√°sicos se necess√°rio
          function mk(label, cls, onclick) {
            var b = doc.createElement('button');
            b.textContent = label; b.className = 'btn ' + cls; b.onclick = onclick; return b;
          }
          if (!bar.querySelector('.btn-estudo')) bar.appendChild(mk('Estudo Mercadol√≥gico','btn-estudo', function(){}));
          if (!bar.querySelector('.btn-perfil')) bar.appendChild(mk('Perfil de Cliente','btn-perfil', function(){ parent.switchToPerfil && parent.switchToPerfil(); }));
          if (!bar.querySelector('.btn-concorrentes') && parent.switchToConcorrentes) {
            var b3 = mk('An√°lise Concorrentes','btn-concorrentes', function(){ parent.switchToConcorrentes && parent.switchToConcorrentes(); });
            b3.id = 'tab-concorrentes'; bar.appendChild(b3);
          }
        }
        // Bot√£o Potencial
        var btnPot = doc.createElement('button');
        btnPot.textContent = 'Potencial de Consumo';
        btnPot.className = 'btn btn-warning';
        btnPot.id = 'tab-potencial';
        btnPot.onclick = function(){ parent.switchToPotencial && parent.switchToPotencial(); };
        bar.appendChild(btnPot);
      
        // Bot√£o Mapa de Calor
        var btnMapa = doc.createElement('button');
        btnMapa.textContent = 'Mapa de Calor';
        btnMapa.className = 'btn btn-perfil';
        btnMapa.id = 'tab-mapa';
        btnMapa.onclick = function(){ parent.switchToMapa && parent.switchToMapa(); };
        bar.appendChild(btnMapa);
        } catch(e) {}
    }

    window.addEventListener('DOMContentLoaded', function() {
      // Topbar: adiciona bot√£o se existir barra
      try {
        var tb = document.querySelector('.topbar');
        if (tb && !document.getElementById('btn-potencial-top')) {
          var btn = document.createElement('button');
          btn.className = 'btn btn-warning';
          btn.id = 'btn-potencial-top';
          btn.textContent = 'Potencial de Consumo';
          btn.onclick = function(){ switchToPotencial(); };
          tb.appendChild(btn);
        }
      } catch(e) { }

      // Iframe interno: injeta bot√£o dentro do Estudo
      var ifr = document.getElementById('iEstudo');
      if (ifr) ifr.addEventListener('load', function() { setTimeout(ensureInternalTab, 150); });
    });
  })();
</script>
<!-- IFRAME da nova aba -->
<!-- ===== FIM BLOCO ADICIONADO ===== -->
<!-- IFRAME da aba Potencial de Consumo -->
<div id="backPotencialBar" style="margin:12px 0;">
<button class="tab-button" onclick="switchToEstudo ? switchToEstudo() : (function(){var e=document.getElementById('iEstudo'); var p=document.getElementById('iPerfil'); var c=document.getElementById('iConcorrentes'); var pot=document.getElementById('iPotencial'); if(e) e.style.display='block'; if(p) p.style.display='none'; if(c) c.style.display='none'; if(pot) pot.style.display='none';})();">Voltar para Estudo Mercadol√≥gico</button>
</div>
<iframe ()="" ;="" __export_force_style');="" class="view" doc.documentelement.classlist.add('__exporting');="" doc.head.appendchild(style);="" id="iPotencial" if(!style){="" return="" srcdoc="&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;pt-BR&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;An√°lise de Potencial de Consumo&lt;/title&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js&quot;&gt;&lt;/script&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.css&quot; /&gt;
    &lt;script src=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.js&quot;&gt;&lt;/script&gt;
    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;&gt;
    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin&gt;
    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;style&gt;
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            min-height: 100vh; color: #333; line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: #F0F5CD; border-radius: 24px; padding: 40px; margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,.1); text-align: center; border: 1px solid #F0F5CD;
        }
        .header h1 {
            font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #00512A, #007C27);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px; letter-spacing: -0.02em;
        }
        .header p { font-size: 1.1rem; color: #666; margin-bottom: 30px; font-weight: 400; }
        .address-input-section { margin: 25px 0; padding: 25px; background: #F0F5CD; border-radius: 15px; border: 1px solid #F0F5CD; }
        #map-container { height: 400px; width: 100%; border-radius: 15px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,.1); overflow: hidden; }
        #mapid { height: 100%; width: 100%; }
        .input-group { display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        .address-input { flex: 1; min-width: 300px; padding: 18px 24px; border: 2px solid rgba(102,126,234,.2); border-radius: 16px; font-size: 16px; background: #F0F5CD; outline: none; transition: all .3s; font-weight: 500; }
        .address-input:focus { border-color: #00512A; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,.25); background: #fff; }
        .analyze-btn { padding: 18px 32px; background: linear-gradient(135deg, #00512A, #007C27); color: #fff; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all .3s; box-shadow: 0 8px 25px rgba(102,126,234,.3); letter-spacing: .5px; }
        .analyze-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(102,126,234,.4); }
        .current-location { text-align: center; color: #666; font-size: 14px; margin-top: 10px; }
        .loading { display: none; text-align: center; color: #00512A; font-weight: bold; margin: 20px 0; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 3px solid #00512A; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { background: #F0F5CD; border-radius: 24px; padding: 32px; box-shadow: 0 20px 60px rgba(0,0,0,.08); border: 1px solid #F0F5CD; position: relative; }
        .metric-card { text-align: center; padding: 40px 24px; }
        .metric-value { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #00512A, #007C27); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; letter-spacing: -0.02em; }
        .metric-label { font-size: 1.1rem; color: #4a5568; margin-bottom: 8px; font-weight: 600; }
        .metric-sublabel { font-size: .9rem; color: #718096; font-weight: 400; }
        .chart-container { position: relative; height: 400px; margin-top: 20px; }
        .insights-section, .strengths-weaknesses-section { background: #F0F5CD; border-radius: 24px; padding: 40px; margin-top: 30px; box-shadow: 0 20px 60px rgba(0,0,0,.08); border: 1px solid #F0F5CD; }
        .swot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .swot-card { padding: 25px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,.1); }
        .strengths-card { background: linear-gradient(135deg, #00512A, #007C27); color: #fff; }
        .attention-card { background: linear-gradient(135deg, #f093fb, #f5576c); color: #fff; }
        .opportunities-card { background: linear-gradient(135deg, #4facfe, #00f2fe); color: #fff; }
        .threats-card { background: linear-gradient(135deg, #fa709a, #fee140); color: #fff; }
        .swot-card h3 { margin-bottom: 15px; font-size: 1.2rem; display:flex; align-items:center; gap:8px; }
        .swot-card ul { list-style: none; padding: 0; }
        .swot-card li { margin-bottom: 12px; padding-left: 20px; position: relative; line-height: 1.5; font-size: .95rem; }
        .strengths-card li::before { content: &quot;‚úì&quot;; position: absolute; left: 0; color: #fff; font-weight: bold; }
        .attention-card li::before { content: &quot;‚ö†&quot;; position: absolute; left: 0; color: #fff; }
        .opportunities-card li::before { content: &quot;‚Üí&quot;; position: absolute; left: 0; color: #fff; font-weight: bold; }
        .threats-card li::before { content: &quot;!&quot;; position: absolute; left: 0; color: #fff; font-weight: bold; }
        .insight-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .insight-card { background: linear-gradient(135deg, #00512A, #007C27); color: #fff; padding: 24px; border-radius: 20px; box-shadow: 0 8px 25px rgba(102, 126, 234, .2); }
        .consumption-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .matrix-cell { background: linear-gradient(135deg, #00512A, #007C27); color: #fff; padding: 24px; border-radius: 20px; text-align: center; box-shadow: 0 8px 25px rgba(102,126,234,.2); }
        .matrix-cell h4 { font-size: 1.1rem; margin-bottom: 10px; }
        .matrix-cell .value { font-size: 1.5rem; font-weight: bold; }
        .radius-tabs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .radius-tab { padding: 14px 28px; border: 2px solid rgba(102,126,234,.3); background: #F0F5CD; border-radius: 30px; cursor: pointer; font-weight: 600; color: #4a5568; }
        .radius-tab.active { background: linear-gradient(135deg, #00512A, #007C27); color: #fff; }
        .location-info { background:#F0F5CD; padding:20px; border-radius:15px; margin:20px 0; border:1px solid #F0F5CD; }
        .location-details { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:15px; font-size:14px; color:#666; }
        /* Controle de camadas Leaflet */
        .leaflet-control-layers { background:#F0F5CD!important; border-radius:12px!important; border:1px solid #F0F5CD!important; box-shadow:0 8px 25px rgba(0,0,0,.1)!important; }
        .leaflet-control-layers-toggle { background-color:#F0F5CD!important; border-radius:8px!important; }
        /* Shoppings */
        .shopping-info-section { background:#F0F5CD; border-radius:24px; padding:40px; margin-top:30px; box-shadow:0 20px 60px rgba(0,0,0,.08); border:1px solid #F0F5CD; }
        .shopping-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(350px,1fr)); gap:25px; margin-top:20px; }
        .shopping-card { background: linear-gradient(135deg, #00512A, #007C27); color:#fff; padding:30px; border-radius:20px; box-shadow:0 8px 25px rgba(0,81,42,.3); }
        .shopping-address { font-size:.9rem; margin-bottom:20px; opacity:.9; line-height:1.4; }
        .shopping-stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap:15px; margin-top:20px; }
        .stat-item { text-align:center; padding:15px; background:rgba(255,255,255,.1); border-radius:12px; backdrop-filter: blur(10px); }
        .stat-value { font-size:1.5rem; font-weight:700; margin-bottom:5px; }
        .stat-label { font-size:.8rem; opacity:.9; }
        @media (max-width:768px){
            .header h1{ font-size:2.2rem; }
            .dashboard-grid{ grid-template-columns:1fr; }
            #map-container{ height:300px; }
            .card{ padding:24px; }
            .shopping-grid{ grid-template-columns:1fr; }
            .shopping-stats{ grid-template-columns: repeat(2,1fr); }
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;container&quot;&gt;
    &lt;div class=&quot;header&quot;&gt;
        &lt;h1&gt;An√°lise de Potencial de Consumo&lt;/h1&gt;
        &lt;p&gt;Insira qualquer endere√ßo para an√°lise aprofundada do mercado imobili√°rio&lt;/p&gt;
        &lt;div class=&quot;address-input-section&quot;&gt;
            &lt;div class=&quot;input-group&quot;&gt;
                &lt;input type=&quot;text&quot; id=&quot;addressInput&quot; class=&quot;address-input&quot; placeholder=&quot;Digite o endere√ßo completo (Ex: Rua da Paz, 123, Aldeota, Fortaleza - CE)&quot; onkeypress=&quot;handleKeyPress(event)&quot;&gt;
                &lt;button class=&quot;analyze-btn&quot; onclick=&quot;analyzeLocation()&quot;&gt;üîç Analisar Localiza√ß√£o&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class=&quot;current-location&quot; id=&quot;currentLocation&quot;&gt;üìç Local atual: Digite um endere√ßo para come√ßar a an√°lise&lt;/div&gt;
        &lt;/div&gt;
        &lt;div id=&quot;map-container&quot;&gt;&lt;div id=&quot;mapid&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;loading&quot; id=&quot;loading&quot;&gt;üîÑ Analisando localiza√ß√£o e coletando dados demogr√°ficos...&lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Se√ß√£o de Shoppings (preservada) --&gt;
    &lt;div class=&quot;shopping-info-section&quot; id=&quot;shoppingInfoSection&quot; style=&quot;display:none;&quot;&gt;
        &lt;h2&gt;üè¨ Informa√ß√µes de Fluxo dos Principais Shoppings&lt;/h2&gt;
        &lt;p style=&quot;color:#666; margin-bottom:20px;&quot;&gt;Dados atualizados sobre o fluxo de pessoas nos principais centros comerciais da regi√£o&lt;/p&gt;
        &lt;div class=&quot;shopping-grid&quot;&gt;
            &lt;div class=&quot;shopping-card&quot;&gt;
                &lt;h3&gt;üè¢ Gran Shopping&lt;/h3&gt;
                &lt;div class=&quot;shopping-address&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;shopping-stats&quot;&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;15-20k&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Visitantes/dia&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;600k&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Visitas/m√™s&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;98%&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Taxa ocupa√ß√£o&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;+18%&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Crescimento 2024&lt;/div&gt;&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;shopping-card&quot;&gt;
                &lt;h3&gt;üè¢ Shopping Buena Vista&lt;/h3&gt;
                &lt;div class=&quot;shopping-address&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;shopping-stats&quot;&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;8-12k&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Visitantes/dia&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;325&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Vagas estacion.&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;Alto&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Fluxo regi√£o&lt;/div&gt;&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;shopping-card&quot;&gt;
                &lt;h3&gt;üè¢ Giga Mall&lt;/h3&gt;
                &lt;div class=&quot;shopping-address&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;shopping-stats&quot;&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;15k&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Visitantes/dia&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;1.200&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Lojas&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;92k&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Circula√ß√£o di√°ria&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;stat-item&quot;&gt;&lt;div class=&quot;stat-value&quot;&gt;400+&lt;/div&gt;&lt;div class=&quot;stat-label&quot;&gt;Lojas ativas&lt;/div&gt;&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div id=&quot;analysisResults&quot; style=&quot;display:none;&quot;&gt;
        &lt;div class=&quot;location-info&quot;&gt;
            &lt;h3&gt;üìä Informa√ß√µes da Localiza√ß√£o Analisada&lt;/h3&gt;
            &lt;div class=&quot;location-details&quot; id=&quot;locationDetails&quot;&gt;
                &lt;div&gt;üèôÔ∏è &lt;strong&gt;Bairro:&lt;/strong&gt; &lt;span id=&quot;neighborhood&quot;&gt;-&lt;/span&gt;&lt;/div&gt;
                &lt;div&gt;üèõÔ∏è &lt;strong&gt;Cidade:&lt;/strong&gt; &lt;span id=&quot;city&quot;&gt;-&lt;/span&gt;&lt;/div&gt;
                &lt;div&gt;üìç &lt;strong&gt;Regi√£o:&lt;/strong&gt; &lt;span id=&quot;region&quot;&gt;-&lt;/span&gt;&lt;/div&gt;
                &lt;div&gt;üí∞ &lt;strong&gt;Padr√£o Socioecon√¥mico:&lt;/strong&gt; &lt;span id=&quot;economicLevel&quot;&gt;-&lt;/span&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;radius-tabs&quot;&gt;
            &lt;div class=&quot;radius-tab active&quot; onclick=&quot;changeRadius('2km')&quot; data-radius=&quot;2km&quot;&gt;Raio 2km&lt;button class=&quot;tab-button&quot; onclick=&quot;switchToMapa()&quot;&gt;Mapa de Calor&lt;/button&gt;&lt;/div&gt;
            &lt;div class=&quot;radius-tab&quot; onclick=&quot;changeRadius('5km')&quot; data-radius=&quot;5km&quot;&gt;Raio 5km&lt;/div&gt;
            &lt;div class=&quot;radius-tab&quot; onclick=&quot;changeRadius('8km')&quot; data-radius=&quot;8km&quot;&gt;Raio 8km&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;dashboard-grid&quot; id=&quot;metricsGrid&quot;&gt;
            &lt;div class=&quot;card metric-card&quot;&gt;&lt;div class=&quot;metric-label&quot;&gt;Popula√ß√£o Total&lt;/div&gt;&lt;div class=&quot;metric-value&quot; id=&quot;populacao&quot;&gt;0&lt;/div&gt;&lt;div class=&quot;metric-sublabel&quot;&gt;habitantes no raio selecionado&lt;/div&gt;&lt;/div&gt;
            &lt;div class=&quot;card metric-card&quot;&gt;&lt;div class=&quot;metric-label&quot;&gt;Total de Fam√≠lias&lt;/div&gt;&lt;div class=&quot;metric-value&quot; id=&quot;familias&quot;&gt;0&lt;/div&gt;&lt;div class=&quot;metric-sublabel&quot;&gt;n√∫cleos familiares&lt;/div&gt;&lt;/div&gt;
            &lt;div class=&quot;card metric-card&quot;&gt;&lt;div class=&quot;metric-label&quot;&gt;Renda M√©dia Familiar&lt;/div&gt;&lt;div class=&quot;metric-value&quot; id=&quot;rendaMedia&quot;&gt;R$ 0&lt;/div&gt;&lt;div class=&quot;metric-sublabel&quot;&gt;por m√™s&lt;/div&gt;&lt;/div&gt;
            &lt;div class=&quot;card metric-card&quot;&gt;&lt;div class=&quot;metric-label&quot;&gt;Renda M√©dia por Pessoa&lt;/div&gt;&lt;div class=&quot;metric-value&quot; id=&quot;rendaMediaPorPessoa&quot;&gt;R$ 0&lt;/div&gt;&lt;div class=&quot;metric-sublabel&quot;&gt;por m√™s&lt;/div&gt;&lt;/div&gt;
            &lt;div class=&quot;card metric-card&quot;&gt;&lt;div class=&quot;metric-label&quot;&gt;Potencial de Consumo&lt;/div&gt;&lt;div class=&quot;metric-value&quot; id=&quot;potencialConsumo&quot;&gt;R$ 0M&lt;/div&gt;&lt;div class=&quot;metric-sublabel&quot;&gt;anual estimado&lt;/div&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div id=&quot;potentialIndicator&quot; class=&quot;potential-indicator potential-medium&quot; style=&quot;display:none;&quot;&gt;&lt;/div&gt;

        &lt;div class=&quot;card&quot;&gt;
            &lt;h2&gt;Distribui√ß√£o Demogr√°fica por Raios&lt;/h2&gt;
            &lt;div class=&quot;chart-container&quot;&gt;&lt;canvas id=&quot;demographicChart&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;card&quot;&gt;
            &lt;h2&gt;An√°lise de Potencial de Consumo&lt;/h2&gt;
            &lt;div class=&quot;consumption-matrix&quot;&gt;
                &lt;div class=&quot;matrix-cell&quot;&gt;&lt;h4&gt;Classe A/B&lt;/h4&gt;&lt;div class=&quot;value&quot; id=&quot;classeAB&quot;&gt;0%&lt;/div&gt;&lt;small&gt;R$ 8.000+ renda familiar&lt;/small&gt;&lt;/div&gt;
                &lt;div class=&quot;matrix-cell&quot;&gt;&lt;h4&gt;Classe C&lt;/h4&gt;&lt;div class=&quot;value&quot; id=&quot;classeC&quot;&gt;0%&lt;/div&gt;&lt;small&gt;R$ 2.500-8.000 renda familiar&lt;/small&gt;&lt;/div&gt;
                &lt;div class=&quot;matrix-cell&quot;&gt;&lt;h4&gt;Classe D/E&lt;/h4&gt;&lt;div class=&quot;value&quot; id=&quot;classeDE&quot;&gt;0%&lt;/div&gt;&lt;small&gt;At√© R$ 2.500 renda familiar&lt;/small&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;card&quot;&gt;
            &lt;h2&gt;Proje√ß√£o de Vendas por Segmento&lt;/h2&gt;
            &lt;div class=&quot;chart-container&quot;&gt;&lt;canvas id=&quot;salesChart&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;insights-section&quot;&gt;
            &lt;h2&gt;Insights Estrat√©gicos&lt;/h2&gt;
            &lt;div class=&quot;insight-grid&quot; id=&quot;insightsGrid&quot;&gt;
                &lt;div class=&quot;insight-card&quot;&gt;&lt;h3&gt;üí° Oportunidade Principal&lt;/h3&gt;&lt;p id=&quot;insight1&quot;&gt;Aguardando an√°lise...&lt;/p&gt;&lt;/div&gt;
                &lt;div class=&quot;insight-card&quot;&gt;&lt;h3&gt;üìä Perfil do Consumidor&lt;/h3&gt;&lt;p id=&quot;insight2&quot;&gt;Aguardando an√°lise...&lt;/p&gt;&lt;/div&gt;
                &lt;div class=&quot;insight-card&quot;&gt;&lt;h3&gt;üéØ Estrat√©gia Recomendada&lt;/h3&gt;&lt;p id=&quot;insight3&quot;&gt;Aguardando an√°lise...&lt;/p&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;strengths-weaknesses-section&quot;&gt;
            &lt;h2&gt;An√°lise SWOT da Localiza√ß√£o ‚Äî Linha Nexo&lt;/h2&gt;
            &lt;div class=&quot;swot-grid&quot;&gt;
                &lt;div class=&quot;swot-card strengths-card&quot;&gt;&lt;h3&gt;‚úÖ Pontos Fortes&lt;/h3&gt;&lt;ul id=&quot;strengthsList&quot;&gt;&lt;li&gt;Aguardando an√°lise...&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;
                &lt;div class=&quot;swot-card attention-card&quot;&gt;&lt;h3&gt;‚ö†Ô∏è Pontos de Aten√ß√£o&lt;/h3&gt;&lt;ul id=&quot;attentionList&quot;&gt;&lt;li&gt;Aguardando an√°lise...&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;
                &lt;div class=&quot;swot-card opportunities-card&quot;&gt;&lt;h3&gt;üöÄ Oportunidades&lt;/h3&gt;&lt;ul id=&quot;opportunitiesList&quot;&gt;&lt;li&gt;Aguardando an√°lise...&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;
                &lt;div class=&quot;swot-card threats-card&quot;&gt;&lt;h3&gt;üî¥ Riscos&lt;/h3&gt;&lt;ul id=&quot;threatsList&quot;&gt;&lt;li&gt;Aguardando an√°lise...&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
let currentRadius='2km', currentLocationData=null, demographicChart=null, salesChart=null, map=null, marker=null;

document.addEventListener('DOMContentLoaded', function(){
    map = L.map('mapid').setView([-3.7319, -38.5267], 10);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap'}).addTo(map);
    const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Esri' });
    const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { attribution:'' });
    L.control.layers({&quot;üó∫Ô∏è Mapa&quot;:osm,&quot;üõ∞Ô∏è Sat√©lite&quot;:sat,&quot;üåç H√≠brido&quot;:L.layerGroup([sat,labels])}, null, {position:'topright', collapsed:false}).addTo(map);

    map.on('click', function(e){
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
        const {lat,lng} = e.latlng;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&amp;lat=${lat}&amp;lon=${lng}`)
          .then(r=&gt;r.json()).then(d=&gt;{ document.getElementById('addressInput').value = d.display_name; analyzeLocation(); })
          .catch(()=&gt;{});
    });
});

function handleKeyPress(ev){ if(ev.key==='Enter'){ analyzeLocation(); } }

function changeRadius(r){
    currentRadius=r;
    document.querySelectorAll('.radius-tab').forEach(t=&gt;t.classList.remove('active'));
    document.querySelector(`[data-radius=&quot;${r}&quot;]`).classList.add('active');
    updateDashboard();
}

function analyzeLocation(){
    const address = document.getElementById('addressInput').value.trim();
    if(!address){ alert('Por favor, digite um endere√ßo v√°lido.'); return; }
    document.getElementById('loading').style.display='block';
    document.getElementById('analysisResults').style.display='none';

    fetch(`https://nominatim.openstreetmap.org/search?format=json&amp;q=${encodeURIComponent(address)}`)
    .then(r=&gt;r.json()).then(data=&gt;{
        if(!data.length){ alert('Endere√ßo n√£o encontrado.'); document.getElementById('loading').style.display='none'; return; }
        const lat=parseFloat(data[0].lat), lon=parseFloat(data[0].lon);
        map.setView([lat,lon], 13);
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat,lon]).addTo(map);
        setTimeout(()=&gt;simulateAnalysis(address, data[0]), 800);
    }).catch(()=&gt;{ alert('Erro ao processar o endere√ßo.'); document.getElementById('loading').style.display='none'; });
}

function extractNeighborhood(parts){
    for (let part of parts){
        const clean = part.trim();
        if (['Aldeota','Messejana','Meireles','Iracema','Centro','Coc√≥','Papicu','Varjota','Dion√≠sio Torres','Benfica','Cajazeiras','S√£o Gerardo'].some(v=&gt;clean.includes(v))) return clean;
    }
    return 'Centro';
}
function extractCity(parts){ for(let p of parts){ if(p.trim().includes('Fortaleza')) return 'Fortaleza'; if(p.trim().includes('Caucaia')) return 'Caucaia'; } return 'Fortaleza'; }
function extractRegion(parts){ for(let p of parts){ if(p.trim().includes('CE')||p.trim().includes('Cear√°')) return 'Regi√£o Metropolitana de Fortaleza'; } return 'Regi√£o Metropolitana de Fortaleza'; }

function determineEconomicLevel(neighborhood){
    const high=['Aldeota','Meireles','Iracema','Coc√≥','Varjota','Dion√≠sio Torres'];
    const midHigh=['Papicu','Benfica','Centro'];
    const mid=['Messejana','S√£o Gerardo','Cajazeiras'];
    const low=neighborhood.toLowerCase();
    if (high.some(a=&gt;low.includes(a.toLowerCase()))) return 'Alto';
    if (midHigh.some(a=&gt;low.includes(a.toLowerCase()))) return 'M√©dio-Alto';
    if (mid.some(a=&gt;low.includes(a.toLowerCase()))) return 'M√©dio';
    return 'M√©dio-Baixo';
}

function generateLocationData(level){
    const base = {
        'Alto': {'2km':{pop:[25000,45000], renda:[12000,25000], ab:[60,85], c:[15,35], de:[0,10]},
                 '5km':{pop:[120000,200000], renda:[10000,20000], ab:[50,75], c:[20,40], de:[5,15]},
                 '8km':{pop:[280000,450000], renda:[8000,18000], ab:[45,70], c:[25,45], de:[5,20]}},
        'M√©dio-Alto': {'2km':{pop:[35000,55000], renda:[6000,12000], ab:[25,45], c:[45,65], de:[10,25]},
                 '5km':{pop:[160000,280000], renda:[5500,11000], ab:[20,40], c:[50,70], de:[10,25]},
                 '8km':{pop:[320000,520000], renda:[5000,10000], ab:[18,38], c:[52,72], de:[10,25]}},
        'M√©dio': {'2km':{pop:[38000,62000], renda:[3500,6000], ab:[12,25], c:[55,75], de:[15,30]},
                 '5km':{pop:[180000,300000], renda:[3800,6500], ab:[15,28], c:[57,77], de:[15,30]},
                 '8km':{pop:[360000,580000], renda:[4000,7000], ab:[17,30], c:[55,75], de:[15,30]}},
        'M√©dio-Baixo': {'2km':{pop:[42000,68000], renda:[2800,4200], ab:[8,18], c:[60,78], de:[20,32]},
                 '5km':{pop:[190000,310000], renda:[3000,4500], ab:[10,20], c:[62,80], de:[20,32]},
                 '8km':{pop:[380000,600000], renda:[3200,4800], ab:[12,22], c:[60,78], de:[20,32]}}
    };
    const levelData = base[level] || base['M√©dio'];
    const res={};
    ['2km','5km','8km'].forEach(r=&gt;{
        const rng = levelData[r];
        const populacao = Math.floor(Math.random()*(rng.pop[1]-rng.pop[0])+rng.pop[0]);
        const familias = Math.floor(populacao*0.32);
        const rendaMedia = Math.floor(Math.random()*(rng.renda[1]-rng.renda[0])+rng.renda[0]);
        const rendaMediaPorPessoa = Math.floor(rendaMedia/3);
        const classeAB = Math.floor(Math.random()*(rng.ab[1]-rng.ab[0])+rng.ab[0]);
        const classeDE = Math.floor(Math.random()*(rng.de[1]-rng.de[0])+rng.de[0]);
        const classeC = 100 - classeAB - classeDE;
        const potAB = (populacao*(classeAB/100))*rendaMedia*0.65*12;
        const potC  = (populacao*(classeC/100))*rendaMedia*0.55*12;
        const potDE = (populacao*(classeDE/100))*rendaMedia*0.45*12;
        const potencial = Math.floor(potAB + potC + potDE);
        res[r]={populacao, familias, rendaMedia, rendaMediaPorPessoa, potencial, classeAB, classeC, classeDE};
    });
    return res;
}

function simulateAnalysis(address, geocodeData){
    document.getElementById('currentLocation').textContent = `üìç Local atual: ${address}`;
    const parts = geocodeData.display_name.split(',');
    const neighborhood = extractNeighborhood(parts);
    const city = extractCity(parts);
    const region = extractRegion(parts);
    const econ = determineEconomicLevel(neighborhood);

    currentLocationData = {
        address, neighborhood, city, region, economicLevel:econ,
        data: generateLocationData(econ)
    };

    // Mostrar/ocultar card de shoppings conforme bairro (igual original)
    const shoppingSection = document.getElementById('shoppingInfoSection');
    if (neighborhood.includes('Messejana') || neighborhood.includes('Cajazeiras')) shoppingSection.style.display='block';
    else shoppingSection.style.display='none';

    document.getElementById('loading').style.display='none';
    document.getElementById('analysisResults').style.display='block';
    updateLocationInfo(currentLocationData);
    updateDashboard();

    document.getElementById('analysisResults').scrollIntoView({behavior:'smooth', block:'start'});
}

function updateLocationInfo(ld){
    document.getElementById('neighborhood').textContent = ld.neighborhood;
    document.getElementById('city').textContent = ld.city;
    document.getElementById('region').textContent = ld.region;
    document.getElementById('economicLevel').textContent = ld.economicLevel;
}

function updateDashboard(){
    if(!currentLocationData) return;
    const d = currentLocationData.data[currentRadius];
    document.getElementById('populacao').textContent = d.populacao.toLocaleString();
    document.getElementById('familias').textContent = d.familias.toLocaleString();
    document.getElementById('rendaMedia').textContent = `R$ ${d.rendaMedia.toLocaleString()}`;
    document.getElementById('rendaMediaPorPessoa').textContent = `R$ ${d.rendaMediaPorPessoa.toLocaleString()}`;
    document.getElementById('potencialConsumo').textContent = `R$ ${d.potencial.toLocaleString()}`;

    document.getElementById('classeAB').textContent = `${d.classeAB}%`;
    document.getElementById('classeC').textContent = `${d.classeC}%`;
    document.getElementById('classeDE').textContent = `${d.classeDE}%`;

    updatePotentialIndicator(d.potencial, currentLocationData.economicLevel);
    updateInsights(d, currentLocationData);
    updateCharts();
}

function updatePotentialIndicator(potencial, econ){
    const el = document.getElementById('potentialIndicator');
    el.style.display='block';
    if (potencial &gt; 2000000000){ el.className='potential-indicator potential-high'; el.innerHTML='üéØ POTENCIAL EXCEPCIONAL - Mercado premium de alta rentabilidade'; }
    else if (potencial &gt; 1000000000){ el.className='potential-indicator potential-high'; el.innerHTML='üéØ POTENCIAL ALTO - Mercado muito favor√°vel para investimento'; }
    else if (potencial &gt; 400000000){ el.className='potential-indicator potential-medium'; el.innerHTML='‚ö° POTENCIAL M√âDIO - Mercado com boas oportunidades'; }
    else { el.className='potential-indicator potential-low'; el.innerHTML='‚ö†Ô∏è POTENCIAL BAIXO - Mercado requer estrat√©gia espec√≠fica'; }
}

// ===== Corre√ß√£o e personaliza√ß√£o da fun√ß√£o de insights para LINHA NEXO =====
function generateInsights(data, locationData){
    const economicLevel = locationData.economicLevel; // (corrigido)
    const potencial = data.potencial;                 // (corrigido)
    const rendaMedia = data.rendaMedia;

    const insights = {
        opportunity: 
            economicLevel === 'Alto' ? `Mercado imobili√°rio premium com alto poder aquisitivo. Potencial de R$ ${potencial.toLocaleString()} anuais indica excelente oportunidade para empreendimentos de luxo e alto padr√£o.` :
            economicLevel === 'M√©dio-Alto' ? `Mercado imobili√°rio em crescimento com boa capacidade de consumo. Oportunidades para im√≥veis de m√©dio e alto padr√£o, como condom√≠nios e casas em bairros valorizados.` :
            economicLevel === 'M√©dio' ? `Mercado imobili√°rio de massa com foco em volume. Oportunidades para im√≥veis populares e de entrada, com programas de financiamento facilitado.` :
            `Mercado imobili√°rio popular com foco em acessibilidade. Oportunidades para habita√ß√£o social, alugu√©is de baixo custo e im√≥veis compactos.`,
        profile: 
            economicLevel === 'Alto' ? `Compradores sofisticados, classe A/B dominante (${data.classeAB}%). Valorizam localiza√ß√£o privilegiada, seguran√ßa, design e acabamento de alta qualidade.` :
            economicLevel === 'M√©dio-Alto' ? `Compradores aspiracionais, buscam qualidade com custo-benef√≠cio. Interessados em condom√≠nios com lazer e boa infraestrutura.` :
            economicLevel === 'M√©dio' ? `Compradores pr√°ticos, focados em pre√ßo e facilidades de pagamento.` :
            `Compradores com or√ßamento limitado, muito sens√≠veis a pre√ßo.`,
        strategy: 
            economicLevel === 'Alto' ? 'Linha Nexo com diferencia√ß√£o arquitet√¥nica, plantas amplas e acabamentos premium.' :
            economicLevel === 'M√©dio-Alto' ? 'Linha Nexo com condom√≠nio‚Äëclube, upgrades modulares e financiamento facilitado.' :
            economicLevel === 'M√©dio' ? 'Linha Nexo com efici√™ncia de planta, lazer essencial e forte parceria banc√°ria.' :
            'Linha Nexo com foco em acessibilidade, etapas de obra otimizadas e programas governamentais.',
        strengths: [], attention: [], opportunities: [], threats: []
    };

    // Ajustes Nexo espec√≠ficos
    const imovelPricePerSqM = Math.floor(rendaMedia * 0.08 * 1000);
    const rentalYield = ((rendaMedia * 0.005 * 12) / imovelPricePerSqM).toFixed(2);
    insights.opportunities.push(`Estimativa de rendimento de aluguel: ${rentalYield}% ao ano.`);

    if (economicLevel === 'Alto'){
        insights.strengths.push('Entorno com poder aquisitivo elevado e demanda por alto padr√£o.');
        insights.opportunities.push(`Ticket premium poss√≠vel (‚âà R$ ${imovelPricePerSqM.toLocaleString()}/m¬≤).`);
        insights.attention.push('Concorr√™ncia intensa e necessidade de diferencia√ß√£o (fachada, lazer, tecnologia).');
    } else if (economicLevel === 'M√©dio-Alto'){
        insights.strengths.push('Demanda por condom√≠nio‚Äëclube com bom custo‚Äëbenef√≠cio.');
        insights.opportunities.push(`Pre√ßo competitivo para m√©dio padr√£o (‚âà R$ ${imovelPricePerSqM.toLocaleString()}/m¬≤).`);
        insights.attention.push('Sensibilidade a pre√ßo ‚Äì calibrar ticket vs. concorr√™ncia.');
    } else if (economicLevel === 'M√©dio'){
        insights.strengths.push('Base ampla para 2 e 3 quartos com alta liquidez.');
        insights.opportunities.push(`Pre√ßo acess√≠vel para volume (‚âà R$ ${imovelPricePerSqM.toLocaleString()}/m¬≤).`);
        insights.attention.push('Depend√™ncia do cr√©dito; aten√ß√£o a aprova√ß√µes banc√°rias.');
    } else {
        insights.strengths.push('Ader√™ncia a produtos de entrada com efici√™ncia construtiva.');
        insights.opportunities.push(`Integra√ß√£o com programas habitacionais (ticket alvo ‚âà R$ ${imovelPricePerSqM.toLocaleString()}/m¬≤).`);
        insights.attention.push('Infraestrutura urbana heterog√™nea; mapear servi√ßos e transporte.');
    }

    // Din√¢micos pelas m√©tricas
    if (data.classeAB &gt;= 40) insights.strengths.push('Presen√ßa relevante de Classe A/B no raio analisado.');
    if (data.classeC &gt;= 50) insights.strengths.push('Classe C predominante ‚Äî oportunidade de escala de vendas.');
    if (potencial &gt; 1_000_000_000) insights.opportunities.push('Potencial acima de R$ 1 bi/ano ‚Äî possibilidade de faseamento maior.');
    if (rendaMedia &lt; 4500) insights.attention.push('Ticket m√°ximo deve considerar renda familiar m√©dia abaixo de R$ 4.500.');

    // Amea√ßas gerais
    insights.threats.push('Oscila√ß√£o de juros e cr√©dito pode impactar velocidade de vendas.');
    insights.threats.push('Mudan√ßas regulat√≥rias urban√≠sticas podem afetar cronograma.');

    return insights;
}

function updateInsights(data, locationData){
    const insights = generateInsights(data, locationData);
    document.getElementById('insight1').textContent = insights.opportunity;
    document.getElementById('insight2').textContent = insights.profile;
    document.getElementById('insight3').textContent = insights.strategy;
    updateSWOTAnalysis(insights);
}

function updateSWOTAnalysis(insights){
    document.getElementById('strengthsList').innerHTML = insights.strengths.map(i=&gt;`&lt;li&gt;${i}&lt;/li&gt;`).join('') || '&lt;li&gt;-&lt;/li&gt;';
    document.getElementById('attentionList').innerHTML = insights.attention.map(i=&gt;`&lt;li&gt;${i}&lt;/li&gt;`).join('') || '&lt;li&gt;-&lt;/li&gt;';
    document.getElementById('opportunitiesList').innerHTML = insights.opportunities.map(i=&gt;`&lt;li&gt;${i}&lt;/li&gt;`).join('') || '&lt;li&gt;-&lt;/li&gt;';
    document.getElementById('threatsList').innerHTML = insights.threats.map(i=&gt;`&lt;li&gt;${i}&lt;/li&gt;`).join('') || '&lt;li&gt;-&lt;/li&gt;';
}

function updateCharts(){
    if(!currentLocationData) return;
    const raiosData = ['2km','5km','8km'].map(raio=&gt;({raio, ...currentLocationData.data[raio]}));

    if (demographicChart) demographicChart.destroy();
    const ctx1 = document.getElementById('demographicChart').getContext('2d');
    demographicChart = new Chart(ctx1, {
        type:'bar',
        data:{ labels:raiosData.map(d=&gt;d.raio),
               datasets:[
                { label:'Popula√ß√£o', data:raiosData.map(d=&gt;d.populacao), backgroundColor:'#00512A', borderColor:'#00512A', borderWidth:2, borderRadius:8 },
                { label:'Fam√≠lias', data:raiosData.map(d=&gt;d.familias), backgroundColor:'#007C27', borderColor:'#007C27', borderWidth:2, borderRadius:8 }
               ]},
        options:{ responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ position:'top', labels:{ usePointStyle:true, padding:20, font:{ family:'Inter', size:12, weight:'600' } } } },
            scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,.1)' }, ticks:{ font:{ family:'Inter', size:11 } } },
                     x:{ grid:{ display:false }, ticks:{ font:{ family:'Inter', size:11, weight:'600' } } } }
        }
    });

    if (salesChart) salesChart.destroy();
    const currentData = currentLocationData.data[currentRadius];
    const ctx2 = document.getElementById('salesChart').getContext('2d');
    salesChart = new Chart(ctx2, {
        type:'doughnut',
        data:{ labels:['Classe A/B','Classe C','Classe D/E'],
               datasets:[{ data:[currentData.classeAB, currentData.classeC, currentData.classeDE], backgroundColor:['#00512A','#007C27','#4facfe'], borderWidth:0, cutout:'60%' }]},
        options:{ responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ position:'bottom', labels:{ usePointStyle:true, padding:20, font:{ family:'Inter', size:12, weight:'600' } } } }
        }
    });
}
&lt;/script&gt;

&lt;!-- ====== EXPORTA√á√ÉO TOTAL (TODAS AS ABAS) ‚Äî CORRIGIDO (cores/opacidade) ====== --&gt;
&lt;style&gt;
  #export-toolbar-tabs{
    position: fixed; right: 16px; bottom: 16px; z-index: 2147483647;
    display: flex; gap: 10px; flex-wrap: wrap;
  }
  #export-toolbar-tabs .export-btn{
    background: linear-gradient(90deg, #00512A, #007C27);
    color: #fff; border: 0; border-radius: 12px; padding: 10px 14px;
    font-weight: 700; box-shadow: 0 6px 18px rgba(0,0,0,.15);
    cursor: pointer;
  }
  #export-toolbar-tabs .export-btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
  @media print { #export-toolbar-tabs{ display:none !important; } }
&lt;/style&gt;
&lt;div id=&quot;export-toolbar-tabs&quot; aria-label=&quot;Exportar&quot;&gt;
  &lt;button id=&quot;btn-save-pdf-tabs&quot;  class=&quot;export-btn&quot; title=&quot;Salvar PDF com TODAS as abas (inclusive escondidas)&quot;&gt;üíæ Salvar PDF (todas as abas)&lt;/button&gt;
  &lt;button id=&quot;btn-save-html-tabs&quot; class=&quot;export-btn&quot; title=&quot;Salvar HTML atual&quot;&gt;üíæ Salvar HTML&lt;/button&gt;
&lt;/div&gt;

&lt;script src=&quot;https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js&quot;&gt;&lt;/script&gt;

&lt;script&gt;
(function(){
  const { jsPDF } = window.jspdf || {};
  function pxPerMm(){ return 96/25.4; }
  function sleep(ms){ return new Promise(r =&gt; setTimeout(r, ms)); }

  function injectForceStyle(doc){
    // For√ßa fidelidade de cores, remove opacidades/filtros/blend
    const css = `
      /* for√ßa cores reais */
      :root, * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      .__exporting, .__exporting * {
        opacity: 1 !important;
        filter: none !important;
        mix-blend-mode: normal !important;
        backdrop-filter: none !important;
      }
      /* Leaflet: desativa fade/transi√ß√£o e for√ßa tiles 100% */
      .__exporting .leaflet-tile,
      .__exporting .leaflet-overlay-pane,
      .__exporting .leaflet-marker-icon,
      .__exporting .leaflet-zoom-animated,
      .__exporting .leaflet-pane {
        opacity: 1 !important;
        filter: none !important;
        transition: none !important;
        animation: none !important;
      }
    `;
    let style = doc.getElementById(" style="doc.createElement('style');" style.appendchild(doc.createtextnode(css));="" style.id="__export_force_style" style.type="text/css" }="">{
      doc.documentElement.classList.remove('__exporting');
      // n√£o remove o style para reutilizar em capturas subsequentes
    };
  }

  function saveHTML(){
    try{
      const html = '<!DOCTYPE html>

' + document.documentElement.outerHTML;
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'Estudo_Mercadologico.html';
      document.body.appendChild(a); a.click();
      setTimeout(()=&gt;{ URL.revokeObjectURL(url); a.remove(); }, 1200);
    }catch(e){ alert('Falha ao salvar HTML: '+ e.message); }
  }

  async function rasterizeMapsOnce(root){
    const sels = ['#map', '.leaflet-container', '[data-map]', '[id*="map"]'];
    const t = [];
    sels.forEach(sel =&gt; root.querySelectorAll(sel).forEach(el =&gt; { if(!el.getAttribute('data-pdf-rasterized')) t.push(el); }));
    if(!t.length) return () =&gt; {};
    const states = [];
    for(const el of t){
      try{
        const canvas = await html2canvas(el, {useCORS:true, scale: 2, backgroundColor: null});
        const dataUrl = canvas.toDataURL('image/png');
        const img = root.createElement('img');
        img.src = dataUrl; img.alt = 'Mapa (rasterizado para PDF)';
        img.style.width = el.offsetWidth + 'px';
        img.style.height= el.offsetHeight + 'px';
        try{ img.style.borderRadius = (getComputedStyle(el).borderRadius || '0'); }catch(_){}
        el.parentNode.insertBefore(img, el);
        states.push({el, img});
        el.style.display = 'none';
        el.setAttribute('data-pdf-rasterized','1');
      }catch(e){ /* ignora */ }
    }
    return function restore(){
      states.forEach(({el, img}) =&gt; {
        if(img &amp;&amp; img.parentNode) img.parentNode.removeChild(img);
        el.style.display=''; el.removeAttribute('data-pdf-rasterized');
      });
    };
  }

  async function elementToPDFPages(pdf, el, opts){
    const marginMm = 5;
    const pageWmm = (opts &amp;&amp; opts.pageWmm) || 210;
    const pageHmm = (opts &amp;&amp; opts.pageHmm) || 297;
    const pxmm = pxPerMm();
    const contentWpx = (pageWmm - marginMm*2) * pxmm;
    const contentHpx = (pageHmm - marginMm*2) * pxmm;

    const canvas = await html2canvas(el, {
      useCORS:true, scale: 2, backgroundColor: '#ffffff',
      windowWidth:  Math.max(el.scrollWidth || 0,  document.documentElement.scrollWidth || 0),
      windowHeight: Math.max(el.scrollHeight || 0, document.documentElement.scrollHeight || 0)
    });
    const cw = canvas.width, ch = canvas.height;
    const sliceH = Math.max(1, Math.floor((contentHpx / contentWpx) * cw));

    let y = 0, first = true;
    while (y &lt; ch){
      const h = Math.min(sliceH, ch - y);
      const slice = document.createElement('canvas');
      slice.width = cw; slice.height = h;
      const ctx = slice.getContext('2d');
      ctx.drawImage(canvas, 0, y, cw, h, 0, 0, cw, h);
      const imgData = slice.toDataURL('image/jpeg', 0.98);
      if(!first) pdf.addPage();
      first = false;
      const imgWmm = pageWmm - marginMm*2;
      const imgHmm = (h / cw) * imgWmm;
      pdf.addImage(imgData, 'JPEG', marginMm, marginMm, imgWmm, imgHmm);
      y += h;
    }
  }

  function detectTabButtons(){
    const candidates = new Set();
    const selectors = [
      '[role="tab"]',
      '.tab', '.tabs button', '.tab-btn', '.nav-tabs .nav-link', '.nav .nav-link', '.tablinks', '.tab-link',
      '[data-tab]', '[data-target]', '[data-toggle="tab"]', '[aria-controls]',
      'button[onclick*="showTab"]', 'a[onclick*="showTab"]',
      '.aba', '.abas button'
    ];
    selectors.forEach(s =&gt; document.querySelectorAll(s).forEach(el =&gt; {
      const cs = getComputedStyle(el);
      if (cs.display === 'none' || cs.visibility === 'hidden') return;
      if (['A','BUTTON','DIV','LI','SPAN'].includes(el.tagName)) candidates.add(el);
    }));
    const arr = Array.from(candidates);
    const uniq = [];
    const seen = new Set();
    for(const el of arr){
      const key = (el.getAttribute('aria-controls')||'') + '|' + (el.dataset.tab||'') + '|' + (el.textContent||'').trim();
      if(!seen.has(key)){ seen.add(key); uniq.push(el); }
    }
    return uniq;
  }

  async function captureAllIframes(pdf){
    const iframes = Array.from(document.querySelectorAll('iframe'));
    for(const fr of iframes){
      try{
        const doc = fr.contentDocument || (fr.contentWindow &amp;&amp; fr.contentWindow.document);
        if(!doc || !doc.body) continue;
        const remove = injectForceStyle(doc);
        const restore = await rasterizeMapsOnce(doc);
        await elementToPDFPages(pdf, doc.body, {});
        restore &amp;&amp; restore();
        remove &amp;&amp; remove();
      }catch(e){ console.warn('Erro ao capturar iframe para o PDF:', e); }
    }
  }

  async function savePDFAllTabs(){
    try{
      if(!jsPDF){ alert('Biblioteca jsPDF n√£o carregada.'); return; }
      const pdf = new jsPDF({unit:'mm', format:'a4', orientation:'portrait'});

      // 1) P√°gina vis√≠vel com cores for√ßadas
      const removeForce = injectForceStyle(document);
      let restoreMain = await rasterizeMapsOnce(document);
      await elementToPDFPages(pdf, document.body, {});
      restoreMain &amp;&amp; restoreMain();
      removeForce &amp;&amp; removeForce();

      // 2) iframes neste estado
      await captureAllIframes(pdf);

      // 3) Clicar/percorrer abas (se existirem) e capturar cada estado
      const tabs = detectTabButtons();
      const originalActive = document.activeElement;

      async function captureCurrentState(){
        window.scrollTo(0,0);
        const removeForce = injectForceStyle(document);
        let restore = await rasterizeMapsOnce(document);
        await elementToPDFPages(pdf, document.body, {});
        restore &amp;&amp; restore();
        removeForce &amp;&amp; removeForce();
        await captureAllIframes(pdf);
      }

      for(let i=0; i<tabs.length; &&="" '="" )="" +="" <="" aba:',="" alert('falha="" ao="" await="" bhtml="document.getElementById('btn-save-html-tabs');" bhtml.addeventlistener('click',="" bpdf="document.getElementById('btn-save-pdf-tabs');" bpdf.addeventlistener('click',="" btn="tabs[i];" btn.click();="" capturar="" capturecurrentstate();="" console.warn('falha="" const="" continue;="" document.addeventlistener('domcontentloaded',="" e);="" e.message);="" function(){="" gerar="" i++){="" if(bhtml)="" if(bpdf)="" if(btn.getattribute('aria-selected')="true" if(originalactive="" o="" originalactive.focus();="" originalactive.focus)="" pdf.save('estudo_mercadologico_todas_as_abas.pdf');="" pdf:="" savehtml);="" savepdfalltabs);="" script="" sleep(500);="" try{="" uma="" }="" })();="" });="" }catch(e){="">
</tabs.length;></iframe>
<!-- ===== IN√çCIO BLOCO ADICIONADO: ABA "Perfil de Compra" ===== -->
<style>
</style>
<script>
  function switchToPerfilCompra() {
    var ids = ['iEstudo'];
    for (var i=0;i<ids.length;i++) {
      var el = document.getElementById(ids[i]);
      if (!el) continue;
      el.style.display = (ids[i] === 'iPerfilCompra') ? 'block' : 'none';
    }
    try { window.scrollTo({top:0, behavior:'smooth'}); } catch(_){}
}

  // Topbar: adiciona bot√£o se existir barra
  document.addEventListener('DOMContentLoaded', function() {
    try {
      var tb = document.querySelector('.topbar');
      if (tb && !document.getElementById('btn-perfil-compra-top')) {
        var btn = document.createElement('button');
        btn.id = 'btn-perfil-compra-top';
        btn.className = 'btn btn-perfil-compra';
        btn.textContent = 'Perfil de Compra';
        btn.onclick = switchToPerfilCompra;
        tb.appendChild(btn);
      }
    } catch(e) { console.warn('Topbar Perfil de Compra:', e); }

    // Iframe interno: injeta bot√£o dentro do Estudo (logo acima do alvo)
    function ensureInternalTab() {
      try {
        var ifr = document.getElementById('iEstudo');
        var doc = ifr && (ifr.contentDocument || ifr.contentWindow.document);
        if (!doc) return;
        if (doc.getElementById
        var bar = doc.getElementById('aba-interna-concorrentes') || doc.getElementById('aba-interna-perfil-compra');
        if (!bar) {
          bar = doc.createElement('div');
          bar.id = 'aba-interna-perfil-compra';
          bar.setAttribute('style', 'margin:8px 0 14px 0; display:flex; gap:8px; flex-wrap:wrap;');
          targetEl.parentNode.insertBefore(bar, targetEl);
        }

        var btn = doc.createElement('button');
        btn.id = 'tab-perfil-compra';
        btn.className = 'btn btn-perfil';
        btn.textContent = 'Perfil de Compra';
        btn.setAttribute('style','background:#007C27; color:#FFFFFF; border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;');
        btn.onclick = function(){ parent.switchToPerfilCompra &&  };
        bar.appendChild(btn);
r.addEventListener('load', function(){ setTimeout(ensureInternalTab, 150); }); }
  });
</script>
<!-- IFRAME da nova aba -->
<!-- ===== FIM BLOCO ADICIONADO: ABA "Perfil de Compra" ===== -->
<script>
(function(){
  function hideInternalBars(){
    try{
      var ifr = document.getElementById('iEstudo');
      if (!ifr) return;
      var doc = ifr.contentDocument || ifr.contentWindow.document;
      if (!doc) return;
      var ids = ['iEstudo'];
      for (var i=0;i<ids.length;i++){
        var el = doc.getElementById(ids[i]);
        if (el) el.style.display = 'none';
      }
      // Tamb√©m oculta bot√µes de abas antigas dentro do Estudo, se existirem
      var btns = doc.querySelectorAll('button#tab-potencial, button#tab-concorrentes, button.btn-estudo, button.btn-perfil, button.btn-concorrentes, button.btn-perfil-compra');
      for (var j=0;j<btns.length;j++){ btns[j].style.display = 'none'; }
    }catch(e){}
  }
  window.addEventListener('load', function(){
    var ifr = document.getElementById('iEstudo');
    if (ifr) {
      ifr.addEventListener('load', function(){ setTimeout(hideInternalBars, 120); });
    }
    // Chama uma vez caso o iframe j√° esteja carregado
    setTimeout(hideInternalBars, 200);
  });
})();
</script>

<script>
// == INJE√á√ÉO DE UPLOAD DENTRO DO iMapaCalor ===============================
(function(){
  function ensureXLSX(doc, cb){
    try{
      if (doc.defaultView && doc.defaultView.XLSX){ cb(); return; }
      var s = doc.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
      s.onload = cb;
      doc.head.appendChild(s);
    }catch(e){ console.warn('Falha ao carregar XLSX no iMapaCalor:', e); }
  }
  function addStyles(doc){
    if (doc.getElementById('poi-upload-style-mapa')) return;
    var st = doc.createElement('style');
    st.id = 'poi-upload-style-mapa';
    st.textContent = `
      .upload-area{border:2px dashed var(--primary-color,#00512A);border-radius:20px;padding:1rem;text-align:center;background:linear-gradient(135deg,rgba(0,81,42,.03) 0%,rgba(46,204,113,.05) 100%);margin:10px 0;cursor:pointer}
      .upload-area.dragover{background:linear-gradient(135deg,rgba(46,204,113,.15) 0%,rgba(0,81,42,.1) 100%);transform:scale(1.01)}
      .upload-status-success{background:linear-gradient(135deg,rgba(46,204,113,.1) 0%,rgba(39,174,96,.05) 100%);border:1px solid rgba(46,204,113,.3);border-radius:10px;padding:.5rem;color:#27AE60;margin-top:.5rem}
      .upload-status-error{background:linear-gradient(135deg,rgba(231,76,60,.1) 0%,rgba(192,57,43,.05) 100%);border:1px solid rgba(231,76,60,.3);border-radius:10px;padding:.5rem;color:#E74C3C;margin-top:.5rem}
      .upload-status-info{background:linear-gradient(135deg,rgba(52,152,219,.1) 0%,rgba(41,128,185,.05) 100%);border:1px solid rgba(52,152,219,.3);border-radius:10px;padding:.5rem;color:#3498DB;margin-top:.5rem}
      .mode-toggle{display:flex;gap:12px;justify-content:center;margin:.25rem 0 .5rem}
      .mode-toggle label{font-weight:600}
    `;
    doc.head.appendChild(st);
  }
  function injectUpload(){
    try{
      var ifr = document.getElementById('iMapaCalor');
      if(!ifr) return;
      var doc = ifr.contentDocument || ifr.contentWindow.document;
      if(!doc) return;

      function _inject(){
        try{
          addStyles(doc);
          // tenta localizar bloco/√°rea principal para inserir o upload
          var header = Array.from(doc.querySelectorAll('h5,h4,h3')).find(h => /Mapa de Calor|Endere√ßo Principal|Pontos de Interesse/i.test(h.textContent||''));
          var container = header ? (header.closest('.modern-card') || header.parentElement) : (doc.querySelector('.container') || doc.body);
          if (!container) container = doc.body;

          if (doc.getElementById('poi-upload-container-mapa')) return; // evita duplicar

          var wrapper = doc.createElement('div');
          wrapper.id = 'poi-upload-container-mapa';
          wrapper.className = 'upload-area';
          wrapper.innerHTML = [
            '<div style="font-size:1.1rem;font-weight:700;margin-bottom:.25rem">üì§ Importar pontos via Planilha (Excel/CSV)</div>',
            '<div class="mode-toggle">',
              '<label><input type="radio" name="poi-mode" value="append" checked> Adicionar aos existentes</label>',
              '<label><input type="radio" name="poi-mode" value="replace"> Substituir existentes</label>',
            '</div>',
            '<div class="d-flex justify-content-center gap-2" style="margin-bottom:.25rem">',
              '<button id="poi-upload-btn-mapa" class="btn btn-success btn-sm">Selecionar arquivo</button>',
              '<button id="poi-download-model-mapa" class="btn btn-warning btn-sm" title="Baixar modelo CSV">Baixar modelo (.csv)</button>',
            '</div>',
            '<input id="poi-excel-file-mapa" type="file" accept=".xlsx,.xls,.csv" style="display:none" />',
            '<div style="font-size:.85rem;color:#666">Cabe√ßalhos aceitos: <b>Latitude</b>, <b>Longitude</b>, <b>Subt√≠tulo</b>.</div>',
            '<div id="poi-upload-status-mapa" class="upload-status-info" style="display:none"></div>'
          ].join('');
          container.insertBefore(wrapper, container.firstChild);

          var fileInput = doc.getElementById('poi-excel-file-mapa');
          var btnSelect = doc.getElementById('poi-upload-btn-mapa');
          var btnModel  = doc.getElementById('poi-download-model-mapa');
          var statusBox = doc.getElementById('poi-upload-status-mapa');

          function setStatus(type, msg){
            statusBox.className = type === 'error' ? 'upload-status-error' :
                                  type === 'success' ? 'upload-status-success' :
                                  'upload-status-info';
            statusBox.style.display = 'block';
            statusBox.textContent = msg;
          }

          btnSelect.addEventListener('click', function(){ fileInput.click(); });
          btnModel.addEventListener('click', function(){
            var csv = 'Latitude,Longitude,Subtitulo\\n-3.7319,-38.5267,Ponto exemplo A\\n-3.7350,-38.5200,Ponto exemplo B\\n';
            var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            var url = (URL || webkitURL).createObjectURL(blob);
            var a = doc.createElement('a');
            a.href = url; a.download = 'modelo_pontos.csv';
            doc.body.appendChild(a); a.click();
            setTimeout(function(){ (URL || webkitURL).revokeObjectURL(url); a.remove(); }, 100);
          });

          function normalizeKey(k){
            return (k||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
          }

          function clearExisting(){
            try{
              if (typeof doc.defaultView.limparPontosImportados === 'function'){
                doc.defaultView.limparPontosImportados();
                return true;
              }
              if (doc.defaultView.__camadaPOI){
                doc.defaultView.__camadaPOI.clearLayers();
                return true;
              }
            }catch(e){}
            return false;
          }

          function addPoint(lat, lng, subt){
            try{
              if (typeof doc.defaultView.criarPontoInteresse === 'function'){
                doc.defaultView.criarPontoInteresse(lat, lng, '', (subt||'Ponto importado'));
                return true;
              }
            }catch(e){ console.warn('Erro criarPontoInteresse:', e); }
            return false;
          }

          function parseRows(rows){
            var ok=0, fail=0;
            rows.forEach(function(r, idx){
              var obj={};
              Object.keys(r).forEach(function(key){ obj[normalizeKey(key)] = r[key]; });
              var lat = r['Latitude'] ?? obj['latitude'] ?? obj['lat'];
              var lng = r['Longitude'] ?? obj['longitude'] ?? obj['long'] ?? obj['lng'] ?? obj['lon'];
              var subt = r['Subtitulo'] ?? obj['subtitulo'] ?? obj['subtitulo*'] ?? obj['subtitulo (opcional)'] ?? obj['subt√≠tulo'];
              lat = (typeof lat==='string') ? lat.replace(',', '.') : lat;
              lng = (typeof lng==='string') ? lng.replace(',', '.') : lng;
              lat = parseFloat(lat); lng = parseFloat(lng);
              if (Number.isFinite(lat) && Number.isFinite(lng)){
                if (addPoint(lat,lng,subt)) ok++; else fail++;
              }else{ fail++; }
            });
            if (ok>0 && fail===0) setStatus('success','‚úÖ '+ok+' ponto(s) importado(s) com sucesso.');
            else if (ok>0) setStatus('info','‚ö†Ô∏è '+ok+' importado(s), '+fail+' registro(s) ignorado(s).');
            else setStatus('error','‚ùå N√£o foi poss√≠vel importar. Confira cabe√ßalhos/valores.');
          }

          function handleFile(file){
            if(!file) return;
            var reader = new FileReader();
            reader.onload = function(e){
              try{
                var data = e.target.result;
                var wb = doc.defaultView.XLSX.read(data, {type:'array'});
                var sheet = wb.Sheets[wb.SheetNames[0]];
                var matrix = doc.defaultView.XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
                if(!matrix || !matrix.length){ setStatus('error','‚ùå Planilha vazia.'); return; }
                var headerRowIndex = matrix.findIndex(r => Array.isArray(r) && r.filter(x => (x||'').toString().trim()!=='').length >= 2);
                if (headerRowIndex === -1){ setStatus('error','‚ùå N√£o encontrei cabe√ßalhos. Use Latitude, Longitude e Subt√≠tulo.'); return; }
                var header = matrix[headerRowIndex].map(h => (h||'').toString());
                function n(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }
                var idxLat = header.findIndex(h => ['latitude','lat'].includes(n(h)));
                var idxLng = header.findIndex(h => ['longitude','lng','long','lon'].includes(n(h)));
                var idxSub = header.findIndex(h => ['subtitulo','subt√≠tulo'].includes(n(h)));
                if (idxLat===-1 || idxLng===-1){ setStatus('error','‚ùå Cabe√ßalhos n√£o encontrados. Use Latitude e Longitude (ou lat/lng).'); return; }
                var mode = (doc.querySelector('input[name="poi-mode"]:checked')||{}).value || 'append';
                if (mode==='replace'){ clearExisting(); }
                var dataRows = matrix.slice(headerRowIndex+1);
                var rows = dataRows.map(r => {
                  var o={};
                  if(Array.isArray(r)){
                    o['Latitude'] = r[idxLat];
                    o['Longitude']= r[idxLng];
                    o['Subtitulo']= (idxSub>=0? r[idxSub] : '');
                  }
                  return o;
                }).filter(o => Object.keys(o).length>0);
                if(!rows.length){ setStatus('error','‚ùå N√£o h√° dados ap√≥s os cabe√ßalhos.'); return; }
                parseRows(rows);
              }catch(err){
                console.error('Erro ao ler planilha (Mapa de Calor):', err);
                setStatus('error','‚ùå Erro ao ler o arquivo. Use .xlsx, .xls ou .csv.');
              }
            };
            reader.onerror = function(){ setStatus('error','‚ùå Falha ao ler o arquivo.'); };
            reader.readAsArrayBuffer(file);
          }

          // Eventos
          fileInput.addEventListener('change', function(ev){
            setStatus('info','‚è≥ Lendo arquivo...');
            handleFile(ev.target.files[0]);
            ev.target.value='';
          });
          wrapper.addEventListener('dragover', function(ev){ ev.preventDefault(); wrapper.classList.add('dragover'); });
          wrapper.addEventListener('dragleave', function(){ wrapper.classList.remove('dragover'); });
          wrapper.addEventListener('drop', function(ev){
            ev.preventDefault(); wrapper.classList.remove('dragover');
            var file = ev.dataTransfer.files && ev.dataTransfer.files[0];
            if (file){ setStatus('info','‚è≥ Lendo arquivo...'); handleFile(file); }
          });
        }catch(e){ console.warn('Falha na inje√ß√£o do upload no Mapa de Calor:', e); }
      }

      // Injeta quando o iframe terminar de carregar
      ifr.addEventListener('load', function(){
        var doc = ifr.contentDocument || ifr.contentWindow.document;
        ensureXLSX(doc, function(){ setTimeout(_inject, 80); });
      });
      // Se j√° carregou, injeta imediatamente
      if (ifr.contentDocument && ifr.contentDocument.readyState === 'complete'){
        var doc = ifr.contentDocument;
        ensureXLSX(doc, function(){ setTimeout(_inject, 80); });
      }
    }catch(e){ console.warn('Falha geral injetor iMapaCalor:', e); }
  }
  // Aguarda DOM principal
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', injectUpload); }
  else { injectUpload(); }
})();
</script>

<style id="annulus-osm-style">
.leaflet-interactive.halo-r2 { filter: drop-shadow(0 0 2px rgba(0,81,42,.95)) drop-shadow(0 0 6px rgba(0,81,42,.4)); }
.leaflet-interactive.halo-r5 { filter: drop-shadow(0 0 2px rgba(46,204,113,.95)) drop-shadow(0 0 6px rgba(46,204,113,.4)); }
.leaflet-interactive.halo-r8 { filter: drop-shadow(0 0 2px rgba(52,152,219,.95)) drop-shadow(0 0 6px rgba(52,152,219,.4)); }
</style>
<script id="annulus-osm-script">
(function(){
  if (window.__ANNULUS_OSM__) return; window.__ANNULUS_OSM__ = true;

  const LAYER_ID = {2:"__ring_r2__", 5:"__ring_r5__", 8:"__ring_r8__"};
  const STYLE = { 2:{radius:6, weight:2, halo:'halo-r2'}, 5:{radius:7, weight:2, halo:'halo-r5'}, 8:{radius:8, weight:2, halo:'halo-r8'} };
  const OVERPASS_URL = "https://overpass-api.de/api/interpreter";

  // Map types to OSM tags (covers convenience categories)
  const TYPE_MAP = {
    supermercado: [{key:'shop', val:'supermarket'}],
    padaria: [{key:'shop', val:'bakery'}],
    farmacia: [{key:'amenity', val:'pharmacy'}],
    hospital: [{key:'amenity', val:'hospital'}, {key:'amenity', val:'clinic'}],
    escola: [{key:'amenity', val:'school'}],
    universidade: [{key:'amenity', val:'university'}],
    restaurante: [{key:'amenity', val:'restaurant'}, {key:'amenity', val:'fast_food'}, {key:'amenity', val:'cafe'}],
    academia: [{key:'leisure', val:'fitness_centre'}],
    banco: [{key:'amenity', val:'bank'}, {key:'amenity', val:'atm'}],
    shopping: [{key:'shop', val:'mall'}],
    mercado: [{key:'shop', val:'convenience'}],
    parque: [{key:'leisure', val:'park'}],
    delegacia: [{key:'amenity', val:'police'}],
    correios: [{key:'amenity', val:'post_office'}],
    postoGasolina: [{key:'amenity', val:'fuel'}]
  };

  const COLORS = (window.convenienceColors) || {
    supermercado:'#2ECC71', padaria:'#F39C12', farmacia:'#E74C3C', hospital:'#8E44AD',
    escola:'#3498DB', universidade:'#1ABC9C', restaurante:'#E67E22', academia:'#9B59B6',
    banco:'#34495E', shopping:'#16A085', mercado:'#27AE60', parque:'#2E86C1',
    delegacia:'#7F8C8D', correios:'#C0392B', postoGasolina:'#AF601A'
  };

  function ensureLayer(id){
    if (!window.map || typeof L === 'undefined') return null;
    if (!window[id]) window[id] = L.layerGroup().addTo(map);
    return window[id];
  }
  function clearLayers(){
    [2,5,8].forEach(r => { try{ window[LAYER_ID[r]] && window[LAYER_ID[r]].clearLayers(); }catch(e){} });
  }

  function kmToM(km){ return Math.max(100, Math.floor(Number(km||0)*1000)); }
  function seedHash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0; } return h>>>0; }
  function rng(seed){ let st=seed>>>0; return function(){ st^=st<<13; st>>>=0; st^=st>>17; st>>>=0; st^=st<<5; st>>>=0; return (st>>>0)/4294967296; }; }
  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371e3, toRad = x => x*Math.PI/180;
    const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2), ŒîœÜ = toRad(lat2-lat1), ŒîŒª = toRad(lon2-lon1);
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function tiposAtivos(){
    try{
      if (window.convenienciasSelecionadas) return Object.keys(convenienciasSelecionadas).filter(t => convenienciasSelecionadas[t]);
    }catch(e){}
    const s=new Set(); document.querySelectorAll('tr[data-tipo]').forEach(tr=>s.add(tr.getAttribute('data-tipo')));
    return Array.from(s);
  }

  function detectarIndices(){
    const idx={km2:1,km5:2,km8:3};
    const tables=document.querySelectorAll('table');
    for (let t=0;t<tables.length;t++){
      const ths=tables[t].querySelectorAll('thead th, tr th');
      if(!ths.length) continue;
      const f={km2:null,km5:null,km8:null};
      for (let i=0;i<ths.length;i++){
        const txt=(ths[i].textContent||'').toLowerCase().replace(/\s+/g,' ');
        if (f.km2===null && /(2\s*km|km\s*2)/.test(txt)) f.km2=i;
        if (f.km5===null && /(5\s*km|km\s*5)/.test(txt)) f.km5=i;
        if (f.km8===null && /(8\s*km|km\s*8)/.test(txt)) f.km8=i;
      }
      if (f.km2!=null && f.km5!=null && f.km8!=null) return f;
    }
    return idx;
  }

  function countsFromTable(){
    const idx=detectarIndices();
    const rows=Array.from(document.querySelectorAll('tr[data-tipo]'));
    const out={2:{},5:{},8:{}};
    rows.forEach(tr=>{
      const tipo=tr.getAttribute('data-tipo');
      const tds=Array.from(tr.children||[]);
      const num = pos => {
        const cell = tds[pos]; if(!cell) return 0;
        const badge = cell.querySelector?cell.querySelector('.quantity-badge'):null;
        const txt = badge ? badge.textContent : (cell.textContent||'');
        const n = parseInt(String(txt).replace(/\D+/g,''),10);
        return isNaN(n)?0:n;
      };
      out[2][tipo]=num(idx.km2); out[5][tipo]=num(idx.km5); out[8][tipo]=num(idx.km8);
    });
    return out;
  }
  function countsFromGlobals(){
    try{
      const a=window.data2km||window.data_2km, b=window.data5km||window.data_5km, c=window.data8km||window.data_8km;
      if (!a||!b||!c) return null;
      const out={2:{},5:{},8:{}}; const keys=new Set([...Object.keys(a),...Object.keys(b),...Object.keys(c)]);
      keys.forEach(k=>{ out[2][k]=+a[k]||0; out[5][k]=+b[k]||0; out[8][k]=+c[k]||0; });
      return out;
    }catch(e){ return null; }
  }
  function readCounts(){ return countsFromGlobals() || countsFromTable() || {2:{},5:{},8:{}}; }

  function buildOverpassQuery(lat, lng, radiusM, tipos){
    const parts=[];
    tipos.forEach(t=>{
      (TYPE_MAP[t]||[]).forEach(tag=>{
        parts.push(`node(around:${radiusM},${lat},${lng})[${tag.key}=${JSON.stringify(tag.val)}]`);
        parts.push(`way(around:${radiusM},${lat},${lng})[${tag.key}=${JSON.stringify(tag.val)}]`);
        parts.push(`relation(around:${radiusM},${lat},${lng})[${tag.key}=${JSON.stringify(tag.val)}]`);
      });
    });
    const union=parts.join(';\n');
    return `[out:json][timeout:25];
      ( ${union} );
      out tags center 200;`;
  }

  function guessTipo(tags){
    for (const t of Object.keys(TYPE_MAP)){
      for (const tag of TYPE_MAP[t]){
        if (tags && tags[tag.key] === tag.val) return t;
      }
    }
    return null;
  }

  async function fetchOSM(lat,lng,km,tipos){
    const key = "__cache_osm__" + btoa(JSON.stringify({lat:lat.toFixed(5),lng:lng.toFixed(5),km,tipos:tipos.slice().sort()}));
    try {
      const hit = localStorage.getItem(key);
      if (hit){ const o=JSON.parse(hit); if ((Date.now()-o.ts)/36e5 < 24) return o.data; }
    }catch(e){}
    const query = buildOverpassQuery(lat,lng,kmToM(km),tipos);
    const res = await fetch(OVERPASS_URL, {method:"POST", headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}, body:new URLSearchParams({data:query})});
    const json = await res.json();
    const data = (json.elements||[]).map(el=>{
      let y=null,x=null;
      if (el.type==='node'){ y=el.lat; x=el.lon; } else if (el.center){ y=el.center.lat; x=el.center.lon; }
      const t = guessTipo(el.tags)||'ponto';
      return {lat:y, lng:x, tipo:t, tags:el.tags||{}};
    }).filter(p=>typeof p.lat==='number' && typeof p.lng==='number');
    try { localStorage.setItem(key, JSON.stringify({ts:Date.now(), data})); }catch(e){}
    return data;
  }

  function inRing(lat0,lng0,p,innerKm,outerKm){
    const d = haversine(lat0,lng0,p.lat,p.lng)/1000;
    return d>=(innerKm-1e-6) && d<= (outerKm+1e-6);
  }

  function placeSynthetic(lat0,lng0,ringKm,seed,color,tipo,layer,n){
    const rnd = rng(seed);
    const r = ringKm.outer;
    for (let i=0;i<n;i++){
      // keep strictly within ring
      const base = (i/n)*2*Math.PI, jitter=(rnd()-0.5)*(Math.PI/Math.max(10,n)), ang=base+jitter;
      const distKm = ringKm.inner + (ringKm.outer-ringKm.inner)*(0.2 + 0.75*rnd());
      const distM = distKm*1000;
      const dLat=(distM*Math.cos(ang))/111320;
      const dLng=(distM*Math.sin(ang))/(111320*Math.cos(lat0*Math.PI/180));
      const y=lat0+dLat, x=lng0+dLng;
      const m=L.circleMarker([y,x],{color:'white', fillColor:color, fillOpacity:.9, radius: (r===2?6:(r===5?7:8)), weight:2, className:(r===2?'halo-r2':(r===5?'halo-r5':'halo-r8'))})
        .bindPopup(`<div style="text-align:center"><b>${(typeof getNomeConveniencia==='function'?getNomeConveniencia(tipo):tipo)}</b><br><small>${r} km (estimado)</small></div>`);
      m.addTo(layer); try{ m.bringToFront(); }catch(e){}
    }
  }

  async function renderAnnulus(){
    if (!window.map || !window.enderecoAtual) return;
    const lat0=enderecoAtual.lat, lng0=enderecoAtual.lng;
    const tipos = tiposAtivos();
    const counts = readCounts();

    // prepara camadas limpas
    const layers = {2: ensureLayer(LAYER_ID[2]), 5: ensureLayer(LAYER_ID[5]), 8: ensureLayer(LAYER_ID[8])};
    clearLayers();

    // busca OSM uma vez com o maior raio (8 km) e depois filtramos por anel
    const osmAll = await fetchOSM(lat0,lng0,8,tipos);
    // index por tipo
    const byTipo = {}; osmAll.forEach(p => { (byTipo[p.tipo]=byTipo[p.tipo]||[]).push(p); });

    const rings = {
      2: {inner:0, outer:2, halo:'halo-r2'},
      5: {inner:2, outer:5, halo:'halo-r5'},
      8: {inner:5, outer:8, halo:'halo-r8'}
    };

    [2,5,8].forEach(r => {
      tipos.forEach(tipo => {
        const need = Number((counts[r]||{})[tipo]||0);
        if (need<=0) return;
        const color = COLORS[tipo] || '#2E86C1';
        const pool = (byTipo[tipo]||[]).filter(p => inRing(lat0,lng0,p,rings[r].inner,rings[r].outer));
        // ordenar por proximidade do meio do anel
        const mid = (rings[r].inner + rings[r].outer)/2;
        pool.sort((a,b)=>Math.abs(haversine(lat0,lng0,a.lat,a.lng)/1000 - mid) - Math.abs(haversine(lat0,lng0,b.lat,b.lng)/1000 - mid));

        const real = pool.slice(0, need);
        real.forEach(p => {
          const m = L.circleMarker([p.lat,p.lng], {color:'white', fillColor:color, fillOpacity:.95, radius:(r===2?6:(r===5?7:8)), weight:2, className:rings[r].halo})
            .bindPopup(`<div style="text-align:center"><b>${(typeof getNomeConveniencia==='function'?getNomeConveniencia(tipo):tipo)}</b><br><small>${r} km</small></div>`);
          m.addTo(layers[r]); try{ m.bringToFront(); }catch(e){}
        });

        const missing = Math.max(0, need - real.length);
        if (missing>0){
          placeSynthetic(lat0,lng0,rings[r], seedHash(tipo+'|'+r), color, tipo, layers[r], missing);
        }
      });
    });
  }

  // Redesenhar em intera√ß√µes t√≠picas do app
  const obs = new MutationObserver(()=>renderAnnulus());
  try { obs.observe(document.body, {childList:true, subtree:true}); } catch(e){}
  ['setRadius','updateSummaryData','gerarPontosConveniencia','atualizarVisibilidadePontosPorRaio','destacarPontosNoMapa'].forEach(fn=>{
    const org = window[fn];
    window[fn] = function(){
      try{ if (org) org.apply(this, arguments); }catch(e){}
      renderAnnulus();
    };
  });

  // First render
  renderAnnulus();
})();
</script>

<script>
(function(){
  const RADII = [2000, 5000, 8000];
  function injectCountingPatchInsideEstudo(){
    try{
      const ifr = document.getElementById('iEstudo');
      const doc = ifr?.contentDocument || ifr?.contentWindow?.document;
      const win = ifr?.contentWindow;
      if(!doc || !win) return;
      if(win.__poiCountPatchInstalled) return;
      win.__poiCountPatchInstalled = true;

      win.__POI_STATE = {
        mainLatLng: null,
        markers: [],
        activeRadius: 2000,
        categoryEnabled: null
      };

      function dist(a, b){
        try { return win.map.distance(a, b); }
        catch(_) { return a && b ? a.distanceTo(b) : Infinity; }
      }

      const catBoxes = doc.querySelectorAll('input[type="checkbox"][data-category]');
      if(catBoxes.length){
        win.__POI_STATE.categoryEnabled = (cat) => {
          const el = doc.querySelector(`input[type="checkbox"][data-category="${cat}"]`);
          return el ? !!el.checked : true;
        };
        catBoxes.forEach(cb => cb.addEventListener('change', recountAndRender));
      } else {
        win.__POI_STATE.categoryEnabled = () => true;
      }

      function setActiveRadius(m){
        win.__POI_STATE.activeRadius = m;
        const disp = doc.getElementById('raio-ativo-display');
        if(disp) disp.textContent = (m/1000)+'km';
        recountAndRender();
      }
      doc.querySelectorAll('[data-radius]').forEach(btn=>{
        btn.addEventListener('click', ()=> setActiveRadius(parseInt(btn.getAttribute('data-radius'),10)));
      });

      if(win.map){
        win.map.on('moveend zoomend', recountAndRender);
      }

      const origBuscar = win.buscarEnderecoPrincipal;
      win.buscarEnderecoPrincipal = async function(...args){
        const result = await (origBuscar ? origBuscar.apply(this, args) : undefined);
        try{
          const m = win._mainMarker || null;
          win.__POI_STATE.mainLatLng = m ? m.getLatLng() : (win.__ULTIMO_PRINCIPAL_LATLNG || null);
          if(!win.__POI_STATE.mainLatLng && win.map){
            win.__POI_STATE.mainLatLng = win.map.getCenter();
          }
        }catch(_){}
        recountAndRender();
        return result;
      };

      const origCriarPOI = win.criarPontoInteresse;
      win.criarPontoInteresse = function(lat, lng, categoria = '', subtitulo = '', fonte='user'){
        const ret = origCriarPOI ? origCriarPOI.apply(this, arguments) : undefined;
        try{
          let marker = ret && ret.addTo ? ret : null;
          if(!marker && win.map && win.map._layers){
            const layers = Object.values(win.map._layers);
            marker = layers[layers.length-1] || null;
          }
          if(marker && marker.getLatLng){
            win.__POI_STATE.markers.push({
              marker,
              latlng: marker.getLatLng(),
              category: (categoria || '').toString().trim().toLowerCase(),
              source: fonte
            });
          }
        }catch(_){}
        recountAndRender();
        return ret;
      };

      (function bootstrapScan(){
        try{
          if(!win.map) return;
          const already = new Set(win.__POI_STATE.markers.map(m=>m.marker._leaflet_id));
          Object.values(win.map._layers || {}).forEach(layer=>{
            if(layer && layer.getLatLng && !already.has(layer._leaflet_id)){
              win.__POI_STATE.markers.push({
                marker: layer,
                latlng: layer.getLatLng(),
                category: (layer.options?.className || '').toString().toLowerCase(),
                source: 'bootstrap'
              });
            }
          });
        }catch(_){}
      })();

      function recount(){
        const S = win.__POI_STATE;
        const res = { byRadius: {2000:0, 5000:0, 8000:0}, byCategory: {} };
        if(!S.mainLatLng) return res;
        RADII.forEach(R=>{
          res.byRadius[R] = S.markers.reduce((acc, p)=>{
            if(!S.categoryEnabled(p.category)) return acc;
            return acc + (dist(S.mainLatLng, p.latlng) <= R ? 1 : 0);
          }, 0);
        });
        S.markers.forEach(p=>{
          if(!S.categoryEnabled(p.category)) return;
          if(dist(S.mainLatLng, p.latlng) <= S.activeRadius){
            res.byCategory[p.category] = (res.byCategory[p.category]||0)+1;
          }
        });
        return res;
      }

      function render(res){
        res = res || recount();
        const totalEl = doc.getElementById('contador-pontos');
        if(totalEl) totalEl.textContent = String(res.byRadius[win.__POI_STATE.activeRadius] || 0);
        doc.querySelectorAll('[data-badge]').forEach(b=>{
          const key = b.getAttribute('data-badge');
          const r = key === '2km' ? 2000 : key === '5km' ? 5000 : key === '8km' ? 8000 : null;
          if(r && res.byRadius[r] != null){ b.textContent = String(res.byRadius[r]); }
        });
        Object.entries(res.byCategory).forEach(([cat, val])=>{
          doc.querySelectorAll(`[data-category="${cat}"]`).forEach(td=> { td.textContent = String(val); });
        });
        doc.querySelectorAll('[data-category]').forEach(td=>{
          const cat = td.getAttribute('data-category');
          if(!(cat in res.byCategory)){ td.textContent = '0'; }
        });
      }

      function recountAndRender(){ render(recount()); }
      win.__recountPOIs = recountAndRender;
      win.__setActiveRadius = setActiveRadius;

      const disp = doc.getElementById('raio-ativo-display');
      if(disp){
        const txt = (disp.textContent||'').toLowerCase().replace('km','').trim();
        const km = parseFloat(txt);
        if([2,5,8].includes(km)) setActiveRadius(km*1000);
      } else {
        recountAndRender();
      }
    }catch(e){ console.warn('Patch contador de POIs falhou:', e); }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const ifr = document.getElementById('iEstudo');
    if(!ifr) return;
    ifr.addEventListener('load', ()=>{
      setTimeout(injectCountingPatchInsideEstudo, 250);
    });
  });
})();
</script>

<style>
/* Estilo sutil para marcar a pertin√™ncia por raio (sem esconder nada) */
.leaflet-marker-icon.poi-outside { opacity: 0.45; filter: grayscale(35%); }
.leaflet-marker-icon.poi-inside { opacity: 1; filter: none; }
.leaflet-interactive.ring-2km { stroke: #4CAF50; fill: rgba(76,175,80,0.05); }
.leaflet-interactive.ring-5km { stroke: #FFC107; fill: rgba(255,193,7,0.04); }
.leaflet-interactive.ring-8km { stroke: #2196F3; fill: rgba(33,150,243,0.03); }
</style>
<script>
(function(){
  function installRingsAndVisibility(){
    try{
      const ifr = document.getElementById('iEstudo');
      const doc = ifr?.contentDocument || ifr?.contentWindow?.document;
      const win = ifr?.contentWindow;
      if(!doc || !win || !win.map || !win.__POI_STATE) return;
      if(win.__ringsPatchInstalled) return;
      win.__ringsPatchInstalled = true;

      // Cria LayerGroup para os an√©is
      const L = win.L;
      const RADII = [2000, 5000, 8000];
      const ringClasses = {2000:'ring-2km', 5000:'ring-5km', 8000:'ring-8km'};
      const rings = L.layerGroup().addTo(win.map);
      win.__POI_STATE.__ringsLayer = rings;

      function drawRings(){
        rings.clearLayers();
        const center = win.__POI_STATE.mainLatLng || (win.map ? win.map.getCenter() : null);
        if(!center) return;
        RADII.forEach(r=>{
          const c = L.circle(center, {radius: r, className: ringClasses[r], weight: 2, fillOpacity: 0.08});
          rings.addLayer(c);
        });
      }

      function ensureAllVisibleAndStyled(){
        const S = win.__POI_STATE;
        if(!S || !S.markers) return;
        const center = S.mainLatLng || (win.map ? win.map.getCenter() : null);
        const activeR = S.activeRadius || 2000;
        S.markers.forEach(obj=>{
          const m = obj.marker;
          if(!m || !m.addTo) return;
          // Garante que o marcador est√° adicionado ao mapa
          try{ if(!win.map.hasLayer(m)) m.addTo(win.map); }catch(_){}
          // Aplica estilo (dentro/fora) SEM esconder
          try{
            if(center && m.getLatLng){
              const d = center.distanceTo(m.getLatLng());
              const inside = d <= activeR;
              const el = m._icon || null;
              if(el){
                el.classList.remove('poi-inside','poi-outside');
                el.classList.add(inside ? 'poi-inside' : 'poi-outside');
              }
            }
          }catch(_){}
        });
      }

      // Hook nas fun√ß√µes j√° expostas pelo primeiro patch
      const origRecount = win.__recountPOIs || function(){};
      win.__recountPOIs = function(){
        try{
          drawRings();
          ensureAllVisibleAndStyled();
        }catch(_){}
        return origRecount();
      };

      const origSetRadius = win.__setActiveRadius || function(){};
      win.__setActiveRadius = function(r){
        const ret = origSetRadius(r);
        try{
          drawRings();
          ensureAllVisibleAndStyled();
        }catch(_){}
        return ret;
      };

      // Reagir a pan/zoom (mantendo todos vis√≠veis)
      if(win.map){
        win.map.on('moveend zoomend', ()=>{
          try{
            drawRings();
            ensureAllVisibleAndStyled();
            if(typeof win.__recountPOIs === 'function') win.__recountPOIs();
          }catch(_){}
        });
      }

      // Primeira execu√ß√£o
      setTimeout(()=>{
        drawRings();
        ensureAllVisibleAndStyled();
        if(typeof win.__recountPOIs === 'function') win.__recountPOIs();
      }, 200);
    }catch(e){
      console.warn('Rings/visibility patch failed:', e);
    }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const ifr = document.getElementById('iEstudo');
    if(!ifr) return;
    ifr.addEventListener('load', ()=>{
      setTimeout(installRingsAndVisibility, 350);
    });
  });
})();
</script>

<script>
(function(){
  // Patch: varredura profunda (MarkerCluster, LayerGroup, GeoJSON, CircleMarker) e fit bounds opcional
  function installDeepScan(){
    try{
      const ifr = document.getElementById('iEstudo');
      const doc = ifr?.contentDocument || ifr?.contentWindow?.document;
      const win = ifr?.contentWindow;
      if(!doc || !win || !win.map || !win.__POI_STATE) return;
      if(win.__deepScanInstalled) return;
      win.__deepScanInstalled = true;
      const L = win.L;

      // Utilit√°rio: extrai LatLng de diversos tipos
      function getLatLngFromLayer(layer){
        try{
          if(layer.getLatLng) return layer.getLatLng();
          if(layer.getBounds && layer.getBounds().getCenter) return layer.getBounds().getCenter();
          // GeoJSON Feature
          if(layer.feature && layer.feature.geometry){
            const g = layer.feature.geometry;
            if(g.type === 'Point' && Array.isArray(g.coordinates) && g.coordinates.length >= 2){
              return L.latLng(g.coordinates[1], g.coordinates[0]);
            }
          }
        }catch(_){}
        return null;
      }

      function guessCategory(layer){
        // tenta inferir categoria a partir de options/title/className/popup content
        try{
          if(layer.options && typeof layer.options.className === 'string') return layer.options.className.toLowerCase();
          if(layer.options && typeof layer.options.title === 'string') return layer.options.title.toLowerCase();
          if(layer.getTooltip && layer.getTooltip()){ return (layer.getTooltip().getContent()||'').toString().trim().toLowerCase(); }
          if(layer.getPopup && layer.getPopup()){ return (layer.getPopup().getContent()||'').toString().trim().toLowerCase(); }
        }catch(_){}
        return '';
      }

      function collectDeepMarkers(){
        const markers = [];
        const seen = new Set();

        function visit(layer){
          if(!layer) return;
          // Se for um grupo (LayerGroup/MarkerClusterGroup/FeatureGroup/GeoJSON)
          if(layer.eachLayer){
            try{ layer.eachLayer(visit); }catch(_){}
          }
          // Tenta extrair LatLng deste layer
          const ll = getLatLngFromLayer(layer);
          if(ll){
            const id = (layer._leaflet_id != null ? layer._leaflet_id : (ll.lat+','+ll.lng));
            if(!seen.has(id)){
              seen.add(id);
              markers.push({
                marker: layer,
                latlng: ll,
                category: guessCategory(layer),
                source: 'deep-scan'
              });
            }
          }
        }

        try{
          win.map.eachLayer(visit);
        }catch(_){}
        return markers;
      }

      // Substitui o bootstrapScan do patch anterior por uma varredura profunda
      function resyncMarkersFromDeepScan(){
        const S = win.__POI_STATE;
        if(!S) return;
        const currentIds = new Set(S.markers.map(m => m.marker && m.marker._leaflet_id));
        const deep = collectDeepMarkers();
        deep.forEach(obj=>{
          const id = obj.marker && obj.marker._leaflet_id;
          if(id == null || currentIds.has(id)) return;
          S.markers.push(obj);
        });
      }

      // Exponha e integre nos fluxos existentes
      win.__resyncPOIsDeep = function(){
        try{
          resyncMarkersFromDeepScan();
          if(typeof win.__recountPOIs === 'function') win.__recountPOIs();
        }catch(_){}
      };

      // Re-sincroniza em eventos comuns
      if(win.map){
        win.map.on('layeradd', ()=> win.__resyncPOIsDeep());
        win.map.on('moveend zoomend', ()=> win.__resyncPOIsDeep());
      }

      // Ap√≥s uploads, tente re-sincronizar (escuta muta√ß√µes no doc do iframe)
      const mo = new MutationObserver(()=> win.__resyncPOIsDeep());
      mo.observe(doc.documentElement, {subtree:true, childList:true});

      // Bot√£o opcional para enquadrar todos os pontos (cria s√≥ se existir um container de toolbar)
      const toolbar = doc.querySelector('#map-toolbar, .map-toolbar, .leaflet-top.leaflet-left') || null;
      if(toolbar && !doc.getElementById('btn-fit-all-pois')){
        const btn = doc.createElement('button');
        btn.id='btn-fit-all-pois';
        btn.textContent='Enquadrar Todos os Pontos';
        btn.style.cssText='margin:6px;padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;';
        btn.addEventListener('click', ()=>{
          try{
            const S = win.__POI_STATE;
            if(!S || !S.markers.length) return;
            const latlngs = S.markers.map(m=>m.latlng).filter(Boolean);
            const bounds = L.latLngBounds(latlngs);
            win.map.fitBounds(bounds.pad(0.15));
          }catch(_){}
        });
        // Insere dentro do canto superior-esquerdo da UI do Leaflet, se existir
        const ctrl = doc.querySelector('.leaflet-top.leaflet-left');
        (ctrl || toolbar).appendChild(btn);
      }

      // Primeira sincroniza√ß√£o profunda
      setTimeout(()=> win.__resyncPOIsDeep(), 400);
    }catch(e){
      console.warn('Deep scan patch failed:', e);
    }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const ifr = document.getElementById('iEstudo');
    if(!ifr) return;
    ifr.addEventListener('load', ()=>{
      setTimeout(installDeepScan, 500);
    });
  });
})();
</script>

<script>
(function(){
  function installRawOverlay(){
    try{
      const ifr = document.getElementById('iEstudo');
      const doc = ifr?.contentDocument || ifr?.contentWindow?.document;
      const win = ifr?.contentWindow;
      if(!doc || !win || !win.map || !win.__POI_STATE) return;
      if(win.__rawOverlayInstalled) return;
      win.__rawOverlayInstalled = true;

      const L = win.L;
      const overlay = L.layerGroup().addTo(win.map);
      overlay._visible = true;
      win.__POI_STATE.__rawOverlay = overlay;

      function draw(){
        overlay.clearLayers();
        const S = win.__POI_STATE;
        if(!S || !S.markers) return;
        S.markers.forEach(o=>{
          if(!o.latlng) return;
          const cm = L.circleMarker(o.latlng, {radius: 4, weight: 1, fillOpacity: 0.9, opacity: 0.9});
          overlay.addLayer(cm);
        });
      }

      // Bot√£o para alternar
      const ctrl = doc.querySelector('.leaflet-top.leaflet-left') || doc.body;
      if(!doc.getElementById('btn-toggle-raw-overlay')){
        const btn = doc.createElement('button');
        btn.id = 'btn-toggle-raw-overlay';
        btn.textContent = 'Mostrar/Ocultar Pontos Brutos';
        btn.style.cssText='margin:6px;padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;';
        btn.addEventListener('click', ()=>{
          if(overlay._visible){
            win.map.removeLayer(overlay); overlay._visible=false;
          } else {
            overlay.addTo(win.map); overlay._visible=true; draw();
          }
        });
        ctrl.appendChild(btn);
      }

      // Redesenha quando houver resync
      const hook = win.__resyncPOIsDeep;
      win.__resyncPOIsDeep = function(){
        if(typeof hook === 'function') hook();
        draw();
      };

      // Primeira passada
      setTimeout(draw, 300);
    }catch(e){
      console.warn('Raw overlay install failed:', e);
    }
  }
  window.addEventListener('DOMContentLoaded', ()=>{
    const ifr = document.getElementById('iEstudo');
    if(!ifr) return;
    ifr.addEventListener('load', ()=> setTimeout(installRawOverlay, 600));
  });
})();
</script>
</body>
</html>
'&gt;
<!-- ====== EXPORTA√á√ÉO TOTAL (TODAS AS ABAS) ‚Äî CORRIGIDO (cores/opacidade) ====== -->
<style>
  #export-toolbar-tabs{
    position: fixed; right: 16px; bottom: 16px; z-index: 2147483647;
    display: flex; gap: 10px; flex-wrap: wrap;
  }
  #export-toolbar-tabs .export-btn{
    background: linear-gradient(90deg, #00512A, #007C27);
    color: #fff; border: 0; border-radius: 12px; padding: 10px 14px;
    font-weight: 700; box-shadow: 0 6px 18px rgba(0,0,0,.15);
    cursor: pointer;
  }
  #export-toolbar-tabs .export-btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
  @media print { #export-toolbar-tabs{ display:none !important; } }
</style>
<div aria-label="Exportar" id="export-toolbar-tabs">
<button class="export-btn" id="btn-save-pdf-tabs" title="Salvar PDF com TODAS as abas (inclusive escondidas)">üíæ Salvar PDF (todas as abas)</button>
<button class="export-btn" id="btn-save-html-tabs" title="Salvar HTML atual">üíæ Salvar HTML</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(function(){
  const { jsPDF } = window.jspdf || {};
  function pxPerMm(){ return 96/25.4; }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function injectForceStyle(doc){
    // For√ßa fidelidade de cores, remove opacidades/filtros/blend
    const css = `
      /* for√ßa cores reais */
      :root, * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      .__exporting, .__exporting * {
        opacity: 1 !important;
        filter: none !important;
        mix-blend-mode: normal !important;
        backdrop-filter: none !important;
      }
      /* Leaflet: desativa fade/transi√ß√£o e for√ßa tiles 100% */
      .__exporting .leaflet-tile,
      .__exporting .leaflet-overlay-pane,
      .__exporting .leaflet-marker-icon,
      .__exporting .leaflet-zoom-animated,
      .__exporting .leaflet-pane {
        opacity: 1 !important;
        filter: none !important;
        transition: none !important;
        animation: none !important;
      }
    `;
    let style = doc.getElementById('__export_force_style');
    if(!style){
      style = doc.createElement('style');
      style.id = '__export_force_style';
      style.type = 'text/css';
      style.appendChild(doc.createTextNode(css));
      doc.head.appendChild(style);
    }
    doc.documentElement.classList.add('__exporting');
    return ()=>{
      doc.documentElement.classList.remove('__exporting');
      // n√£o remove o style para reutilizar em capturas subsequentes
    };
  }

  function saveHTML(){
    try{
      const html = '<!DOCTYPE html>' + document.documentElement.outerHTML;
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'Estudo_Mercadologico.html';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1200);
    }catch(e){ alert('Falha ao salvar HTML: '+ e.message); }
  }

  async function rasterizeMapsOnce(root){
    const sels = ['#map', '.leaflet-container', '[data-map]', '[id*="map"]'];
    const t = [];
    sels.forEach(sel => root.querySelectorAll(sel).forEach(el => { if(!el.getAttribute('data-pdf-rasterized')) t.push(el); }));
    if(!t.length) return () => {};
    const states = [];
    for(const el of t){
      try{
        const canvas = await html2canvas(el, {useCORS:true, scale: 2, backgroundColor: null});
        const dataUrl = canvas.toDataURL('image/png');
        const img = root.createElement('img');
        img.src = dataUrl; img.alt = 'Mapa (rasterizado para PDF)';
        img.style.width = el.offsetWidth + 'px';
        img.style.height= el.offsetHeight + 'px';
        try{ img.style.borderRadius = (getComputedStyle(el).borderRadius || '0'); }catch(_){}
        el.parentNode.insertBefore(img, el);
        states.push({el, img});
        el.style.display = 'none';
        el.setAttribute('data-pdf-rasterized','1');
      }catch(e){ /* ignora */ }
    }
    return function restore(){
      states.forEach(({el, img}) => {
        if(img && img.parentNode) img.parentNode.removeChild(img);
        el.style.display=''; el.removeAttribute('data-pdf-rasterized');
      });
    };
  }

  async function elementToPDFPages(pdf, el, opts){
    const marginMm = 5;
    const pageWmm = (opts && opts.pageWmm) || 210;
    const pageHmm = (opts && opts.pageHmm) || 297;
    const pxmm = pxPerMm();
    const contentWpx = (pageWmm - marginMm*2) * pxmm;
    const contentHpx = (pageHmm - marginMm*2) * pxmm;

    const canvas = await html2canvas(el, {
      useCORS:true, scale: 2, backgroundColor: '#ffffff',
      windowWidth:  Math.max(el.scrollWidth || 0,  document.documentElement.scrollWidth || 0),
      windowHeight: Math.max(el.scrollHeight || 0, document.documentElement.scrollHeight || 0)
    });
    const cw = canvas.width, ch = canvas.height;
    const sliceH = Math.max(1, Math.floor((contentHpx / contentWpx) * cw));

    let y = 0, first = true;
    while (y < ch){
      const h = Math.min(sliceH, ch - y);
      const slice = document.createElement('canvas');
      slice.width = cw; slice.height = h;
      const ctx = slice.getContext('2d');
      ctx.drawImage(canvas, 0, y, cw, h, 0, 0, cw, h);
      const imgData = slice.toDataURL('image/jpeg', 0.98);
      if(!first) pdf.addPage();
      first = false;
      const imgWmm = pageWmm - marginMm*2;
      const imgHmm = (h / cw) * imgWmm;
      pdf.addImage(imgData, 'JPEG', marginMm, marginMm, imgWmm, imgHmm);
      y += h;
    }
  }

  function detectTabButtons(){
    const candidates = new Set();
    const selectors = [
      '[role="tab"]',
      '.tab', '.tabs button', '.tab-btn', '.nav-tabs .nav-link', '.nav .nav-link', '.tablinks', '.tab-link',
      '[data-tab]', '[data-target]', '[data-toggle="tab"]', '[aria-controls]',
      'button[onclick*="showTab"]', 'a[onclick*="showTab"]',
      '.aba', '.abas button'
    ];
    selectors.forEach(s => document.querySelectorAll(s).forEach(el => {
      const cs = getComputedStyle(el);
      if (cs.display === 'none' || cs.visibility === 'hidden') return;
      if (['A','BUTTON','DIV','LI','SPAN'].includes(el.tagName)) candidates.add(el);
    }));
    const arr = Array.from(candidates);
    const uniq = [];
    const seen = new Set();
    for(const el of arr){
      const key = (el.getAttribute('aria-controls')||'') + '|' + (el.dataset.tab||'') + '|' + (el.textContent||'').trim();
      if(!seen.has(key)){ seen.add(key); uniq.push(el); }
    }
    return uniq;
  }

  async function captureAllIframes(pdf){
    const iframes = Array.from(document.querySelectorAll('iframe'));
    for(const fr of iframes){
      try{
        const doc = fr.contentDocument || (fr.contentWindow && fr.contentWindow.document);
        if(!doc || !doc.body) continue;
        const remove = injectForceStyle(doc);
        const restore = await rasterizeMapsOnce(doc);
        await elementToPDFPages(pdf, doc.body, {});
        restore && restore();
        remove && remove();
      }catch(e){ console.warn('Erro ao capturar iframe para o PDF:', e); }
    }
  }

  async function savePDFAllTabs(){
    try{
      if(!jsPDF){ alert('Biblioteca jsPDF n√£o carregada.'); return; }
      const pdf = new jsPDF({unit:'mm', format:'a4', orientation:'portrait'});

      // 1) P√°gina vis√≠vel com cores for√ßadas
      const removeForce = injectForceStyle(document);
      let restoreMain = await rasterizeMapsOnce(document);
      await elementToPDFPages(pdf, document.body, {});
      restoreMain && restoreMain();
      removeForce && removeForce();

      // 2) iframes neste estado
      await captureAllIframes(pdf);

      // 3) Clicar/percorrer abas (se existirem) e capturar cada estado
      const tabs = detectTabButtons();
      const originalActive = document.activeElement;

      async function captureCurrentState(){
        window.scrollTo(0,0);
        const removeForce = injectForceStyle(document);
        let restore = await rasterizeMapsOnce(document);
        await elementToPDFPages(pdf, document.body, {});
        restore && restore();
        removeForce && removeForce();
        await captureAllIframes(pdf);
      }

      for(let i=0; i<tabs.length; i++){
        try{
          const btn = tabs[i];
          if(btn.getAttribute('aria-selected') === 'true') continue;
          btn.click();
          await sleep(500);
          await captureCurrentState();
        }catch(e){ console.warn('Falha ao capturar uma aba:', e); }
      }

      if(originalActive && originalActive.focus) originalActive.focus();
      pdf.save('Estudo_Mercadologico_todas_as_abas.pdf');
    }catch(e){
      alert('Falha ao gerar o PDF: ' + e.message);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const bPDF  = document.getElementById('btn-save-pdf-tabs');
    const bHTML = document.getElementById('btn-save-html-tabs');
    if(bPDF)  bPDF.addEventListener('click', savePDFAllTabs);
    if(bHTML) bHTML.addEventListener('click', saveHTML);
  });
})();
</script>
